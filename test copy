<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Search & Card</title>

<style>
body { font-family: Arial; margin:0; padding:15px; background:#f1f1f1; }
h2 { text-align:center; margin-bottom:15px; }

.search-box {
    width:100%; padding:12px; font-size:18px;
    border:2px solid #444; border-radius:6px; margin-bottom:10px;
}

.popup {
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center;
}

.popup-box {
    background:white; padding:20px; width:90%;
    max-width:450px; border-radius:10px;
    box-shadow:0 0 10px black;
    position:relative;
}

.close-btn {
    background:red; color:white; padding:8px 14px;
    border:0; border-radius:6px; float:right;
    cursor:pointer;
}

.btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; margin-right:10px; color:white; }
.btn-print { background:#007bff; }
.btn-send { background:#25d366; }

#senderMsg { width:100%; height:80px; margin-top:10px; padding:8px; border-radius:6px; border:2px solid #aaa; }
</style>
</head>
<body>

<h2>üîç Voter Search</h2>
<input type="text" id="searchInput" class="search-box" placeholder="Search by Name / EPIC / Address">

<!-- POPUP CARD -->
<div id="popup" class="popup">
    <div class="popup-box">
        <button class="close-btn" onclick="closePopup()">Close</button>
        <div id="popupContent"></div>
        <p><b>Your Message:</b></p>
        <textarea id="senderMsg" placeholder="Type your message here..."></textarea><br>
        <button class="btn btn-send" onclick="sendMessage()">Send</button>
        <button class="btn btn-print" onclick="printCard()">Print</button>
    </div>
</div>

<script>
/* ------------ FIREBASE DATA LOAD ------------- */
const firebaseURL = "https://voter-25c94-default-rtdb.firebaseio.com/voters.json";

let voters = [];
let activeVoter = null;

fetch(firebaseURL)
.then(res => res.json())
.then(data => {
    if(!data) return;
    voters = Object.keys(data).map(key => ({
        key: key,
        epic_no: data[key].EPIC_NO || key,
        voter_full_name: data[key].VoterName || "",
        sl_no_in_part: data[key].PartNo || "",
        serial_no: data[key].SerialNo || "",
        address: (data[key].HouseNo === "NA" ? "" : data[key].HouseNo) || data[key].Address || "",
        relation_name: data[key].RelationName || "",
        relation_type: data[key].RelationType || "",
        age: data[key].Age || "",
        gender: data[key].Gender || ""
    }));
});

/* ------------ SEARCH ------------- */
document.getElementById("searchInput").addEventListener("keyup", () => {
    const q = document.getElementById("searchInput").value.toLowerCase();
    if(q.length < 1) return; // ‡§ñ‡§æ‡§≤‡•Ä search box ‡§™‡§∞ popup ‡§® ‡§ñ‡•Å‡§≤‡•á

    const voter = voters.find(v =>
        (v.voter_full_name || "").toLowerCase().includes(q) ||
        (v.epic_no || "").toLowerCase().includes(q) ||
        (v.address || "").toLowerCase().includes(q) ||
        (v.age || "").toLowerCase().includes(q) ||
        (v.gender || "").toLowerCase().includes(q)
    );

    if(voter) openPopup(voter);
});

/* ------------ POPUP ------------- */
function openPopup(v) {
    activeVoter = v;
    document.getElementById("popupContent").innerHTML = `
        <h3>${v.voter_full_name}</h3>
        <b>EPIC:</b> ${v.epic_no}<br>
        <b>Part/Serial:</b> ${v.sl_no_in_part}<br><br>
        <b>Address:</b><br>${v.address || "‚Äî"}<br><br>
        <b>Relation:</b> ${v.relation_type} : ${v.relation_name}<br><br>
        <b>Age/Gender:</b> ${v.age} / ${v.gender}<br>
    `;
    document.getElementById("senderMsg").value = ""; // message clear
    document.getElementById("popup").style.display = "flex";
}

function closePopup() {
    document.getElementById("popup").style.display = "none";
    activeVoter = null;
}

/* ------------ SEND MESSAGE ------------- */
function sendMessage() {
    const msg = document.getElementById("senderMsg").value.trim();
    if(!activeVoter) return alert("No voter selected!");
    if(!msg) return alert("Type a message first!");

    // For demo: alert instead of actual sending
    alert(`Message to ${activeVoter.voter_full_name}:\n\n${msg}`);

    // Firebase / WhatsApp integration can be added here
}

/* ------------ PRINT CARD ------------- */
function printCard() {
    if(!activeVoter) return;
    const content = `
        <h2>${activeVoter.voter_full_name}</h2>
        <b>EPIC:</b> ${activeVoter.epic_no}<br>
        <b>Part/Serial:</b> ${activeVoter.sl_no_in_part}<br>
        <b>Address:</b><br>${activeVoter.address || "‚Äî"}<br>
        <b>Relation:</b> ${activeVoter.relation_type} : ${activeVoter.relation_name}<br>
        <b>Age/Gender:</b> ${activeVoter.age} / ${activeVoter.gender}<br><br>
        <b>Sender Message:</b><br>${document.getElementById("senderMsg").value || "‚Äî"}
    `;
    const win = window.open("", "Print", "height=600,width=400");
    win.document.write(content);
    win.document.close();
    win.print();
}
</script>

</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
h1 { text-align: center; }
#controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
#search { padding: 8px; flex: 1; min-width: 200px; }
button { padding: 8px 12px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #007BFF; color: #fff; cursor: pointer; }
tr:nth-child(even) { background: #f9f9f9; }
mark { background: yellow; }
#pagination { margin-top: 10px; }
#pagination button { padding: 5px 10px; margin-right: 5px; }
</style>
</head>
<body>

<h1>Voter List</h1>
<div id="controls">
  <input type="text" id="search" placeholder="Search by Name, EPIC, etc...">
  <button id="printBtn">Print</button>
  <button id="whatsappBtn">Send via WhatsApp</button>
</div>

<table id="voterTable">
  <thead></thead>
  <tbody></tbody>
</table>
<div id="pagination"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8hv0c8CPDBHksZbD4igmVelXV_tEp01HiYVnDvbx3D8VbqzCJtQvF2Fl7HeO92ysrjuCqIR8VQpJc/pub?output=csv";

let allData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 100;

fetch(csvUrl)
  .then(res => res.text())
  .then(csvText => {
    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    allData = results.data.map(row => {
      // trim all fields
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim()] = row[k].trim());
      return obj;
    });
    filteredData = [...allData];
    renderTable();
    renderPagination();
  })
  .catch(err => console.error("Error loading CSV:", err));

function renderTable() {
  const table = document.getElementById('voterTable');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';

  if(filteredData.length === 0) return;

  // Header
  const headers = Object.keys(filteredData[0]);
  let headerRow = "<tr>";
  headers.forEach(h => headerRow += `<th onclick="sortTable('${h}')">${h}</th>`);
  headerRow += "</tr>";
  thead.innerHTML = headerRow;

  // Rows for current page
  const start = (currentPage-1)*rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  pageData.forEach(row => {
    let rowHtml = "<tr>";
    headers.forEach(h => rowHtml += `<td>${row[h]}</td>`);
    rowHtml += "</tr>";
    tbody.innerHTML += rowHtml;
  });
}

// Search
document.getElementById('search').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  filteredData = allData.filter(row =>
    Object.values(row).some(val => val.toLowerCase().includes(filter))
  );
  currentPage = 1;
  renderTable();
  renderPagination();
});

// Sorting
let sortDirection = {};
function sortTable(column) {
  sortDirection[column] = !sortDirection[column];
  filteredData.sort((a,b) => {
    if(a[column] < b[column]) return sortDirection[column] ? -1 : 1;
    if(a[column] > b[column]) return sortDirection[column] ? 1 : -1;
    return 0;
  });
  renderTable();
}

// Print filtered rows
document.getElementById('printBtn').addEventListener('click', function() {
  const tableHtml = `<table border="1" style="border-collapse:collapse; width:100%"><thead>${document.querySelector('#voterTable thead').innerHTML}</thead><tbody>`;
  filteredData.forEach(row => {
    tableHtml += "<tr>" + Object.values(row).map(v => `<td>${v}</td>`).join('') + "</tr>";
  });
  const finalHtml = tableHtml + "</tbody></table>";
  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Voter List</title></head><body>');
  printWindow.document.write(finalHtml);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
});

// WhatsApp filtered
document.getElementById('whatsappBtn').addEventListener('click', function() {
  let text = "Voter List:\n\n";
  filteredData.forEach(row => {
    text += Object.values(row).join(" | ") + "\n";
  });
  const url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
});

// Pagination
function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  const container = document.getElementById('pagination');
  container.innerHTML = '';
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.style.fontWeight = 'bold';
    btn.addEventListener('click', () => { currentPage = i; renderTable(); });
    container.appendChild(btn);
  }
}
</script>

</body>
</html>
