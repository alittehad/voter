<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
h1 { text-align: center; }
#controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
#senderName, #search { padding: 8px; flex: 1; min-width: 200px; }
button { padding: 8px 12px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #007BFF; color: #fff; }
tr:nth-child(even) { background: #f9f9f9; }
.highlight { background-color: yellow; }
.sender-img-print { width: 60px; height: 60px; border-radius: 50%; vertical-align: middle; margin-right: 10px; object-fit: cover; }
</style>
</head>
<body>

<h1>Voter List</h1>
<div id="controls">
  <input type="text" id="senderName" placeholder="Enter your name / description">
  <input type="file" id="senderImgFile" accept="image/*">
  <input type="text" id="search" placeholder="Search by Name, EPIC, etc...">
  <button id="printBtn">Print</button>
  <button id="whatsappBtn">Send via WhatsApp</button>
</div>

<table id="voterTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8hv0c8CPDBHksZbD4igmVelXV_tEp01HiYVnDvbx3D8VbqzCJtQvF2Fl7HeO92ysrjuCqIR8VQpJc/pub?output=csv";

let allData = [];
let filteredData = [];
let senderImgDataUrl = "";

fetch(csvUrl)
  .then(res => res.text())
  .then(csvText => {
    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    allData = results.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim()] = row[k].trim());
      return obj;
    });
    filteredData = [...allData];
    renderTable();
  })
  .catch(err => console.error("Error loading CSV:", err));

function renderTable(searchText="") {
  const table = document.getElementById('voterTable');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';

  if(filteredData.length === 0) return;

  const headers = Object.keys(filteredData[0]);
  let headerRow = "<tr>";
  headers.forEach(h => headerRow += `<th>${h}</th>`);
  headerRow += "</tr>";
  thead.innerHTML = headerRow;

  filteredData.forEach(row => {
    let rowHtml = "<tr>";
    headers.forEach(h => {
      let val = row[h];
      if(searchText && val.toLowerCase().includes(searchText.toLowerCase())){
        const regex = new RegExp(`(${searchText})`, "gi");
        val = val.replace(regex, '<span class="highlight">$1</span>');
      }
      rowHtml += `<td>${val}</td>`;
    });
    rowHtml += "</tr>";
    tbody.innerHTML += rowHtml;
  });
}

// Search filter
document.getElementById('search').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  filteredData = allData.filter(row =>
    Object.values(row).some(val => val.toLowerCase().includes(filter))
  );
  renderTable(filter);
});

// Handle image upload
document.getElementById('senderImgFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    senderImgDataUrl = evt.target.result;
  };
  reader.readAsDataURL(file);
});

// Print filtered rows with sender info + uploaded image
document.getElementById('printBtn').addEventListener('click', function() {
  const sender = document.getElementById('senderName').value || "Unknown Sender";
  let senderHtml = senderImgDataUrl ? `<img src="${senderImgDataUrl}" class="sender-img-print">` : "";
  senderHtml += `<strong>${sender}</strong>`;

  let tableHtml = `<p>${senderHtml}</p>`;
  tableHtml += `<table border="1" style="border-collapse:collapse; width:100%"><thead>${document.querySelector('#voterTable thead').innerHTML}</thead><tbody>`;
  filteredData.forEach(row => {
    tableHtml += "<tr>" + Object.values(row).map(v => `<td>${v}</td>`).join('') + "</tr>";
  });
  tableHtml += "</tbody></table>";

  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Voter List</title></head><body>');
  printWindow.document.write(tableHtml);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
});

// WhatsApp filtered rows with sender info (image URL cannot be sent in text)
document.getElementById('whatsappBtn').addEventListener('click', function() {
  const sender = document.getElementById('senderName').value || "Unknown Sender";
  let text = `Sender: ${sender}\n`;
  text += `\nVoter List:\n\n`;
  
  filteredData.forEach(row => {
    const pollingInfo = `State: ${row["State"] || ""}, District: ${row["District"] || ""}, AC No: ${row["AC No"] || ""}, Part No: ${row["Part No"] || ""}`;
    text += `${row["Name"] || ""} | EPIC: ${row["EPIC"] || ""} | ${pollingInfo}\n`;
  });

  const url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
});
</script>

</body>
</html>
