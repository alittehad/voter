<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
h1 { text-align: center; }
#controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
#search { padding: 8px; flex: 1; min-width: 200px; }
button { padding: 8px 12px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #007BFF; color: #fff; }
tr:nth-child(even) { background: #f9f9f9; }
@media(max-width:600px){
  table,thead,tbody,tr,th,td{display:block}
  th{position:sticky;top:0}
}
</style>
</head>
<body>

<h1>Voter List</h1>
<div id="controls">
  <input type="text" id="search" placeholder="Search by Name, EPIC, etc...">
  <button id="printBtn">Print</button>
  <button id="whatsappBtn">Send via WhatsApp</button>
</div>

<table id="voterTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8hv0c8CPDBHksZbD4igmVelXV_tEp01HiYVnDvbx3D8VbqzCJtQvF2Fl7HeO92ysrjuCqIR8VQpJc/pub?output=csv";

fetch(csvUrl)
  .then(response => response.text())
  .then(csvText => {
    const results = Papa.parse(csvText, { 
      header: true, 
      skipEmptyLines: true,
      transformHeader: h => h.trim()
    });
    let data = results.data;
    console.log(data); // Debugging

    // Remove duplicates based on EPIC
    const epicSet = new Set();
    data = data.filter(row => {
      if (!epicSet.has(row.EPIC)) { epicSet.add(row.EPIC); return true; }
      return false;
    });

    const table = document.getElementById('voterTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');

    // Header
    let headerRow = "<tr>";
    Object.keys(data[0]).forEach(key => {
      headerRow += `<th>${key}</th>`;
    });
    headerRow += "</tr>";
    thead.innerHTML = headerRow;

    // Rows
    data.forEach(row => {
      let rowHtml = "<tr>";
      Object.values(row).forEach(val => {
        rowHtml += `<td>${val}</td>`;
      });
      rowHtml += "</tr>";
      tbody.innerHTML += rowHtml;
    });

    // Search functionality
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('keyup', function() {
      const filter = this.value.toLowerCase();
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Print button
    document.getElementById('printBtn').addEventListener('click', function() {
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Voter List</title></head><body>');
      printWindow.document.write(table.outerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    });

    // WhatsApp share button (only visible rows)
    document.getElementById('whatsappBtn').addEventListener('click', function() {
      let text = "Voter List:\n\n";
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(r => {
        if (r.style.display !== 'none') {
          const cells = Array.from(r.querySelectorAll('td')).map(c => c.innerText);
          text += cells.join(" | ") + "\n";
        }
      });
      const url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    });

  })
  .catch(err => console.error("Error loading CSV:", err));
</script>

</body>
</html>
