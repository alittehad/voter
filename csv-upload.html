<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>CSV Upload â€” Voter Panel</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Papa Parse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

</head>
<body class="bg-gray-100 p-8">

<div class="max-w-xl mx-auto bg-white p-6 rounded shadow">

  <h1 class="text-2xl font-bold mb-4">CSV Upload</h1>

  <input id="csvLink" type="text" placeholder="Paste CSV Link"
    class="w-full p-2 border rounded mb-3">

  <button id="uploadCSV" class="bg-blue-600 text-white px-4 py-2 rounded">
    Upload CSV
  </button>

  <p id="status" class="mt-4 text-green-700 font-bold"></p>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --------------------------------------------------------
//  ðŸ‘‰ YOUR FIREBASE CONFIG
// --------------------------------------------------------
const firebaseConfig = {
  apiKey: "xxxxx",
  authDomain: "xxxxx",
  databaseURL: "https://xxxxxx.firebaseio.com",
  projectId: "xxxxxx",
  storageBucket: "xxxxxx",
  messagingSenderId: "xxxxxx",
  appId: "xxxxxx"
};

// INIT
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.getElementById("uploadCSV").onclick = () => {

  let link = document.getElementById("csvLink").value.trim();
  const status = document.getElementById("status");

  if (!link) {
    alert("Enter CSV Link!");
    return;
  }

  // Google Sheet â†’ CSV
  if (link.includes("docs.google.com/spreadsheets/d/")) {
    const id = link.match(/\/d\/([a-zA-Z0-9-_]+)/)[1];
    link = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
  }

  status.innerText = "Fetching CSV...";

  fetch(link)
    .then(r => r.text())
    .then(csvText => {

      // PARSE CSV
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,

        complete: (results) => {

          let uploadedCount = 0;

          results.data.forEach(row => {

            if (!row.EPIC || row.EPIC.trim() === "") return;

            const key = row.EPIC.replace(/\W/g, "_");

            set(ref(db, "voters/" + key), {
              name: row.Name || "",
              voterID: row.EPIC || "",
              state: row.State || "",
              district: row.District || "",
              acNo: row["AC No"] || "",
              partNo: row["Part No"] || "",
              booth: row.Booth || "",
              age: row.Age || "",
              mobile: row.Mobile || "",
              status: "anti"
            });

            uploadedCount++;
          });

          status.innerText = `Uploaded Successfully: ${uploadedCount} voters`;

        }
      });

    })
    .catch(err => {
      console.error(err);
      alert("CSV Fetch Failed!");
    });
};

</script>

</body>
</html>
