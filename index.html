<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter App - Ward 20</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
.btn-3d { 
  background: linear-gradient(145deg,#4f46e5,#6366f1); 
  color:white; font-weight:bold; padding:.5rem 1rem; 
  border-radius:.5rem; box-shadow:4px 4px 6px #333,-4px -4px 6px #777; 
  cursor:pointer; transition: all .2s;
}
.btn-3d:hover{
  box-shadow: inset 4px 4px 6px #333,inset -4px -4px 6px #777;
}
#fullscreenImg{
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,.8); justify-content:center; align-items:center; z-index:9999;
}
#fullscreenImg img{max-width:90%; max-height:90%; border-radius:.5rem;}
</style>
</head>
<body class="bg-gray-100">

<!-- Login -->
<div id="loginDiv" class="flex justify-center items-center h-screen">
  <button id="loginBtn" class="btn-3d">Login with Google</button>
</div>

<!-- Main App -->
<div id="mainDiv" class="hidden p-4">

  <!-- Top Logo -->
  <div class="flex items-center justify-start bg-white p-2 shadow-md mb-4 sticky top-0 z-50">
    <img src="https://i.postimg.cc/htFMsTSZ/Numeral-20-with-Bold-Ward.png" alt="Ward 20 Logo" class="h-12 w-12 mr-2 rounded-full shadow-lg">
    <h1 class="text-xl font-bold">Ward 20</h1>
  </div>

  <!-- User Panel -->
  <div id="userPanel" class="mb-4 border p-2 rounded bg-white shadow">
    <h1 class="text-xl font-bold">Voter List</h1>
    <input type="text" id="searchInput" placeholder="Search by name..." class="border p-1 my-2 w-full">
    <div id="voterListUser" class="overflow-auto max-h-64 border p-2"></div>
  </div>

  <!-- Member Panel -->
  <div id="memberPanel" class="mb-4 border p-2 rounded bg-white shadow">
    <h1 class="text-xl font-bold">Member Survey Form</h1>
    <form id="surveyForm" class="flex flex-col">
      <input type="text" id="memberName" placeholder="Your Name" required class="border p-1 my-1">
      <input type="text" id="memberMobile" placeholder="Mobile" required class="border p-1 my-1">
      <input type="text" id="memberWard" placeholder="Ward No" required class="border p-1 my-1">
      <input type="file" id="memberPoster" required class="border p-1 my-1">
      <button type="submit" class="btn-3d my-2">Submit Survey</button>
    </form>

    <h2 class="mt-4 font-semibold">Member Survey Counts</h2>
    <div id="memberCount" class="overflow-auto max-h-64 mt-2 border p-2"></div>
  </div>

</div>

<!-- Fullscreen Image -->
<div id="fullscreenImg" onclick="this.style.display='none'">
  <img id="fullImg" src="">
</div>

<script type="module">
// ---------------- Firebase ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
const provider = new GoogleAuthProvider();

// ---------------- Login ----------------
const loginDiv = document.getElementById("loginDiv");
const mainDiv = document.getElementById("mainDiv");

document.getElementById("loginBtn").addEventListener("click", () => {
  signInWithPopup(auth, provider)
    .then(result => { 
      localStorage.setItem("user", JSON.stringify(result.user)); 
      loginDiv.style.display="none"; 
      mainDiv.style.display="block";
      loadVoters();
      loadMemberCounts();
    })
    .catch(console.error);
});

// ---------------- Load Voters ----------------
function loadVoters(){
  const userList=document.getElementById("voterListUser");
  userList.innerHTML="";
  onValue(dbRef(db,"voters"),snapshot=>{
    snapshot.forEach(snap=>{
      const voter = snap.val();
      let bg=""; 
      if(voter.status==="approved") bg="bg-green-200"; 
      else if(voter.status==="pending") bg="bg-yellow-200"; 
      else if(voter.status==="opponent") bg="bg-red-200";

      const div=document.createElement("div");
      div.className=`border p-1 my-1 flex justify-between items-center ${bg}`;
      div.innerHTML=`<span><b>${voter.name}</b> | EPIC: ${voter.voterID} | Ward: ${voter.ward} | Status: ${voter.status}</span>`;

      userList.appendChild(div);
    });
  });
}

// ---------------- Member Survey ----------------
document.getElementById("surveyForm").addEventListener("submit", e=>{
  e.preventDefault();
  const name=document.getElementById("memberName").value;
  const mobile=document.getElementById("memberMobile").value;
  const ward=document.getElementById("memberWard").value;
  const poster=document.getElementById("memberPoster").files[0];
  if(!poster) return alert("Upload poster");

  const formData=new FormData(); 
  formData.append("image",poster);
  const imgbbKey="8ece3c1f959f2426083eee1699086c71";

  fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`,{method:"POST",body:formData})
    .then(res=>res.json())
    .then(data=>{
      push(dbRef(db,"memberSurveys"),{name,mobile,ward,poster:data.data.display_url,timestamp:Date.now()});
      alert("Survey submitted!"); e.target.reset(); loadMemberCounts();
    }).catch(err=>console.error(err));
});

// ---------------- Member Counts ----------------
function loadMemberCounts(){
  const countDiv=document.getElementById("memberCount");
  countDiv.innerHTML="";
  onValue(dbRef(db,"memberSurveys"),snapshot=>{
    const counts={};
    snapshot.forEach(snap=>{
      const m = snap.val().name;
      counts[m]=(counts[m]||0)+1;
    });
    for(let m in counts){
      const d=document.createElement("div"); 
      d.innerText=m+" -> "+counts[m]+" surveys"; 
      countDiv.appendChild(d);
    }
  });
}

// ---------------- Search ----------------
document.getElementById("searchInput").addEventListener("input",function(){
  const val=this.value.toLowerCase();
  Array.from(document.getElementById("voterListUser").children).forEach(div=>{
    div.style.display = div.innerText.toLowerCase().includes(val)? "flex":"none";
  });
});

</script>

</body>
</html>
