<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Election Voter Site</title>
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .btn-3d {
    background: linear-gradient(145deg, #4ade80, #16a34a);
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 10px;
    box-shadow: 0 4px #15803d;
    transition: 0.2s;
  }
  .btn-3d:active {
    box-shadow: 0 2px #15803d;
    transform: translateY(2px);
  }
</style>
</head>
<body class="bg-gray-100 p-4">

<div id="loginPage" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg text-center">
  <h2 class="text-2xl font-bold mb-4">Login to Election Site</h2>
  <button id="loginBtn" class="btn-3d w-full text-lg">Login with Google</button>
</div>

<div id="userPage" class="hidden max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg mb-6">
  <h2 class="text-2xl font-bold mb-4 text-center">Voter Registration</h2>
  <form id="regForm" class="space-y-4">
    <input type="text" id="name" placeholder="Name" required class="w-full border p-2 rounded-md">
    <input type="text" id="address" placeholder="Address" required class="w-full border p-2 rounded-md">
    <input type="text" id="mobile" placeholder="Mobile No" required class="w-full border p-2 rounded-md">
    <input type="text" id="epic" placeholder="EPIC / Voter ID" required class="w-full border p-2 rounded-md">
    <button type="submit" class="btn-3d w-full text-lg">Register</button>
  </form>
</div>

<div id="adminPage" class="hidden max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-6">
  <h2 class="text-2xl font-bold mb-4 text-center">Super Admin Dashboard</h2>
  <div id="dashboard" class="space-y-4"></div>
</div>

<div id="voterListPage" class="hidden max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg">
  <h2 class="text-2xl font-bold mb-4 text-center">Approved Voters List</h2>
  <div class="overflow-x-auto">
  <table class="w-full table-auto border-collapse border border-gray-300">
    <thead class="bg-gray-200">
      <tr>
        <th class="border px-2 py-1">Name</th>
        <th class="border px-2 py-1">Address</th>
        <th class="border px-2 py-1">Mobile</th>
        <th class="border px-2 py-1">EPIC</th>
      </tr>
    </thead>
    <tbody id="voterList" class="text-center"></tbody>
  </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

// ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Pages
const loginPage = document.getElementById("loginPage");
const userPage = document.getElementById("userPage");
const adminPage = document.getElementById("adminPage");
const voterListPage = document.getElementById("voterListPage");
const dashboard = document.getElementById("dashboard");
const voterList = document.getElementById("voterList");

// ðŸ”¹ Login
document.getElementById("loginBtn").addEventListener("click", async () => {
  await signInWithPopup(auth, provider);
});

// ðŸ”¹ Auth State
onAuthStateChanged(auth, user => {
  if(user){
    loginPage.classList.add("hidden");

    if(user.email === "ngogrant45@gmail.com"){
      adminPage.classList.remove("hidden");
      userPage.classList.add("hidden");
      loadAdminDashboard();
      loadApprovedVoterList();
    } else {
      userPage.classList.remove("hidden");
      adminPage.classList.add("hidden");
      loadApprovedVoterList();
    }
  } else {
    loginPage.classList.remove("hidden");
    userPage.classList.add("hidden");
    adminPage.classList.add("hidden");
    voterListPage.classList.add("hidden");
  }
});

// ðŸ”¹ User Registration
document.getElementById("regForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const address = document.getElementById("address").value;
  const mobile = document.getElementById("mobile").value;
  const epic = document.getElementById("epic").value;

  // ðŸ”¹ EPIC uniqueness check
  const q = query(collection(db, "registrations"), where("epic", "==", epic));
  const existing = await getDocs(q);
  if(!existing.empty){
    alert("This EPIC is already registered!");
    return;
  }

  await addDoc(collection(db, "registrations"), { name, address, mobile, epic, status: "pending" });
  alert("Registration submitted! Waiting for Super Admin approval.");
  document.getElementById("regForm").reset();
});

// ðŸ”¹ Load Super Admin Dashboard (real-time)
function loadAdminDashboard(){
  const registrationsRef = collection(db, "registrations");
  onSnapshot(registrationsRef, snapshot => {
    dashboard.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "flex justify-between items-center bg-gray-100 p-3 rounded-md shadow";

      let statusHtml = "";
      if(data.status === "pending"){
        statusHtml = `<button class="btn-3d text-sm" onclick="approveUser('${docSnap.id}')">Approve</button>`;
      } else {
        statusHtml = `<span class="font-medium text-green-600">Approved</span>`;
      }

      div.innerHTML = `
        <div>
          <p><strong>${data.name}</strong> (${data.epic})</p>
          <p>${data.address} | ${data.mobile}</p>
        </div>
        <div>${statusHtml}</div>
      `;
      dashboard.appendChild(div);
    });
  });
}

// ðŸ”¹ Approve User
window.approveUser = async (id) => {
  await updateDoc(doc(db, "registrations", id), { status: "approved" });
};

// ðŸ”¹ Load Approved Voter List (real-time)
function loadApprovedVoterList(){
  const q = query(collection(db, "registrations"), where("status","==","approved"));
  onSnapshot(q, snapshot => {
    voterListPage.classList.remove("hidden");
    voterList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      voterList.innerHTML += `
        <tr>
          <td class="border px-2 py-1">${data.name}</td>
          <td class="border px-2 py-1">${data.address}</td>
          <td class="border px-2 py-1">${data.mobile}</td>
          <td class="border px-2 py-1">${data.epic}</td>
        </tr>
      `;
    });
  });
}
</script>

</body>
</html>
