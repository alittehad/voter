<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter App</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">

<style>
#mainDiv{ display:none; }
#voterListUser, #voterListAdmin, #memberSurveys { max-height:400px; overflow:auto; border:1px solid #ccc; padding:5px; }
.voterRow { padding:2px; border-bottom:1px solid #eee; }
</style>
</head>
<body>

<div id="loginDiv" class="flex justify-center items-center h-screen">
  <button class="bg-blue-500 text-white p-4 rounded" onclick="login()">Login with Google</button>
</div>

<div id="mainDiv" class="p-4">

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <h1 class="text-xl font-bold">Admin Panel</h1>
    <input type="text" id="sheetCSV" placeholder="Google Sheet CSV URL" class="border p-1 my-2 w-full">
    <button class="bg-green-500 p-2 rounded my-2" onclick="importVotersFromSheet()">Import Voters</button>
    <div id="voterListAdmin"></div>
    <h2 class="mt-4 font-semibold">Member Surveys</h2>
    <div id="memberSurveys"></div>
  </div>

  <!-- User Panel -->
  <div id="userPanel" class="hidden">
    <h1 class="text-xl font-bold">Voter List</h1>
    <input type="text" id="searchInput" placeholder="Search by name..." class="border p-1 my-2 w-full" oninput="searchVoters()">
    <div id="voterListUser"></div>
  </div>

  <!-- Member Panel -->
  <div id="memberPanel" class="hidden">
    <h1 class="text-xl font-bold">Member Survey Form</h1>
    <form id="surveyForm">
      <input type="text" id="memberName" placeholder="Your Name" required class="border p-1 my-1 w-full">
      <input type="text" id="memberMobile" placeholder="Mobile" required class="border p-1 my-1 w-full">
      <input type="text" id="memberWard" placeholder="Ward No" required class="border p-1 my-1 w-full">
      <input type="file" id="memberPoster" required class="border p-1 my-1 w-full">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded my-2">Submit Survey</button>
    </form>
  </div>

</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);

let currentUser = null;
const admins = ["ngogrant454@gmail.com"];
const allowedUsers = ["ngogrant454@gmail.com"];

// Login
function login(){
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider)
    .then(result=>{
      currentUser = result.user;
      if(!allowedUsers.includes(currentUser.email)){
        alert("Not authorized");
        firebase.auth().signOut();
        return;
      }
      document.getElementById("loginDiv").style.display="none";
      document.getElementById("mainDiv").style.display="block";
      if(admins.includes(currentUser.email)){
        document.getElementById("adminPanel").style.display="block";
      } else {
        document.getElementById("userPanel").style.display="block";
        document.getElementById("memberPanel").style.display="block";
      }
      loadVoters();
      loadMemberSurveys();
    })
    .catch(err=>{ console.error(err); alert("Login failed: "+err.message); });
}

// Import voters from Google Sheet CSV
function importVotersFromSheet(){
  const url = document.getElementById("sheetCSV").value;
  if(!url){ alert("Enter CSV URL"); return; }
  Papa.parse(url, {
    download:true, header:true,
    complete:function(results){
      const data = results.data;
      const ref = firebase.database().ref("voters");
      data.forEach(row=>{
        const key = row.EPIC || row.voterID || row["EPIC"];
        ref.child(key).set({
          name: row.Name || row.name,
          voterID: key,
          ward: row.Ward || row.ward,
          status: "pending"
        });
      });
      alert("Voters Imported");
      loadVoters();
    }
  });
}

// Load voters
function loadVoters(){
  firebase.database().ref("voters").once("value").then(snap=>{
    const voters = snap.val() || {};
    let html="";
    for(let k in voters){
      let v=voters[k];
      html+=`<div class="voterRow" style="background:${v.status==="confirmed"?"green":v.status==="opposed"?"red":"yellow"}">
        ${v.name} - ${v.voterID} - ${v.ward} 
        <button onclick="shareVoter('${k}')">Share</button>
      </div>`;
    }
    document.getElementById(admins.includes(currentUser.email)?"voterListAdmin":"voterListUser").innerHTML=html;
  });
}

// Member surveys
function loadMemberSurveys(){
  firebase.database().ref("memberSurveys").once("value").then(snap=>{
    const surveys = snap.val() || {};
    let html="";
    for(let k in surveys){
      let s = surveys[k];
      html+=`<div>${s.name} | ${s.ward} | ${s.submittedBy}</div>`;
    }
    document.getElementById("memberSurveys").innerHTML=html;
  });
}

// Member survey submit
document.getElementById("surveyForm")?.addEventListener("submit", function(e){
  e.preventDefault();
  const name=document.getElementById("memberName").value;
  const mobile=document.getElementById("memberMobile").value;
  const ward=document.getElementById("memberWard").value;
  const posterFile=document.getElementById("memberPoster").files[0];
  if(!posterFile){ alert("Upload poster"); return; }
  const reader=new FileReader();
  reader.onload=function(){
    firebase.database().ref("memberSurveys").push({
      name,mobile,ward,poster:reader.result,submittedBy:currentUser.email,timestamp:Date.now()
    });
    alert("Survey submitted");
    document.getElementById("surveyForm").reset();
    loadMemberSurveys();
    loadVoters();
  };
  reader.readAsDataURL(posterFile);
});

// Search voters
function searchVoters(){
  const q=document.getElementById("searchInput").value.toLowerCase();
  const div=document.getElementById("voterListUser");
  Array.from(div.children).forEach(c=>{
    c.style.display = c.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

// WhatsApp share
function shareVoter(epic){
  firebase.database().ref("voters/"+epic).once("value").then(snap=>{
    const v=snap.val();
    const msg=`Voter: ${v.name}, EPIC: ${v.voterID}, Ward: ${v.ward}`;
    const wa=`https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wa,"_blank");
  });
}
</script>

</body>
</html>
