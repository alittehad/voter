<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.card {
  background: linear-gradient(135deg, #fef9c3, #fde68a);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  margin-bottom: 1rem;
}
.button-3d {
  background: linear-gradient(145deg, #4f46e5, #3b36c4);
  color: white;
  font-weight: bold;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  box-shadow: 4px 4px 6px #333, -4px -4px 6px #666;
  transition: 0.2s;
  display: inline-block;
  text-align: center;
  margin-top: 5px;
}
.button-3d:hover {
  transform: translateY(-2px);
  box-shadow: 6px 6px 8px #333, -6px -6px 8px #666;
}
img { max-width: 100%; border-radius: 8px; }
</style>
</head>
<body class="bg-gray-100 p-4">

<div id="cardContainer" class="max-w-md mx-auto"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const epic = new URLSearchParams(window.location.search).get("id");
const cardContainer = document.getElementById("cardContainer");

async function loadVoter() {
  const snapshot = await get(ref(db, 'voters/' + epic));
  const voter = snapshot.val();
  if(!voter) { cardContainer.innerHTML = "<p>Voter not found</p>"; return; }

  cardContainer.innerHTML = `
    <div class="card">
      <h2 class="text-xl font-bold mb-2">${voter.name}</h2>
      <p><strong>EPIC:</strong> ${voter.EPIC}</p>
      <p><strong>AC No:</strong> ${voter.acNo}</p>
      <p><strong>Part No:</strong> ${voter.partNo}</p>
      <div id="imagesContainer" class="my-2 flex flex-col gap-2"></div>
      <div class="my-2">
        <textarea id="description" rows="3" placeholder="Add description..." class="w-full p-2 border rounded">${voter.description || ''}</textarea>
        <button id="saveDescBtn" class="button-3d w-full">Save Description</button>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="printBtn" class="button-3d flex-1">Print</button>
        <button id="whatsappBtn" class="button-3d flex-1">Send WhatsApp</button>
      </div>
      <div class="my-2">
        <input type="file" id="imageInput" multiple class="mb-2">
        <button id="uploadBtn" class="button-3d w-full">Upload Image</button>
      </div>
    </div>
  `;

  // Load images
  const imagesContainer = document.getElementById("imagesContainer");
  voter.images = voter.images || [];
  voter.images.forEach((url, idx) => {
    const div = document.createElement("div");
    div.classList.add("relative");
    div.innerHTML = `<img src="${url}" alt="voter image">
                     <button class="button-3d absolute top-0 right-0 text-sm" data-idx="${idx}">Delete</button>`;
    imagesContainer.appendChild(div);
  });

  // Delete images
  imagesContainer.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const i = btn.dataset.idx;
      const fileRef = sRef(storage, 'voterImages/' + epic + '/' + i);
      await deleteObject(fileRef).catch(()=>console.log("Skipped delete in storage"));
      voter.images.splice(i,1);
      await update(ref(db, 'voters/' + epic), { images: voter.images });
      loadVoter();
    });
  });

  // Save description
  document.getElementById("saveDescBtn").addEventListener("click", async () => {
    const desc = document.getElementById("description").value.trim();
    await update(ref(db, 'voters/' + epic), { description: desc });
    alert("Description saved");
  });

  // Upload images
  document.getElementById("uploadBtn").addEventListener("click", async () => {
    const files = document.getElementById("imageInput").files;
    if(!files.length) { alert("Select files"); return; }
    for(let f of files){
      const storageRef = sRef(storage, 'voterImages/' + epic + '/' + f.name);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);
      voter.images.push(url);
    }
    await update(ref(db, 'voters/' + epic), { images: voter.images });
    loadVoter();
  });

  // Print
  document.getElementById("printBtn").addEventListener("click", () => {
    const printContent = `<h2>${voter.name}</h2>
                          <p>EPIC: ${voter.EPIC}</p>
                          <p>AC No: ${voter.acNo}</p>
                          <p>Part No: ${voter.partNo}</p>
                          <p>Description: ${document.getElementById("description").value}</p>`;
    const w = window.open("", "", "width=600,height=600");
    w.document.write(printContent); w.document.close(); w.print();
  });

  // WhatsApp
  document.getElementById("whatsappBtn").addEventListener("click", () => {
    const msg = `Name: ${voter.name}\nEPIC: ${voter.EPIC}\nAC: ${voter.acNo}\nPart: ${voter.partNo}\nDescription: ${document.getElementById("description").value}`;
    const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  });
}

loadVoter();
</script>
</body>
</html>
