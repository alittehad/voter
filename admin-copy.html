<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List</title>

<style>
body { font-family: Arial; margin:0; padding:10px; background:#f1f1f1; }
h2 { text-align:center; margin-bottom:15px; }

/* Search Box */
#searchBox {
  width:100%; padding:10px; border:2px solid #999; border-radius:6px;
  font-size:18px; margin-bottom:15px;
}

/* Result List */
.result-item {
  padding:10px; margin:5px 0; background:white;
  border-radius:6px; border-left:5px solid #007bff;
  cursor:pointer; display:flex; justify-content:space-between; align-items:center;
}

.result-item span.color-tag {
  width:20px; height:20px; border-radius:4px; display:inline-block;
}

/* Overlay */
#overlay {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:999;
}

/* Card */
#card {
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%, -50%);
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
  max-width:90%; width:400px;
  z-index:1000;
}

#card .color-btn {
  width:30px; height:30px; border-radius:6px;
  border:none; margin-right:8px; cursor:pointer;
}

#msg {
  width:100%; height:80px; padding:8px;
  border:2px solid #aaa; border-radius:6px;
}

.btn-small {
  padding:8px 15px; border:none; border-radius:6px;
  margin-right:10px; cursor:pointer; color:white;
}
.btn-save { background:#28a745; }
.btn-del { background:#dc3545; }
.btn-print { background:#007bff; }
.btn-whatsapp { background:#25d366; }

.voter-color-tag {
  width:20px; height:20px; border-radius:4px; display:inline-block;
}

#card .close-btn {
  background:red; color:white; float:right; padding:5px 10px;
  border:none; border-radius:5px; cursor:pointer;
}
</style>
</head>
<body>

<h2>Voter Search</h2>
<input type="text" id="searchBox" placeholder="Type 1 letter to search..." />

<div id="results"></div>
<div id="overlay" onclick="closeCard()"></div>

<div id="card">
  <button class="close-btn" onclick="closeCard()">Close</button>
  <h3 id="vname"></h3>
  <p><b>EPIC:</b> <span id="vepic"></span></p>
  <p><b>Area:</b> <span id="varea"></span></p>
  <p><b>Relation:</b> <span id="vrelation"></span></p>
  <p><b>Age/Gender:</b> <span id="vage"></span>/<span id="vgender"></span></p>
  <p><b>Saved Color:</b> <span class="voter-color-tag" id="colortag"></span></p>

  <hr>
  <p><b>Change Color:</b></p>
  <button class="color-btn" style="background:#ff4444" onclick="saveColor('#ff4444')"></button>
  <button class="color-btn" style="background:#44cc44" onclick="saveColor('#44cc44')"></button>
  <button class="color-btn" style="background:#4477ff" onclick="saveColor('#4477ff')"></button>

  <hr>
  <p><b>Sender Message</b></p>
  <textarea id="msg"></textarea>
  <br><br>
  <button class="btn-small btn-save" onclick="saveMessage()">Save</button>
  <button class="btn-small btn-del" onclick="deleteMessage()">Delete</button>

  <hr>
  <button class="btn-small btn-print" onclick="printCard()">Print</button>
  <button class="btn-small btn-whatsapp" onclick="sendWhatsApp()">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters = [];
let activeVoter = null;

// Fetch voters from Firebase
db.ref("voters").once("value").then(snap=>{
    let data = snap.val() || {};
    voters = Object.keys(data).map(epic=>{
        return {
            epic_no: epic,
            voter_full_name: data[epic].voter_full_name || "",
            house_number: data[epic].house_number || "",
            relation_name: data[epic].relation_name || "",
            relation_type: data[epic].relation_type || "",
            age: data[epic].age || "",
            gender: data[epic].gender || "",
            color: data[epic].color || "#ffffff",
            message: data[epic].message || ""
        }
    });
    renderResults();
});

// Render search results
function renderResults(){
    let q = document.getElementById("searchBox").value.toLowerCase();
    let html = "";
    if(q.length >= 1){
        voters.forEach(v=>{
            if(v.voter_full_name.toLowerCase().includes(q) || v.epic_no.toLowerCase().includes(q)){
                html += `<div class="result-item" onclick="openCard('${v.epic_no}')">
                            <span>${v.voter_full_name} (${v.epic_no})</span>
                            <span class="color-tag" style="background:${v.color}"></span>
                         </div>`;
            }
        });
    }
    document.getElementById("results").innerHTML = html;
}

// Search input listener
document.getElementById("searchBox").addEventListener("input", renderResults);

// Open Card
function openCard(epic){
    activeVoter = voters.find(v=>v.epic_no===epic);
    if(!activeVoter) return;

    document.getElementById("vname").innerText = activeVoter.voter_full_name;
    document.getElementById("vepic").innerText = activeVoter.epic_no;
    document.getElementById("varea").innerText = activeVoter.house_number || "NA";
    document.getElementById("vrelation").innerText = activeVoter.relation_name + " ("+activeVoter.relation_type+")";
    document.getElementById("vage").innerText = activeVoter.age;
    document.getElementById("vgender").innerText = activeVoter.gender;

    document.getElementById("colortag").style.background = activeVoter.color || "#ffffff";
    document.getElementById("msg").value = activeVoter.message || "";

    document.getElementById("overlay").style.display = "block";
    document.getElementById("card").style.display = "block";
}

function closeCard(){
    document.getElementById("card").style.display="none";
    document.getElementById("overlay").style.display="none";
}

// Save Color
function saveColor(c){
    if(activeVoter){
        activeVoter.color = c;
        document.getElementById("colortag").style.background = c;
        db.ref("voters/"+activeVoter.epic_no+"/color").set(c);
        renderResults(); // update color in search list
        alert("Color Saved!");
    }
}

// Save Message
function saveMessage(){
    if(activeVoter){
        activeVoter.message = document.getElementById("msg").value;
        db.ref("voters/"+activeVoter.epic_no+"/message").set(activeVoter.message);
        alert("Message Saved!");
    }
}

// Delete Message
function deleteMessage(){
    if(activeVoter){
        activeVoter.message = "";
        document.getElementById("msg").value = "";
        db.ref("voters/"+activeVoter.epic_no+"/message").remove();
        alert("Message Deleted!");
    }
}

// Print
function printCard(){
    if(activeVoter){
        let text = `Name: ${activeVoter.voter_full_name}
EPIC: ${activeVoter.epic_no}
Area: ${activeVoter.house_number}
Relation: ${activeVoter.relation_name} (${activeVoter.relation_type})
Age/Gender: ${activeVoter.age}/${activeVoter.gender}

Message:
${activeVoter.message}`;
        let w = window.open("", "", "width=400,height=600");
        w.document.write("<pre>"+text+"</pre>");
        w.print();
    }
}

// WhatsApp
function sendWhatsApp(){
    if(activeVoter){
        let text = `*Voter Details*\nName: ${activeVoter.voter_full_name}\nEPIC: ${activeVoter.epic_no}\nArea: ${activeVoter.house_number}\nRelation: ${activeVoter.relation_name} (${activeVoter.relation_type})\nAge/Gender: ${activeVoter.age}/${activeVoter.gender}\n\n*Message:*\n${activeVoter.message}`;
        window.open("https://wa.me/?text="+encodeURIComponent(text), "_blank");
    }
}
</script>
</body>
</html>
