<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auto Mapping CSV ‚Üí Firebase</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{background:#f3f4f6;padding:20px;font-family:sans-serif;}
.box{background:white;padding:20px;border-radius:10px;max-width:500px;margin:auto;
box-shadow:0 4px 10px rgba(0,0,0,0.1);}
</style>
</head>

<body>

<div class="box">
  <h2 class="text-xl font-bold mb-2 text-center">üì• Import Google Sheet CSV ‚Üí Firebase</h2>

  <input id="csvLink" type="text"
    placeholder="Paste Google Sheet CSV Link"
    class="border p-2 w-full rounded mb-3">

  <button onclick="importCSV()"
    class="bg-blue-600 text-white p-2 w-full rounded font-bold">
    Import Now
  </button>

  <p id="msg" class="mt-4 text-center font-bold"></p>
</div>


<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";


// ‚≠ê Your Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


// ‚≠ê Safe Firebase Key
function cleanKey(k){
  return k.trim()
    .replace(/[.#$/\[\]\s]/g, "_");
}


// ‚≠ê AUTO MAPPING FUNCTION
function mapColumns(headerRow){
  let map = {};

  headerRow.forEach((col, i) => {
    let c = col.toLowerCase().trim();

    if(c.includes("name")) map.name = i;
    if(c.includes("voter") || c.includes("epic") || c.includes("id")) map.voterID = i;
    if(c.includes("state")) map.state = i;
    if(c.includes("district")) map.district = i;
    if(c.includes("ac")) map.acNo = i;
    if(c.includes("part")) map.partNo = i;
    if(c.includes("booth")) map.booth = i;
    if(c.includes("age")) map.age = i;
    if(c.includes("mobile") || c.includes("phone")) map.mobile = i;
    if(c.includes("status")) map.status = i;
  });

  return map;
}


// ‚≠ê MAIN IMPORT FUNCTION
window.importCSV = async function () {
  
  let link = document.getElementById("csvLink").value;
  let msg = document.getElementById("msg");

  if(!link){
    msg.innerHTML = "‚ùå Paste Google Sheet CSV Link";
    msg.style.color = "red";
    return;
  }

  try {
    let res = await fetch(link);
    let text = await res.text();

    let lines = text.split("\n").map(l => l.trim()).filter(l => l);
    let header = lines[0].split(",");

    let map = mapColumns(header);
    console.log("Column Mapping:", map);

    let count = 0;

    for(let i=1; i<lines.length; i++){
      let row = lines[i].split(",");

      // Auto Mapping
      let voterID = cleanKey(row[map.voterID]);
      if(!voterID) continue;

      // AUTO STATUS (If blank)
      let age = Number(row[map.age]);
      let status = row[map.status] || 
                  (age >= 30 ? "approved" : "pending");

      let data = {
        name: row[map.name] || "",
        voterID,
        state: row[map.state] || "",
        district: row[map.district] || "",
        acNo: row[map.acNo] || "",
        partNo: row[map.partNo] || "",
        booth: row[map.booth] || "",
        age: row[map.age] || "",
        mobile: row[map.mobile] || "",
        status: status
      };

      await set(ref(db, "voters/" + voterID), data);
      count++;
    }

    msg.innerHTML = `‚úî Successfully Imported ${count} Voters üéâ`;
    msg.style.color = "green";

  } catch (err){
    msg.innerHTML = "‚ùå ERROR: " + err;
    msg.style.color = "red";
  }
}

</script>

</body>
</html>
