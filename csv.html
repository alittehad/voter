<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload CSV to Firebase</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background: #f3f4f6;
  padding: 20px;
  font-family: sans-serif;
}
.box {
  background:white;
  padding:20px;
  border-radius:10px;
  max-width:450px;
  margin:auto;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<div class="box">
  <h2 class="text-xl font-bold mb-4 text-center">üì§ Upload CSV to Firebase</h2>

  <input id="csvFile" type="file" accept=".csv"
    class="border p-2 w-full rounded mb-3">

  <button onclick="uploadCSV()"
    class="bg-blue-600 text-white p-2 w-full rounded font-bold">
    Upload CSV
  </button>

  <p id="msg" class="mt-4 text-center font-bold"></p>
</div>



<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Your Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


// üî• Clean Key Function ‚Äî Firebase Safe Key
function cleanKey(key){
  return key
    .trim()
    .replace(/\./g, "_")
    .replace(/#/g, "_")
    .replace(/\$/g, "_")
    .replace(/\//g, "_")
    .replace(/\[/g, "_")
    .replace(/\]/g, "_")
    .replace(/\s+/g, "_"); // space ‚Üí underscore
}


// üî• MAIN Upload Function
window.uploadCSV = function () {
  let file = document.getElementById("csvFile").files[0];
  let msg = document.getElementById("msg");

  if(!file){
    msg.innerHTML = "‚ùå Please select a CSV file";
    msg.style.color = "red";
    return;
  }

  let reader = new FileReader();
  reader.onload = function(event){
    let lines = event.target.result.split("\n");

    let count = 0;

    lines.forEach((line, index) => {
      if(index === 0) return; // skip header row
      if(!line.trim()) return; // skip blank line

      let row = line.split(",");

      // CSV Columns ‚Üí modify according to your sheet:
      let name   = row[0];
      let voterID = cleanKey(row[1]);
      let state  = row[2];
      let district = row[3];
      let acNo   = row[4];
      let partNo = row[5];
      let booth  = row[6];
      let age    = row[7];
      let mobile = row[8];
      let status = row[9];

      if(!voterID) return;  // skip empty keys

      let data = {
        name, voterID, state, district, acNo, partNo, booth, age, mobile, status
      };

      // Upload to Firebase
      set(ref(db, "voters/" + voterID), data)
      .then(() => {
        count++;
        msg.innerHTML = `‚úî Uploaded: ${count} records`;
        msg.style.color = "green";
      })
      .catch(err => {
        msg.innerHTML = "‚ùå Firebase Error: " + err;
        msg.style.color = "red";
      });

    });
  };

  reader.readAsText(file);
}
</script>

</body>
</html>
