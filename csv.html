<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Management Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:system-ui; background:#eef2ff; margin:0; padding:0;}
  .container{max-width:1100px; margin:16px auto; padding:12px;}
  h1.heading{font-weight:800; font-size:1.8rem; text-align:center; margin-bottom:12px; transform:perspective(500px) rotateX(6deg); text-shadow:0 1px 0 rgba(255,255,255,0.5),0 6px 12px rgba(2,6,23,0.12);}
  .card{background:white; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow:4px 4px 12px rgba(2,6,23,0.08);}
  .img-sender{width:50px; height:50px; border-radius:999px; object-fit:cover; margin-right:6px;}
  .btn{cursor:pointer; padding:4px 6px; border-radius:6px; font-weight:600; font-size:0.8rem;}
  .btn-blue{background:#2563eb;color:white;}
  .btn-green{background:#16a34a;color:white;}
  .btn-red{background:#dc2626;color:white;}
  .btn-gray{background:#6b7280;color:white;}
  .btn-yellow{background:#facc15;color:#111;}
  .table-container{overflow-x:auto;}
  table{width:100%; border-collapse:collapse;}
  th,td{padding:6px;border:1px solid #e6e9ef;text-align:left;}
  thead{background:#ebf8ff;font-weight:700;}
  tr:hover{background:#f7f9ff;}
  .status-approved{background:#dcfce7;}
  .status-opponent{background:#fef9c3;}
  .status-anti{background:#fee2e2;}
  @media(max-width:768px){th,td{font-size:0.75rem;padding:4px;}}
</style>
</head>
<body>
<div class="container">
  <h1 class="heading">Voter Management Panel</h1>

  <!-- Login -->
  <div id="loginDiv" class="card text-center">
    <h2 class="text-lg font-bold text-blue-700">Login to Access</h2>
    <button id="googleLoginBtn" class="btn btn-blue mt-4">Login with Google</button>
  </div>

  <!-- Panel -->
  <div id="panelDiv" class="hidden">
    <!-- Sender Description -->
    <div class="card flex gap-4 items-center">
      <textarea id="senderDesc" placeholder="Sender Description" class="w-full border p-2 rounded" rows="2"></textarea>
    </div>

    <!-- Status Count -->
    <div class="flex gap-4 mt-2">
      <div class="card px-4 py-2">Approved: <span id="countApproved">0</span></div>
      <div class="card px-4 py-2">Opponent: <span id="countOpponent">0</span></div>
      <div class="card px-4 py-2">Anti: <span id="countAnti">0</span></div>
    </div>

    <!-- Search -->
    <div class="card mt-2">
      <input id="searchVoter" placeholder="Search Name / EPIC / Status..." class="w-full border p-2 rounded"/>
    </div>

    <!-- Voter Table -->
    <div id="voterList" class="mt-2 table-container card"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref as dbRef, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase(app);

const loginDiv = document.getElementById("loginDiv");
const panelDiv = document.getElementById("panelDiv");
const loginBtn = document.getElementById("googleLoginBtn");
const voterListDiv = document.getElementById("voterList");
const searchInput = document.getElementById("searchVoter");
const senderDescEl = document.getElementById("senderDesc");

const FIXED_SENDER_IMAGE = "https://i.ibb.co/LhDpnZFn/khatik-imase.jpg";
const allowedAdmins = ["ngogrant454@gmail_com"]; // Admin emails
let voterData = [];

loginBtn.onclick = () => {
  signInWithPopup(auth, provider)
  .then(res=>{
    const emailKey = res.user.email.replace(/\./g,'_');
    if(!allowedAdmins.includes(emailKey)){ alert("Access Denied"); auth.signOut();}
  })
  .catch(err=>alert("Login Failed: "+err.message));
};

onAuthStateChanged(auth, user => {
  if(user){ loginDiv.classList.add("hidden"); panelDiv.classList.remove("hidden"); loadVoters(); }
  else{ loginDiv.classList.remove("hidden"); panelDiv.classList.add("hidden"); }
});

function loadVoters(){
  const r = dbRef(db,"voters");
  onValue(r, snap=>{
    voterData=[]; snap.forEach(c=>voterData.push({id:c.key,...c.val()}));
    renderTable(voterData); updateStatusCount();
  });
}

function renderTable(list){
  let html=`<table><thead><tr><th>Name</th><th>EPIC</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>`;
  voterListDiv.innerHTML = html;
  const tbody = voterListDiv.querySelector("tbody");
  list.forEach(v=>{
    const tr = document.createElement("tr");
    tr.className="status-"+v.status;
    tr.innerHTML=`<td>${v.name||''}</td><td>${v.epic||v.voterID||''}</td><td>${v.status||''}</td>
      <td><button class="btn btn-blue viewBtn">View</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector(".viewBtn").onclick = ()=> showVoterCard(v,tr);
  });
}

function showVoterCard(v,tr){
  const existing = document.getElementById("voterDetailCard"); if(existing) existing.remove();
  const div = document.createElement("div"); div.id="voterDetailCard"; div.className="card mt-2";
  div.style.background = v.status==="approved"?"#dcfce7":v.status==="opponent"?"#fef9c3":"#fee2e2";
  div.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <h3 style="margin:0;font-weight:800">${v.name||''}</h3>
        <p style="margin:2px 0">EPIC: ${v.epic||v.voterID||''} | Father/Husband: ${v.fatherName||v.husbandName||''}</p>
      </div>
      <div>
        <button class="btn btn-red" id="closeCardBtn">Close</button>
      </div>
    </div>
    <p>House: ${v.houseNo||''} | Room: ${v.roomNo||''}</p>
    <p>Part: ${v.part||v.partNo||''} | Booth: ${v.booth||''}</p>
    <p>Polling Address: ${v.pollingAddress||''}</p>
    <p>Age: ${v.age||''} | Mobile: ${v.mobile||''}</p>
    <div class="flex gap-2 mt-2">
      <button class="btn btn-yellow" onclick="updateStatus('${v.id}','approved')">Approve</button>
      <button class="btn btn-yellow" onclick="updateStatus('${v.id}','opponent')">Opponent</button>
      <button class="btn btn-red" onclick="updateStatus('${v.id}','anti')">Anti</button>
      <button class="btn btn-blue" onclick="sendWhatsApp('${v.id}')">Send</button>
      <button class="btn btn-green" onclick="printVoter('${v.id}')">Print</button>
    </div>`;
  voterListDiv.prepend(div);
  div.querySelector("#closeCardBtn").onclick = ()=> div.remove();
}

function updateStatus(id,newStatus){
  const v = voterData.find(x=>x.id===id); if(!v) return;
  set(dbRef(db,"voters/"+id),{...v,status:newStatus});
  updateStatusCount();
}

function sendWhatsApp(id){
  const v = voterData.find(x=>x.id===id); if(!v) return;
  let msg = senderDescEl.value?senderDescEl.value+"\n\n":"";
  msg += `Name: ${v.name}\nFather/Husband: ${v.fatherName||v.husbandName||''}\nEPIC: ${v.epic||v.voterID||''}\nHouse: ${v.houseNo||''}\nPart: ${v.part||v.partNo||''} | Booth: ${v.booth||''}\nPolling: ${v.pollingAddress||''}\nRoom: ${v.roomNo||''}\nMobile: ${v.mobile||''}\nImage: ${FIXED_SENDER_IMAGE}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
}

function printVoter(id){
  const v = voterData.find(x=>x.id===id); if(!v) return;
  let html=`<div style="padding:12px;font-family:Arial">`;
  html+=`<img src="${FIXED_SENDER_IMAGE}" style="width:50px;height:50px;border-radius:50%;float:right;margin-left:6px">`;
  html+=`<h2>${v.name||''}</h2><p>Father/Husband: ${v.fatherName||v.husbandName||''}</p>`;
  html+=`<p>EPIC: ${v.epic||v.voterID||''}</p><p>House: ${v.houseNo||''} | Room: ${v.roomNo||''}</p>`;
  html+=`<p>Part: ${v.part||v.partNo||''} | Booth: ${v.booth||''}</p><p>Polling: ${v.pollingAddress||''}</p>`;
  html+=`<p>Age: ${v.age||''} | Mobile: ${v.mobile||''}</p></div>`;
  const w = window.open(); w.document.write(html); w.print(); w.close();
}

function updateStatusCount(){
  document.getElementById("countApproved").innerText = voterData.filter(v=>v.status==="approved").length;
  document.getElementById("countOpponent").innerText = voterData.filter(v=>v.status==="opponent").length;
  document.getElementById("countAnti").innerText = voterData.filter(v=>v.status==="anti").length;
}

searchInput.addEventListener("input",e=>{
  const q = e.target.value.toLowerCase();
  renderTable(voterData.filter(v=>{
    return `${v.name||''} ${v.epic||v.voterID||''} ${v.status||''}`.toLowerCase().includes(q);
  }));
});
</script>
</body>
</html>
