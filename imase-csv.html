<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF to CSV Converter (Marathi)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  input, button, select { margin: 5px 0; padding: 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  th { background: #f0f0f0; }
</style>
</head>
<body>
<h2>PDF to CSV Converter (Marathi Mix)</h2>

<input type="file" id="pdfFile" accept=".pdf">
<br>
<label>Enter CSV headers (comma separated):</label>
<input type="text" id="csvHeaders" placeholder="Serial No,ID,Part No,Name,Father Name,House No,Age,Gender,Photo">
<br>
<button onclick="processPDF()">Convert PDF â†’ CSV</button>

<div id="preview"></div>
<button id="downloadBtn" style="display:none;" onclick="downloadCSV()">Download CSV</button>

<script>
let parsedData = [];

async function processPDF() {
    const fileInput = document.getElementById('pdfFile');
    if (!fileInput.files[0]) { alert('Please upload a PDF'); return; }

    const file = fileInput.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

    let fullText = '';
    for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + '\n';
    }

    // Split text by some pattern (example: IDs start with WEH or MTX)
    let lines = fullText.split(/\s(?=WEH|MTX)/);

    parsedData = lines.map(line => line.trim()).filter(l => l.length>0);
    showPreview(parsedData);
}

function showPreview(data) {
    const previewDiv = document.getElementById('preview');
    previewDiv.innerHTML = '';

    const headers = document.getElementById('csvHeaders').value.split(',').map(h=>h.trim());
    let table = document.createElement('table');
    let tr = document.createElement('tr');
    headers.forEach(h => { let th = document.createElement('th'); th.innerText = h; tr.appendChild(th); });
    table.appendChild(tr);

    data.forEach(d=>{
        let tr = document.createElement('tr');
        headers.forEach(h=>{
            let td = document.createElement('td');
            // Simple mapping logic: user will clean manually if needed
            td.innerText = extractField(d,h);
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });

    previewDiv.appendChild(table);
    document.getElementById('downloadBtn').style.display='inline-block';
}

// Example simple extraction
function extractField(line, field){
    // Very basic, can improve for proper parsing
    if(field.toLowerCase().includes('id')){
        let match = line.match(/(WEH|MTX)\d+/);
        return match ? match[0] : '';
    }
    if(field.toLowerCase().includes('part')){
        let match = line.match(/\d{1,3}\/\d{1,3}\/\d{1,3}/);
        return match ? match[0] : '';
    }
    if(field.toLowerCase().includes('age')){
        let match = line.match(/\b\d{2}\b/);
        return match ? match[0] : '';
    }
    if(field.toLowerCase().includes('photo')){
        return line.includes('Photo Available') ? 'Available' : 'Not Available';
    }
    // For other fields, just return full line for now
    return line;
}

function downloadCSV() {
    const headers = document.getElementById('csvHeaders').value.split(',').map(h=>h.trim());
    let csv = headers.join(',') + '\n';
    parsedData.forEach(line=>{
        let row = headers.map(h => `"${extractField(line,h)}"`).join(',');
        csv += row + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'converted.csv';
    a.click();
}
</script>
</body>
</html>
