<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marathi PDF to CSV with Custom Headers</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<style>
body { font-family: Arial; padding: 20px; background: #f9f9f9; }
input, button, textarea { margin: 10px 0; padding: 10px; width: 100%; box-sizing: border-box; }
button { background: #007bff; color: white; border: none; cursor: pointer; }
button:hover { background: #0056b3; }
#preview { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fff; }
</style>
</head>
<body>

<h2>Marathi PDF/Text to CSV Converter (Custom Headers)</h2>

<label>Upload PDF or Text:</label>
<input type="file" id="fileInput" accept=".pdf,.txt">

<label>Enter CSV Headers (comma separated):</label>
<input type="text" id="csvHeader" placeholder="Serial No,ID,Part No,Name,Father/Husband Name,House No,Age,Gender,Photo Available">

<button onclick="convertPDFToCSV()">Preview Data</button>

<div id="preview"></div>

<button onclick="downloadCSV()" id="downloadBtn" style="display:none;">Download CSV</button>

<script>
let csvData = '';
let rowsData = [];

async function convertPDFToCSV() {
    const fileInput = document.getElementById('fileInput');
    if(!fileInput.files.length){ alert('Select a file'); return; }
    const file = fileInput.files[0];

    let textContent = '';
    if(file.type === 'application/pdf'){
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            textContent += text.items.map(item => item.str).join(' ') + '\n';
        }
    } else {
        textContent = await file.text();
    }

    const headers = document.getElementById('csvHeader').value.split(',').map(h=>h.trim());
    if(!headers.length){ alert('Enter CSV headers'); return; }

    // Split data by IDs (Marathi PDF में WEH/MTX format assumed)
    const voterRegex = /(WEH\d+|MTX\d+)[\s\S]*?(?=(WEH\d+|MTX\d+)|$)/g;
    const voters = [...textContent.matchAll(voterRegex)].map(m=>m[0].trim());

    rowsData = [];
    let serial = 1;

    voters.forEach(v => {
        const row = [];
        headers.forEach(header => {
            let val = '';
            const h = header.toLowerCase();
            if(h.includes('serial')) val = serial++;
            else if(h.includes('id')) {
                const idMatch = v.match(/(WEH\d+|MTX\d+)/);
                if(idMatch) val = idMatch[0];
            }
            else if(h.includes('part')) {
                const partMatch = v.match(/\d+\/\d+\/\d+/);
                if(partMatch) val = partMatch[0];
            }
            else if(h.includes('name') && !h.includes('father')) {
                const nameMatch = v.match(/मतदभरभचस\s*([^\d]+)/);
                if(nameMatch) val = nameMatch[1].trim();
            }
            else if(h.includes('father')) {
                const fatherMatch = v.match(/वडिल(?:ांचे)? नाव\s*:\s*([^\d]+)/);
                if(fatherMatch) val = fatherMatch[1].trim();
            }
            else if(h.includes('house')) {
                const houseMatch = v.match(/घर\s*क्रमांक\s*:\s*([^\d]+)/);
                if(houseMatch) val = houseMatch[1].trim();
            }
            else if(h.includes('age')) {
                const ageMatch = v.match(/\s(\d{2})\s*:/);
                if(ageMatch) val = ageMatch[1].trim();
            }
            else if(h.includes('gender')) {
                const genderMatch = v.match(/(पुरुष|स्त्री|Male|Female)/i);
                if(genderMatch) val = genderMatch[1].trim();
            }
            else if(h.includes('photo')) {
                val = v.includes('Photo Available') ? 'Available' : 'NA';
            }
            row.push(val);
        });
        rowsData.push(row);
    });

    // Preview
    const previewDiv = document.getElementById('preview');
    previewDiv.innerHTML = '<b>Detected Voters:</b><br>' + rowsData.map(r => r.join(' | ')).join('<br>');

    // Prepare CSV
    csvData = headers.join(',') + '\n' + rowsData.map(r => r.map(x=>`"${x}"`).join(',')).join('\n');

    document.getElementById('downloadBtn').style.display = 'block';
}

function downloadCSV() {
    const blob = new Blob([csvData], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'converted.csv';
    a.click();
}
</script>

</body>
</html>
