/********** CONFIG **********/
var CSV_FILE_NAME = "voters.csv"; 
var FIREBASE_MAIN_URL = "https://voter-25c94-default-rtdb.firebaseio.com/voters/";
var BATCH_SIZE = 30;   
var SLEEP_MS = 3000;   

/********** MASTER FUNCTION **********/
function RunLargeVoterUpload() {
  var ss = SpreadsheetApp.getActive();
  var sheet1 = ss.getSheetByName("Sheet1");
  var sheet2 = ss.getSheetByName("Sheet2");

  if (!sheet1 || !sheet2) {
    Logger.log("❌ Sheet1 or Sheet2 missing!");
    return;
  }

  // 1️⃣ Load CSV → Sheet1
  var csvData = loadCSVfromDrive(CSV_FILE_NAME);
  var rows = Utilities.parseCsv(csvData);

  // Check and preserve Address/Ward columns
  var header = ["SerialNo","EPIC_NO","PartNo","VoterName","RelationName","RelationType","HouseNo","Age","Gender","Address","WardNo"];
  if(sheet1.getLastRow()===0) sheet1.getRange(1,1,1,header.length).setValues([header]);
  var existingData = sheet1.getRange(2,1,sheet1.getLastRow()-1,sheet1.getLastColumn()).getValues() || [];
  
  sheet1.clear(); // clear old data
  sheet1.getRange(1,1,1,header.length).setValues([header]);
  sheet1.getRange(2,1,rows.length,rows[0].length).setValues(rows);

  Logger.log("✔ CSV loaded to Sheet1: " + rows.length + " rows");

  // 2️⃣ Load Sheet2 → PartNo range → Address + Ward mapping
  var addrData = sheet2.getDataRange().getValues();
  var rangeMap = []; // {start, end, AreaName, WardNo}

  for(var i=1;i<addrData.length;i++){
    var startPart = String(addrData[i][0]||"").trim();
    var endPart = String(addrData[i][1]||"").trim();
    var area = String(addrData[i][2]||"").trim();
    var ward = String(addrData[i][3]||"").trim();
    if(startPart && endPart && area){
      rangeMap.push({start:startPart, end:endPart, AreaName:area, WardNo:ward});
    }
  }
  Logger.log("✔ PartNo ranges loaded: "+rangeMap.length);

  // 3️⃣ Load existing EPIC from Firebase
  var existingEPICs = fetchExistingEPICsBatch();
  Logger.log("✔ Existing EPIC in Firebase: " + Object.keys(existingEPICs).length);

  // 4️⃣ Process Sheet1 rows + update Address/Ward + upload batch-wise
  var batch = [];
  var sheetData = sheet1.getDataRange().getValues();
  var updatedSheet = [];
  updatedSheet.push(header);

  var sheetEPICs = {}; // Sheet1 duplicate check

  for(var r=1;r<sheetData.length;r++){
    var row = sheetData[r];
    var EPIC = extractEPIC(row[1]);
    if(!EPIC) continue;
    if(sheetEPICs[EPIC]) continue; // skip duplicate in sheet
    sheetEPICs[EPIC] = true;

    var PartNo = extractCorrectPartNo(row);

    // find address/ward from rangeMap
    var addr = "NA", ward="NA";
    for(var j=0;j<rangeMap.length;j++){
      if(isPartNoInRange(PartNo,rangeMap[j].start,rangeMap[j].end)){
        addr = rangeMap[j].AreaName;
        ward = rangeMap[j].WardNo || "NA";
        break;
      }
    }

    // Update row for Sheet1
    var newRow = row.slice(0,9);
    newRow.push(addr);
    newRow.push(ward);
    updatedSheet.push(newRow);

    // Skip if already in Firebase
    if(existingEPICs[EPIC]) continue;

    // Prepare payload
    var payload = {
      EPIC_NO: EPIC,
      PartNo: PartNo,
      VoterName: String(row[3]||""),
      RelationName: String(row[4]||""),
      RelationType: String(row[5]||""),
      HouseNo: String(row[6]||""),
      Age: String(row[7]||""),
      Gender: String(row[8]||""),
      Address: addr,
      WardNo: ward
    };

    batch.push(payload);

    if(batch.length>=BATCH_SIZE || r===sheetData.length-1){
      uploadBatch(batch);
      batch=[];
      Utilities.sleep(SLEEP_MS);
    }
  }

  // Update Sheet1 with Address/Ward
  sheet1.clear();
  sheet1.getRange(1,1,updatedSheet.length,updatedSheet[0].length).setValues(updatedSheet);

  Logger.log("✔ Completed Upload & Sheet1 updated.");
}

/********** Load CSV **********/
function loadCSVfromDrive(fileName){
  var files = DriveApp.getFilesByName(fileName);
  if(!files.hasNext()) throw new Error("CSV not found: "+fileName);
  return files.next().getBlob().getDataAsString("UTF-8");
}

/********** Extract EPIC **********/
function extractEPIC(text){
  var match = String(text).match(/[A-Z]{3}\d{6,8}/);
  return match?match[0]:"";
}

/********** Extract PartNo **********/
function extractCorrectPartNo(row){
  var colPart = String(row[2]||"").trim();
  var colEPIC = String(row[1]||"").trim();
  if(colPart.match(/^\d+\/\d+(\/\d+)?$/)) return colPart;
  var match = colEPIC.match(/\d+\/\d+(\/\d+)?/);
  if(match) return match[0];
  return "NA";
}

/********** Check if PartNo in range **********/
function isPartNoInRange(part, start, end){
  var p = part.split("/"); var s=start.split("/"); var e=end.split("/");
  if(p.length<2 || s.length<2 || e.length<2) return false;
  if(p[0]!==s[0] || p[0]!==e[0]) return false; // main number must match
  var num = parseInt(p[1],10), sNum=parseInt(s[1],10), eNum=parseInt(e[1],10);
  return num>=sNum && num<=eNum;
}

/********** Fetch existing EPICs **********/
function fetchExistingEPICsBatch(){
  var existing={};
  try{
    var res = UrlFetchApp.fetch(FIREBASE_MAIN_URL+".json").getContentText();
    var data = JSON.parse(res)||{};
    Object.keys(data).forEach(k=>existing[k.trim()]=true);
  }catch(e){Logger.log("⚠ Error fetching Firebase: "+e);}
  return existing;
}

/********** Upload batch **********/
function uploadBatch(batch){
  batch.forEach(function(payload){
    var url = FIREBASE_MAIN_URL + payload.EPIC_NO + ".json";
    try{
      UrlFetchApp.fetch(url,{
        method:"put",
        contentType:"application/json",
        payload:JSON.stringify(payload)
      });
    }catch(e){
      Logger.log("❌ Error uploading "+payload.EPIC_NO+": "+e);
    }
  });
}
