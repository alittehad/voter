<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Search & WhatsApp Send</title>
<style>
body { font-family: Arial; margin:0; padding:15px; background:#f1f1f1; }
h2 { text-align:center; margin-bottom:15px; }
.search-box {
    width:100%; padding:12px; font-size:18px;
    border:2px solid #444; border-radius:6px; margin-bottom:10px;
}
.voter-card {
    background:white; padding:12px; margin:5px 0;
    border-radius:6px; cursor:pointer; border-left:4px solid #007bff;
    box-shadow:0 0 3px #aaa;
}
.popup {
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center;
}
.popup-box {
    background:white; padding:20px; width:90%;
    max-width:450px; border-radius:10px;
    box-shadow:0 0 10px black;
    position:relative;
    max-height:90vh;
    overflow-y:auto;
}
.close-btn {
    background:red; color:white; padding:8px 14px;
    border:0; border-radius:6px; float:right;
    cursor:pointer;
}
.btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; margin-right:10px; color:white; margin-top:8px; }
.btn-print { background:#007bff; }
.btn-send { background:#25d366; }
.btn-download { background:#ff9800; }
#senderMsg { width:100%; height:80px; margin-top:10px; padding:8px; border-radius:6px; border:2px solid #aaa; }
</style>
</head>
<body>

<h2>üîç Voter Search</h2>
<input type="text" id="searchInput" class="search-box" placeholder="Search by Name / EPIC / Address / Age / Gender">
<div id="voterList"></div>

<div id="popup" class="popup">
    <div class="popup-box" id="popupBoxContent">
        <button class="close-btn" onclick="closePopup()">Close</button>
        <div id="popupContent"></div>
        <p><b>Your Message:</b></p>
        <textarea id="senderMsg" placeholder="Type your message here..."></textarea><br>
        <button class="btn btn-send" onclick="sendMessage()">Send WhatsApp</button>
        <button class="btn btn-print" onclick="printCard()">Print</button>
        <button class="btn btn-download" onclick="downloadPDF()">Download PDF</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters = [];
let activeVoter = null;

// ----- Sheet2 Mapping -----
// Replace this with your actual Sheet2 data
const areaMapping = [
  {from:"272/165", to:"272/235", address:"‡§ß‡§æ‡§®‡•Ä‡§µ‡§ó‡§æ‡§Ç‡§µ‡§¨‡§æ-‡§π‡§æ‡§ö‡§æ‡§™‡§æ‡§°‡§æ‡§ß‡§æ‡§®‡•Ä‡§µ‡§π‡§∞‡§µ‡§ü‡•á", ward:"8"},
  {from:"272/236", to:"272/300", address:"Another Area", ward:"9"}
];

// Check if PartNo is in range
function isPartInRange(part, from, to){
    const partNum = parseInt(part.split("/")[1]);
    const fromNum = parseInt(from.split("/")[1]);
    const toNum = parseInt(to.split("/")[1]);
    return partNum >= fromNum && partNum <= toNum;
}

// Load voters from Firebase
db.ref("voters").once("value").then(snapshot => {
    const data = snapshot.val() || {};
    voters = Object.keys(data).map(key => {
        const v = data[key];
        let address = (v.HouseNo && v.HouseNo!=="NA") ? v.HouseNo : (v.Address || "‚Äî");
        let ward = v.WardNo && v.WardNo!=="NA" ? v.WardNo : "‚Äî";
        const partNo = v.PartNo || "";

        // Map Address + Ward from Sheet2
        for(let m of areaMapping){
            if(partNo && isPartInRange(partNo, m.from, m.to)){
                address = m.address;
                ward = m.ward;
                break;
            }
        }

        return {
            key: key,
            epic_no: v.EPIC_NO || key,
            voter_full_name: v.VoterName || "",
            sl_no_in_part: v.PartNo || "",
            serial_no: v.SerialNo || "",
            address: address,
            ward: ward,
            relation_name: v.RelationName || "",
            relation_type: v.RelationType || "",
            age: v.Age || "",
            gender: v.Gender || ""
        };
    });

    document.getElementById("searchInput").addEventListener("keyup", ()=>{
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        if(!q){ document.getElementById("voterList").innerHTML=""; return; }

        const filtered = voters.filter(v=>
            (v.voter_full_name||"").toLowerCase().includes(q) ||
            (v.epic_no||"").toLowerCase().includes(q) ||
            (v.address||"").toLowerCase().includes(q) ||
            (v.ward||"").toLowerCase().includes(q) ||
            (v.age||"").toLowerCase().includes(q) ||
            (v.gender||"").toLowerCase().includes(q)
        );
        displayList(filtered);
    });
});

// Display List
function displayList(list){
    const box = document.getElementById("voterList");
    box.innerHTML = "";
    list.forEach(v => {
        const div = document.createElement("div");
        div.className = "voter-card";
        div.innerHTML = `<b>${v.voter_full_name}</b> - ${v.epic_no}<br>${v.address || "‚Äî"}<br>Ward: ${v.ward}<br>${v.age} / ${v.gender}`;
        div.onclick = ()=>openPopup(v);
        box.appendChild(div);
    });
}

// Popup Card
function openPopup(v){
    activeVoter = v;
    document.getElementById("popupContent").innerHTML = `
        <h3>${v.voter_full_name}</h3>
        <b>EPIC:</b> ${v.epic_no}<br>
        <b>Part/Serial:</b> ${v.sl_no_in_part}<br>
        <b>Address:</b><br>${v.address || "‚Äî"}<br>
        <b>Ward:</b> ${v.ward}<br>
        <b>Relation:</b> ${v.relation_type} : ${v.relation_name || "NA"}<br>
        <b>Age/Gender:</b> ${v.age || "‚Äî"} / ${v.gender || "‚Äî"}<br>
    `;
    document.getElementById("senderMsg").value = "";
    document.getElementById("popup").style.display = "flex";
}
function closePopup(){ document.getElementById("popup").style.display="none"; activeVoter=null; }

// WhatsApp Message
function sendMessage(){
    if(!activeVoter) return alert("No voter selected!");
    const msg = document.getElementById("senderMsg").value.trim();
    if(!msg) return alert("Type a message first!");
    const text = encodeURIComponent(
`VOTER CARD DETAILS
--------------------------
Name: ${activeVoter.voter_full_name}
EPIC: ${activeVoter.epic_no}
Part/Serial: ${activeVoter.sl_no_in_part}
Address: ${activeVoter.address || "‚Äî"}
Ward: ${activeVoter.ward}
Relation: ${activeVoter.relation_type} : ${activeVoter.relation_name || "NA"}
Age/Gender: ${activeVoter.age || "‚Äî"} / ${activeVoter.gender || "‚Äî"}

Your Message:
${msg}`
    );
    window.location.href = `https://wa.me/?text=${text}`;
}

// Print Card
function printCard(){
    if(!activeVoter) return;
    const content = document.getElementById("popupContent").innerHTML;
    const win = window.open("", "Print", "height=600,width=400");
    win.document.write(`<html><head><title>Voter Card</title></head><body>${content}</body></html>`);
    win.document.close();
    win.print();
}

// Download PDF
function downloadPDF(){
    if(!activeVoter) return;
    const element = document.getElementById("popupContent");
    html2pdf().set({
        margin:0.2,
        filename:`${activeVoter.voter_full_name}_VoterCard.pdf`,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2},
        jsPDF:{unit:'in',format:'letter',orientation:'portrait'}
    }).from(element).save();
}
</script>
</body>
</html>
