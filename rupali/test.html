<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h2{text-align:center;margin:5px 0}
#searchBox{width:100%;padding:10px;font-size:16px;border-radius:6px;border:1px solid #888}

.card{
  background:#fff;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
  border-left:6px solid #007bff;
  cursor:pointer;
}
.card small{color:#555}

#results{margin-top:10px}

#popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
}
.popup-content{
  background:#fff;
  padding:15px;
  width:95%;
  max-width:380px;
  border-radius:8px;
  position:relative;
}
.close{
  position:absolute;top:8px;right:10px;
  background:#dc3545;color:#fff;border:none;
  padding:5px 8px;border-radius:4px
}

.color-btn{
  width:26px;height:26px;border-radius:50%;
  border:2px solid #ccc;margin-right:6px;cursor:pointer
}

textarea{width:100%;height:70px}

.btn{
  padding:8px 12px;margin-top:6px;border:none;
  border-radius:5px;color:#fff;cursor:pointer;width:100%
}
.green{background:#28a745}
.blue{background:#007bff}
.red{background:#dc3545}
.whatsapp{background:#25d366}

@media print{
  body{background:#fff;padding:0}
  #popup,.close,.btn,.color-btn,textarea,input{display:none!important}
  .print-area{
    width:58mm;
    font-size:12px;
    line-height:1.3;
  }
}
</style>
</head>

<body>

<h2>‡§Æ‡§§‡§¶‡§æ‡§∞ ‡§∂‡•ã‡§ß</h2>
<input id="searchBox" placeholder="‡§®‡§æ‡§µ ‡§ï‡§ø‡§Ç‡§µ‡§æ EPIC ‡§®‡§Ç‡§¨‡§∞ ‡§ü‡§æ‡§ï‡§æ">
<div id="results">Loading...</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-content print-area">
    <button class="close" onclick="closePopup()">X</button>

    <h3 id="p_name"></h3>
    <p><b>EPIC:</b> <span id="p_epic"></span></p>
    <p><b>‡§ò‡§∞ ‡§®‡§Ç:</b> <span id="p_house"></span></p>
    <p><b>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</b> <span id="p_area"></span></p>
    <p><b>‡§∏‡§Ç‡§¨‡§Ç‡§ß:</b> <span id="p_relation"></span></p>
    <p><b>‡§â‡§Æ‡•ç‡§∞ / ‡§≤‡§ø‡§Ç‡§ó:</b> <span id="p_age"></span> / <span id="p_gender"></span></p>

    <hr>
    <b>‡§∞‡§Ç‡§ó ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§ø‡§Ç‡§ó:</b><br>
    <button class="color-btn" style="background:red" onclick="saveColor('red')"></button>
    <button class="color-btn" style="background:green" onclick="saveColor('green')"></button>
    <button class="color-btn" style="background:blue" onclick="saveColor('blue')"></button>

    <hr>
    <textarea id="msg" placeholder="‡§ü‡•Ä‡§™ ‡§≤‡§ø‡§π‡§æ..."></textarea>
    <button class="btn green" onclick="saveMsg()">Save</button>
    <button class="btn red" onclick="deleteMsg()">Delete</button>

    <hr>
    <button class="btn blue" onclick="printCard()">Print</button>
    <button class="btn whatsapp" onclick="sendWhatsApp()">WhatsApp</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters=[],active=null,page=1;
const PAGE_SIZE=50;

db.ref("voters").on("value",snap=>{
  const d=snap.val()||{};
  voters=Object.keys(d).map(k=>({
    key:k,
    name:d[k].VoterName||"",
    epic:d[k].EPIC_NO||k,
    age:d[k].Age||"",
    gender:d[k].Gender||"",
    house:d[k].HouseNo||"",
    area:d[k].Area||"",
    relation:(d[k].RelationName||"")+" "+(d[k].RelationType||""),
    color:d[k].color||"",
    message:d[k].message||""
  }));
  render(true);
});

function render(reset){
  const q=searchBox.value.toLowerCase();
  if(reset){page=1;results.innerHTML=""}
  const list=voters.filter(v=>!q||v.name.toLowerCase().includes(q)||v.epic.toLowerCase().includes(q));
  list.slice((page-1)*PAGE_SIZE,page*PAGE_SIZE).forEach(v=>{
    const d=document.createElement("div");
    d.className="card";
    d.style.borderLeftColor=v.color||"#007bff";
    d.innerHTML=`<b>${v.name}</b><br><small>EPIC: ${v.epic}</small>`;
    d.onclick=()=>openPopup(v);
    results.appendChild(d);
  });
  if(page*PAGE_SIZE<list.length)page++;
}

searchBox.oninput=()=>render(true);
window.onscroll=()=>{if(innerHeight+scrollY>=document.body.offsetHeight-150)render()};

function openPopup(v){
  active=v;
  p_name.innerText=v.name;
  p_epic.innerText=v.epic;
  p_house.innerText=v.house;
  p_area.innerText=v.area;
  p_relation.innerText=v.relation;
  p_age.innerText=v.age;
  p_gender.innerText=v.gender;
  msg.value=v.message;
  popup.style.display="flex";
}
function closePopup(){popup.style.display="none"}

function saveColor(c){
  active.color=c;
  db.ref("voters/"+active.key+"/color").set(c);
}
function saveMsg(){
  db.ref("voters/"+active.key+"/message").set(msg.value);
  alert("Saved");
}
function deleteMsg(){
  msg.value="";
  db.ref("voters/"+active.key+"/message").remove();
}

function printCard(){
  window.print();
}

function sendWhatsApp(){
  const text=`‚è∞ ‡§ò‡§°‡•Ä‡§≤‡§æ ‡§≠‡§∞‡§ò‡•ã‡§∏ ‡§Æ‡§§ ‡§¶‡•á‡§ä‡§® ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§ï‡§∞‡§æ!
üïí ‡§ò‡§°‡•Ä ‡§π‡•á‡§ö ‡§Ü‡§™‡§≤‡•á ‡§ö‡§ø‡§®‡•ç‡§π

‡§Æ‡§§‡§¶‡§æ‡§∞: ${active.name}
EPIC: ${active.epic}
‡§ò‡§∞ ‡§®‡§Ç: ${active.house}

‡§Ü‡§™‡§≤‡§æ ‡§¨‡§π‡•Å‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§§‡§¶‡§æ‡§®‡§æ‡§ö‡§æ ‡§π‡§ï‡•ç‡§ï ‡§®‡§ï‡•ç‡§ï‡•Ä ‡§¨‡§ú‡§æ‡§µ‡§æ üôè`;
  window.open("https://wa.me/?text="+encodeURIComponent(text));
}
</script>

</body>
</html>
