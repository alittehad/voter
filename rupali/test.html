<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h2{text-align:center}
#searchBox{width:100%;padding:10px;font-size:16px;border-radius:6px;border:1px solid #888}

.card{
  background:#fff;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
  border-left:5px solid #007bff;
  cursor:pointer;
}
.card:hover{background:#f9f9f9}
#results{margin-top:10px}

/* POPUP */
#popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
  z-index:999;
}
.popup-content{
  background:#fff;
  padding:12px;
  width:95%;
  max-width:400px;
  border-radius:8px;
  position:relative;
}
.close{
  position:absolute;
  top:6px;right:8px;
  background:red;color:#fff;
  border:none;padding:4px 7px;
  cursor:pointer;
}

.color-btn{
  width:25px;height:25px;
  border-radius:5px;border:none;
  margin-right:5px;cursor:pointer
}
textarea{width:100%;height:60px}

.btn{
  padding:7px 12px;margin-top:6px;
  border:none;border-radius:5px;
  color:#fff;cursor:pointer
}
.green{background:#28a745}
.blue{background:#007bff}
.red{background:#dc3545}
.whatsapp{background:#25d366}

/* ===== PRINT FIX (MOST IMPORTANT) ===== */
@media print{
  body *{
    visibility:hidden;
  }
  .print-area, .print-area *{
    visibility:visible;
  }
  .print-area{
    position:absolute;
    left:0; top:0;
    width:58mm;
    font-size:12px;
    line-height:1.4;
    text-align:center;
  }
  @page{
    margin:5mm;
    size:auto;
  }
}
</style>
</head>

<body>

<h2>Voter Search</h2>
<input id="searchBox" placeholder="‡§®‡§æ‡§Æ ‡§Ø‡§æ EPIC ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç">
<div id="results">Loading...</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-content">
    <button class="close" onclick="closePopup()">X</button>

    <!-- PRINT AREA -->
    <div class="print-area">
      <h3 id="p_name"></h3>
      <p><b>EPIC:</b> <span id="p_epic"></span></p>
      <p><b>‡§ò‡§∞ ‡§®‡§Ç:</b> <span id="p_house"></span></p>
      <p><b>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</b> <span id="p_area"></span></p>
      <p><b>‡§â‡§Æ‡•ç‡§∞ / ‡§≤‡§ø‡§Ç‡§ó:</b> <span id="p_age"></span> / <span id="p_gender"></span></p>

      <hr>
      <div style="font-size:28px">üïí</div>
      <div style="font-weight:bold">
        ‡§ò‡§°‡•Ä‡§≤‡§æ ‡§≠‡§∞‡§ò‡•ã‡§∏ ‡§Æ‡§§ ‡§¶‡•á‡§ä‡§® ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§ï‡§∞‡§æ
      </div>
      <div style="font-size:11px">
        ‡§Ü‡§™‡§≤‡§æ ‡§¨‡§π‡•Å‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§§‡§¶‡§æ‡§®‡§æ‡§ö‡§æ ‡§π‡§ï‡•ç‡§ï ‡§¨‡§ú‡§æ‡§µ‡§æ
      </div>
    </div>

    <hr>
    <button class="color-btn" style="background:red" onclick="saveColor('red')"></button>
    <button class="color-btn" style="background:green" onclick="saveColor('green')"></button>
    <button class="color-btn" style="background:blue" onclick="saveColor('blue')"></button>

    <hr>
    <textarea id="msg" placeholder="Note..."></textarea><br>
    <button class="btn green" onclick="saveMsg()">Save</button>
    <button class="btn red" onclick="deleteMsg()">Delete</button>

    <hr>
    <button class="btn blue" onclick="printCard()">Print</button>
    <button class="btn whatsapp" onclick="sendWhatsApp()">WhatsApp</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain:"voter-25c94.firebaseapp.com",
  databaseURL:"https://voter-25c94-default-rtdb.firebaseio.com",
  projectId:"voter-25c94"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let voters=[],active=null;
let page=1,PAGE_SIZE=50,loading=false;

db.ref("voters").once("value").then(s=>{
  const d=s.val()||{};
  voters=Object.keys(d).map(k=>({
    name:String(d[k].VoterName||""),
    epic:String(d[k].EPIC_NO||k),
    age:String(d[k].Age||""),
    gender:String(d[k].Gender||""),
    house:String(d[k].HouseNo||""),
    area:String(d[k].Area||""),
    color:d[k].color||"",
    message:d[k].message||""
  }));
  render(true);
});

function render(reset=false){
  if(reset){page=1;results.innerHTML=""}
  if(loading)return;
  loading=true;

  const q=searchBox.value.toLowerCase();
  const list=voters.filter(v=>!q||v.name.toLowerCase().includes(q)||v.epic.toLowerCase().includes(q));

  list.slice((page-1)*PAGE_SIZE,page*PAGE_SIZE).forEach(v=>{
    const d=document.createElement("div");
    d.className="card";
    d.style.borderLeftColor=v.color||"#007bff";
    d.innerHTML=`<b>${v.name}</b><br>EPIC: ${v.epic}`;
    d.onclick=()=>openPopup(v);
    results.appendChild(d);
  });

  if(page*PAGE_SIZE<list.length)page++;
  loading=false;
}

searchBox.oninput=()=>render(true);
window.onscroll=()=>window.innerHeight+scrollY>=document.body.offsetHeight-150&&render();

function openPopup(v){
  active=v;
  p_name.innerText=v.name;
  p_epic.innerText=v.epic;
  p_house.innerText=v.house;
  p_area.innerText=v.area;
  p_age.innerText=v.age;
  p_gender.innerText=v.gender;
  msg.value=v.message;
  popup.style.display="flex";
}
function closePopup(){popup.style.display="none"}

function saveColor(c){
  active.color=c;
  db.ref("voters/"+active.epic+"/color").set(c);
}
function saveMsg(){
  active.message=msg.value;
  db.ref("voters/"+active.epic+"/message").set(msg.value);
  alert("Saved");
}
function deleteMsg(){
  msg.value="";
  db.ref("voters/"+active.epic+"/message").remove();
}

function printCard(){
  if(!active){alert("Voter select kare");return;}
  setTimeout(()=>window.print(),300);
}

function sendWhatsApp(){
  const t=`üïí ‡§ò‡§°‡•Ä‡§≤‡§æ ‡§≠‡§∞‡§ò‡•ã‡§∏ ‡§Æ‡§§ ‡§¶‡•á‡§ä‡§® ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§ï‡§∞‡§æ
‡§®‡§æ‡§µ: ${active.name}
EPIC: ${active.epic}
‡§ò‡§∞ ‡§®‡§Ç: ${active.house}
‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${active.area}`;
  window.open("https://wa.me/?text="+encodeURIComponent(t));
}
</script>

</body>
</html>
