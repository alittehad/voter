<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter List</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;background:#f2f2f2;margin:0;padding:10px;}
h2{text-align:center;}
#searchBox{width:100%;padding:10px;font-size:16px;border-radius:6px;border:1px solid #888;}
.card{background:#fff;padding:10px;margin:8px 0;border-radius:6px;border-left:5px solid #007bff;cursor:pointer;}
.card:hover{background:#f9f9f9;}
#results{margin-top:10px;}
#loading{text-align:center;color:#555;margin-top:10px;}
#popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;overflow:auto;}
.popup-content{background:#fff;padding:15px;width:95%;max-width:400px;border-radius:8px;position:relative;}
.close{position:absolute;top:8px;right:10px;background:red;color:#fff;border:none;padding:5px 8px;cursor:pointer;}
.color-btn{width:25px;height:25px;border-radius:5px;border:none;margin-right:5px;cursor:pointer;}
.color-btn.active{border:3px solid #000;}
textarea{width:100%;height:70px;margin-top:5px;}
.btn{padding:7px 12px;margin-top:6px;border:none;border-radius:5px;color:#fff;cursor:pointer;}
.green{background:#28a745;}
.blue{background:#007bff;}
.red{background:#dc3545;}
.whatsapp{background:#25d366;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:8px 12px;border-radius:6px;opacity:0.9;z-index:9999;}
</style>
</head>
<body>

<h2>Voter Search</h2>
<input id="searchBox" placeholder="‡§®‡§æ‡§Æ ‡§Ø‡§æ EPIC ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç">
<div id="results"></div>
<div id="loading">Loading...</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-content">
    <button class="close" onclick="closePopup()">X</button>
    <h3 id="p_name"></h3>
    <p><b>EPIC:</b> <span id="p_epic"></span></p>
    <p><b>‡§ò‡§∞ ‡§®‡§Ç:</b> <span id="p_house"></span></p>
    <p><b>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</b> <span id="p_area"></span></p>
    <p><b>‡§∏‡§Ç‡§¨‡§Ç‡§ß:</b> <span id="p_relation"></span></p>
    <p><b>‡§â‡§Æ‡•ç‡§∞ / ‡§≤‡§ø‡§Ç‡§ó:</b> <span id="p_age"></span> / <span id="p_gender"></span></p>
    <hr>
    <button class="color-btn" style="background:red" onclick="saveColor('red', this)"></button>
    <button class="color-btn" style="background:green" onclick="saveColor('green', this)"></button>
    <button class="color-btn" style="background:blue" onclick="saveColor('blue', this)"></button>
    <hr>
    <textarea id="msg"></textarea><br>
    <button class="btn green" onclick="saveMsg()">Save</button>
    <button class="btn red" onclick="deleteMsg()">Delete</button>
    <hr>
    <button class="btn blue" onclick="printCard()">Print</button>
    <button class="btn whatsapp" onclick="sendWhatsApp()">WhatsApp</button>
  </div>
</div>

<div id="toast" class="toast" style="display:none;"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters = [], active = null;
let page = 1, PAGE_SIZE = 50;

// Toast notification
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display="block";
  setTimeout(()=>{ t.style.display="none"; }, 2000);
}

// Load data
function loadData(){
  document.getElementById("loading").style.display = "block";
  db.ref("voters").once("value").then(snap=>{
    const data = snap.val() || {};
    voters = Object.keys(data).map(k=>({
      key:k,
      name:String(data[k].VoterName||""),
      epic:String(data[k].EPIC_NO||k),
      age:String(data[k].Age||""),
      gender:String(data[k].Gender||""),
      house:String(data[k].HouseNo||""),
      area:String(data[k].Area||""),
      relation:String(data[k].RelationName||"")+" ("+String(data[k].RelationType||"")+")",
      color:String(data[k].color||""),
      message:String(data[k].message||"")
    }));
    document.getElementById("loading").style.display = "none";
    render(true);
  }).catch(err=>{
    console.error("Firebase error:", err);
    document.getElementById("results").innerHTML="Failed to load data";
    document.getElementById("loading").style.display="none";
  });
}

// Render function
function render(reset=false){
  const res = document.getElementById("results");
  const q = document.getElementById("searchBox").value.toLowerCase();
  if(reset){ page=1; res.innerHTML=""; }
  if(!voters || voters.length===0){ res.innerHTML="No data found"; return; }
  const list = voters.filter(v=> q==="" || v.name.toLowerCase().includes(q) || v.epic.toLowerCase().includes(q));
  const start=(page-1)*PAGE_SIZE, end=page*PAGE_SIZE;
  const chunk = list.slice(start,end);
  chunk.forEach(v=>{
    const d = document.createElement("div");
    d.className="card";
    d.innerHTML=`<b>${v.name}</b><br>EPIC: ${v.epic}`;
    d.onclick = ()=>openPopup(v);
    res.appendChild(d);
  });
  if(end<list.length) page++;
}

// Search
let debounceTimer;
document.getElementById("searchBox").addEventListener("input", ()=>{
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(()=>render(true),300);
});

// Infinite scroll
window.addEventListener("scroll", ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 150){
    render(false);
  }
});

// Popup
function openPopup(v){
  active=v;
  document.getElementById("p_name").innerText=v.name;
  document.getElementById("p_epic").innerText=v.epic;
  document.getElementById("p_house").innerText=v.house;
  document.getElementById("p_area").innerText=v.area;
  document.getElementById("p_relation").innerText=v.relation;
  document.getElementById("p_age").innerText=v.age;
  document.getElementById("p_gender").innerText=v.gender;
  document.getElementById("msg").value=v.message;
  document.getElementById("popup").style.display="flex";

  document.querySelectorAll(".color-btn").forEach(btn=>btn.classList.remove("active"));
  if(v.color){
    const btn = Array.from(document.querySelectorAll(".color-btn")).find(b=>b.style.background===v.color);
    if(btn) btn.classList.add("active");
  }
}
function closePopup(){document.getElementById("popup").style.display="none";}

// Save/Delete color/message
function saveColor(c, btn){
  if(!active) return;
  active.color = c;
  db.ref("voters/"+active.epic+"/color").set(c).then(()=>showToast("Color saved")).catch(()=>showToast("Save failed"));
  document.querySelectorAll(".color-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function saveMsg(){
  if(!active) return;
  const val = document.getElementById("msg").value;
  active.message = val;
  db.ref("voters/"+active.epic+"/message").set(val).then(()=>showToast("Saved")).catch(()=>showToast("Save failed"));
}
function deleteMsg(){
  if(!active) return;
  document.getElementById("msg").value="";
  db.ref("voters/"+active.epic+"/message").remove().then(()=>showToast("Deleted")).catch(()=>showToast("Delete failed"));
}

// Print
function printCard(){
  const senderName = firebase.auth().currentUser?.displayName || "‡§Ü‡§™‡§≤‡•á ‡§®‡§æ‡§µ";
  const w = window.open("");
  w.document.write(`
  <html><head><title>Voter Card</title>
  <style>
    @media print{body{margin:0;padding:0;zoom:90%;}}
    body{font-family:Arial,sans-serif;text-align:center;padding:20px;}
    h2{font-size:24px;font-weight:bold;margin-bottom:5px;}
    p{font-size:18px;margin:5px 0;}
    .clock-icon{font-size:120px;margin:15px;}
    hr{margin:15px 0;}
  </style>
  </head><body>
    <div class="clock-icon">üïí</div>
    <h2>${active.name}</h2>
    <p><b>EPIC:</b> ${active.epic}</p>
    <p><b>‡§ò‡§∞ ‡§®‡§Ç:</b> ${active.house}</p>
    <p><b>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</b> ${active.area}</p>
    <p><b>‡§∏‡§Ç‡§¨‡§Ç‡§ß:</b> ${active.relation}</p>
    <p><b>‡§â‡§Æ‡•ç‡§∞ / ‡§≤‡§ø‡§Ç‡§ó:</b> ${active.age} / ${active.gender}</p>
    <hr>
    <p style="font-size:20px;font-weight:bold;">‚è∞ ‡§ò‡§°‡•Ä ‡§ï‡•ã ‡§ú‡§ø‡§§‡§æ‡§Ø‡•á, ‡§Ü‡§™‡§≤‡§æ ‡§Ü‡§™‡§≤‡§æ ‡§¨‡§π‡•Å‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§§ ‡§¶‡•á‡§ä‡§®</p>
    <p style="margin-top:10px;font-size:16px;">Sender: ${senderName}</p>
    <script>window.print();</script>
  </body></html>`);
}

// WhatsApp
function sendWhatsApp(){
  const senderName = firebase.auth().currentUser?.displayName || "‡§Ü‡§™‡§≤‡•á ‡§®‡§æ‡§µ";
  const t = `üïí ‡§ò‡§°‡•Ä ‡§ï‡•ã ‡§ú‡§ø‡§§‡§æ‡§Ø‡•á, ‡§Ü‡§™‡§≤‡§æ ‡§Ü‡§™‡§≤‡§æ ‡§¨‡§π‡•Å‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§§ ‡§¶‡•á‡§ä‡§®
‡§µ‡•ã‡§ü‡§∞: ${active.name}
EPIC: ${active.epic}
‡§ò‡§∞ ‡§®‡§Ç: ${active.house}
‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${active.area}
‡§∏‡§Ç‡§¨‡§Ç‡§ß: ${active.relation}
‡§â‡§Æ‡•ç‡§∞ / ‡§≤‡§ø‡§Ç‡§ó: ${active.age} / ${active.gender}
Sender: ${senderName}`;
  window.open("https://wa.me/?text="+encodeURIComponent(t));
}

// Initial load
loadData();
</script>

</body>
</html>
