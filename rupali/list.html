<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List</title>
<style>
body { font-family: Arial; margin:0; padding:10px; background:#f1f1f1; }
h2 { text-align:center; margin-bottom:15px; }
#searchBox { width:100%; padding:10px; border:2px solid #999; border-radius:6px; font-size:18px; margin-bottom:15px; }
.result-item { padding:10px; margin:5px 0; background:white; border-radius:6px; border-left:5px solid #007bff; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
.voter-color-tag { width:20px; height:20px; border-radius:4px; display:inline-block; }

#card { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:flex-start; padding:20px; overflow-y:auto; z-index:999; }
.card-content{ background:white; padding:15px; border-radius:10px; max-width:450px; width:95%; position:relative; }
.close-btn{ position:absolute; top:10px; right:10px; background:red; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; }
.color-btn { width:30px; height:30px; border-radius:6px; border:none; margin-right:8px; cursor:pointer; }
.color-btn.active { border:3px solid #000; }
#msg { width:100%; height:80px; padding:8px; border:2px solid #aaa; border-radius:6px; }
.btn-small { padding:8px 15px; border:none; border-radius:6px; margin-right:10px; cursor:pointer; color:white; }
.btn-save { background:#28a745; }
.btn-del { background:#dc3545; }
.btn-print { background:#007bff; }
.btn-whatsapp { background:#25d366; }
.btn-download { background:#6a1b9a; }

#loadMore { display:block; margin:10px auto; padding:10px 15px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; }

@media print {
  body, .card-content {
      width: 100%;
      max-width: 200px;
      font-size: 10px;
      padding: 2px;
      margin: 0 auto;
  }
  img { max-width:50px; height:auto; }
  pre { white-space: pre-wrap; word-break: break-word; }
  hr { border:1px solid #000; }
}
</style>
</head>
<body>

<h2>Voter Search</h2>
<input type="text" id="searchBox" placeholder="Type name or EPIC to search..." />
<div id="results">Loading voters...</div>
<button id="loadMore" style="display:none;" onclick="loadMore()">Load More</button>

<!-- CARD -->
<div id="card">
  <div class="card-content">
    <button class="close-btn" onclick="closeCard()">X</button>
    <h3 id="vname"></h3>
    <p><b>EPIC:</b> <span id="vepic"></span></p>
    <p><b>Serial/Part:</b> <span id="vserial"></span></p>
    <p><b>Area:</b> <span id="varea"></span></p>
    <p><b>House No:</b> <span id="vhouse"></span></p>
    <p><b>Relation:</b> <span id="vrelation"></span></p>
    <p><b>Age/Gender:</b> <span id="vage"></span> / <span id="vgender"></span></p>
    <p><b>Saved Color:</b> <span class="voter-color-tag" id="colortag"></span></p>

    <hr>
    <p><b>Change Color:</b></p>
    <button class="color-btn" style="background:#ff4444" onclick="saveColor('#ff4444', this)"></button>
    <button class="color-btn" style="background:#44cc44" onclick="saveColor('#44cc44', this)"></button>
    <button class="color-btn" style="background:#4477ff" onclick="saveColor('#4477ff', this)"></button>

    <hr>
    <p><b>Sender Message:</b></p>
    <textarea id="msg"></textarea>
    <button class="btn-small btn-save" onclick="saveMessage()">Save</button>
    <button class="btn-small btn-del" onclick="deleteMessage()">Delete</button>

    <hr>
    <button class="btn-small btn-print" onclick="printCard()">Print</button>
    <button class="btn-small btn-whatsapp" onclick="sendWhatsApp()">Send</button>
    <button class="btn-small btn-download" onclick="downloadPDF()">Download</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters = [];
let activeVoter = null;
let displayedCount = 20;

// Fetch voters
db.ref("voters").once("value")
.then(snap => {
    const data = snap.val() || {};
    voters = Object.keys(data).map(key => ({
        key: key,
        epic_no: data[key].EPIC_NO || key,
        voter_full_name: data[key].VoterName || "NA",
        search_name: data[key].search_name || data[key].VoterName || "",
        sl_no_in_part: data[key].PartNo || "NA",
        area: data[key].Area || "NA",
        house_no: data[key].HouseNo || "NA",
        ward: data[key].Ward || "NA",
        relation_name: data[key].RelationName || "NA",
        relation_type: data[key].RelationType || "NA",
        age: data[key].Age || "NA",
        gender: data[key].Gender || "NA",
        color: data[key].color || "#ffffff",
        message: data[key].message || ""
    }));
    renderResults();
})
.catch(err => {
    console.error("Firebase error:", err);
    document.getElementById("results").innerHTML = "<p>Error loading voter data!</p>";
});

// Render results
function renderResults(reset=false){
    const q = document.getElementById("searchBox").value.trim().toLowerCase();
    let filtered = voters.filter(v => {
        const name = (v.voter_full_name || "").toLowerCase();
        const epic = (v.epic_no || "").toLowerCase();
        const sname = (v.search_name || "").toLowerCase();
        return q==="" ? true : name.includes(q) || epic.includes(q) || sname.includes(q);
    });

    if(reset) displayedCount = 20;

    let display = filtered.slice(0, displayedCount);
    let html = "";
    if(display.length===0){
        html="<p>No voters found</p>";
    } else {
        display.forEach(v=>{
            html+=`<div class="result-item" onclick="openCard('${v.key}')">
                    <span><b>${v.voter_full_name}</b> (${v.epic_no})</span>
                    <span class="voter-color-tag" style="background:${v.color || '#fff'}"></span>
                  </div>`;
        });
    }
    document.getElementById("results").innerHTML = html;
    document.getElementById("loadMore").style.display = (displayedCount < filtered.length) ? "block" : "none";
}

// Load more function
function loadMore(){
    displayedCount += 20;
    renderResults();
}

// Live search
document.getElementById("searchBox").addEventListener("input", ()=>renderResults(true));

// Card open / close
function openCard(key){
    activeVoter = voters.find(v=>v.key===key);
    if(!activeVoter) return;

    document.getElementById("vname").innerText = activeVoter.voter_full_name;
    document.getElementById("vepic").innerText = activeVoter.epic_no;
    document.getElementById("vserial").innerText = activeVoter.sl_no_in_part;
    document.getElementById("varea").innerText = activeVoter.area;
    document.getElementById("vhouse").innerText = activeVoter.house_no;
    document.getElementById("vrelation").innerText = `${activeVoter.relation_name} (${activeVoter.relation_type})`;
    document.getElementById("vage").innerText = activeVoter.age;
    document.getElementById("vgender").innerText = activeVoter.gender;
    document.getElementById("colortag").style.background = activeVoter.color;
    document.getElementById("msg").value = activeVoter.message;

    document.querySelectorAll(".color-btn").forEach(btn=>{
        btn.classList.remove("active");
        if(btn.style.background === activeVoter.color) btn.classList.add("active");
    });

    document.getElementById("card").style.display = "flex";
}
function closeCard(){ document.getElementById("card").style.display="none"; }
document.getElementById("card").addEventListener("click", e=>{
    if(e.target.id === "card") closeCard();
});

// Color / Message
function saveColor(c, btn){
    if(!activeVoter) return;
    activeVoter.color=c;
    db.ref("voters/"+activeVoter.key+"/color").set(c);
    document.getElementById("colortag").style.background=c;
    document.querySelectorAll(".color-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    renderResults();
}
function saveMessage(){
    if(!activeVoter) return;
    activeVoter.message=document.getElementById("msg").value;
    db.ref("voters/"+activeVoter.key+"/message").set(activeVoter.message);
    alert("Message saved!");
}
function deleteMessage(){
    if(!activeVoter) return;
    db.ref("voters/"+activeVoter.key+"/message").remove();
    document.getElementById("msg").value="";
    alert("Message deleted!");
}

// Print / WhatsApp / Download
function printCard(){
    if(!activeVoter) return;
    let content=`<div style="text-align:center;font-family:Arial">
      <img src="https://i.ibb.co/2t5x7Yq/clock-logo.png" style="width:80px;height:auto;"><br>
      <b style="font-size:14px;">üïí ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç / ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§µ‡§æ üïí</b>
      <hr>
      <p><b>‡§®‡§æ‡§Æ / ‡§®‡§æ‡§µ:</b> ${activeVoter.voter_full_name}</p>
      <p><b>EPIC:</b> ${activeVoter.epic_no}</p>
      <p><b>‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï/‡§≠‡§æ‡§ó:</b> ${activeVoter.sl_no_in_part}</p>
      <p><b>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ / Area:</b> ${activeVoter.area}</p>
      <p><b>‡§ò‡§∞ ‡§®‡§Ç‡§¨‡§∞ / House No:</b> ${activeVoter.house_no}</p>
      <p><b>‡§∏‡§Ç‡§¨‡§Ç‡§ß / Relation:</b> ${activeVoter.relation_name} (${activeVoter.relation_type})</p>
      <p><b>‡§µ‡§Ø / Age:</b> ${activeVoter.age} / <b>‡§≤‡§ø‡§Ç‡§ó / Gender:</b> ${activeVoter.gender}</p>
      <p><b>‡§∞‡§Ç‡§ó / Color:</b> <span style="display:inline-block;width:20px;height:20px;background:${activeVoter.color};border:1px solid #000;"></span></p>
      <hr>
      <pre>${activeVoter.message}</pre>
    </div>`;
    let w=window.open("","Print","width=250,height=400");
    w.document.write(content);
    w.document.close();
    w.print();
}

function sendWhatsApp(){
    if(!activeVoter) return;
    let text=`üïíüïíüïí ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç / ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§µ‡§æ üïíüïíüïí
    
‡§Æ‡§§‡§¶‡§æ‡§§‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ / ‡§Æ‡§§‡§¶‡§æ‡§∞ ‡§§‡§™‡§∂‡•Ä‡§≤
‡§®‡§æ‡§Æ / ‡§®‡§æ‡§µ: ${activeVoter.voter_full_name}
EPIC: ${activeVoter.epic_no}
‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï/‡§≠‡§æ‡§ó: ${activeVoter.sl_no_in_part}
‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ / Area: ${activeVoter.area}
‡§ò‡§∞ ‡§®‡§Ç‡§¨‡§∞ / House No: ${activeVoter.house_no}
‡§∏‡§Ç‡§¨‡§Ç‡§ß / Relation: ${activeVoter.relation_name} (${activeVoter.relation_type})
‡§µ‡§Ø / Age: ${activeVoter.age} / ‡§≤‡§ø‡§Ç‡§ó / Gender: ${activeVoter.gender}

Message / ‡§∏‡§Ç‡§¶‡•á‡§∂:
${activeVoter.message}`;
    window.open("https://wa.me/?text="+encodeURIComponent(text), "_blank");
}

function downloadPDF(){
    if(!activeVoter) return;
    let content=`üïíüïíüïí ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç / ‡§µ‡§ø‡§ú‡§Ø‡•Ä ‡§¨‡§®‡§µ‡§æ üïíüïíüïí

Name / ‡§®‡§æ‡§µ: ${activeVoter.voter_full_name}
EPIC: ${activeVoter.epic_no}
Serial/Part / ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï/‡§≠‡§æ‡§ó: ${activeVoter.sl_no_in_part}
Area / ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${activeVoter.area}
House No / ‡§ò‡§∞ ‡§®‡§Ç‡§¨‡§∞: ${activeVoter.house_no}
Relation / ‡§∏‡§Ç‡§¨‡§Ç‡§ß: ${activeVoter.relation_name} (${activeVoter.relation_type})
Age / ‡§µ‡§Ø: ${activeVoter.age} / Gender / ‡§≤‡§ø‡§Ç‡§ó: ${activeVoter.gender}

Message / ‡§∏‡§Ç‡§¶‡•á‡§∂:
${activeVoter.message}`;
    const blob=new Blob([content],{type:"text/plain"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=activeVoter.epic_no+"_voter_details.txt";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
