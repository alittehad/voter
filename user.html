<!DOCTYPE html>
<html>
<head>
<title>Voter Search App</title>
<style>
body { font-family: Arial; margin: 20px; }
input, button { padding: 10px; width: 100%; margin-top: 10px; font-size: 18px; }
#list div { background: #e5e7eb; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 6px; }
.popup{
 position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
 background:white; padding:20px; width:350px; border-radius:10px; 
 box-shadow:0px 0px 10px #444; display:none;
}
.popup button{ width:100%; padding:10px; margin-top:10px; }
</style>
</head>
<body>

<h2>üîê Login</h2>
<input id="email" placeholder="Enter Email">
<button id="loginBtn">Login</button>
<br><br>
<button id="googleLogin" style="background:#4285F4;color:white;">üîë Login with Google</button>

<hr>

<h2>üîç Search Voter</h2>
<input id="search" placeholder="Name, EPIC, AC No, Part No...">

<div id="list"></div>

<div id="popup" class="popup">
<h3>Voter Details</h3>
<div id="details"></div>
<textarea id="desc" placeholder="Message for voter..." style="width:100%;height:80px;margin-top:10px;"></textarea>
<button onclick="send()">üì© Send</button>
<button onclick="printCard()">üñ® Print</button>
<button onclick="closePopup()">‚ùå Close</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let voters = {};
let users = {};
let logged = null;
let selectedVoter = null;

// Load Users & Voters
db.ref("Users").on("value", snap => { users = snap.val() || {}; });
db.ref("Voters").on("value", snap => { voters = snap.val() || {}; });

// Manual Login
document.getElementById("loginBtn").addEventListener("click", function(){
 let email = document.getElementById("email").value.trim();
 if(users[email]){
   logged = users[email];
   alert(`‚úÖ Login Success: ${logged.Name}`);
 } else {
   alert("‚ùå Invalid Email");
 }
});

// GOOGLE LOGIN
document.getElementById("googleLogin").addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();

  try {
    const result = await auth.signInWithPopup(provider);
    const email = result.user.email;

    if(users[email]){ 
      logged = users[email]; 
      alert(`‚úÖ Google Login Success: ${logged.Name}`); 
    } else {
      alert("‚ùå Your email is not registered in user list.");
      auth.signOut();
    }

  } catch (err) {
    alert("‚ö† Google login failed.");
  }
});

// Search
document.getElementById("search").addEventListener("input", function(){
 if(!logged){ alert("Login Required!"); return; }

 let text = this.value.toLowerCase();
 let list = document.getElementById("list");
 list.innerHTML = "";

 Object.values(voters).forEach(v => {
   if(v.Name.toLowerCase().includes(text) ||
      v.Epic.toLowerCase().includes(text) ||
      String(v.AcNo).includes(text) ||
      String(v.PartNo).includes(text)){

     let div = document.createElement("div");
     div.innerHTML = `${v.Name} ‚Äî (${v.Epic})`;
     div.onclick = () => openPopup(v);
     list.appendChild(div);
   }
 });
});

// Popup
function openPopup(v){
 selectedVoter = v;
 document.getElementById("details").innerHTML = `
 Name: ${v.Name} <br>
 EPIC: ${v.Epic} <br>
 AC No: ${v.AcNo} <br>
 Part No: ${v.PartNo}
 `;
 document.getElementById("popup").style.display = "block";
}

// Print
function printCard(){
 if(!selectedVoter) return;
 let win = window.open("", "", "width=400,height=500");
 win.document.write(`
   <h2>Voter Card</h2>
   Name: ${selectedVoter.Name}<br>
   EPIC: ${selectedVoter.Epic}<br>
   AC No: ${selectedVoter.AcNo}<br>
   Part No: ${selectedVoter.PartNo}<br><br>
   Message: ${document.getElementById("desc").value}
 `);
 win.print();
 win.close();
}

// Send
function send(){
 alert("üì© Message sent:\n" + document.getElementById("desc").value);
}

// Close
function closePopup(){
 document.getElementById("popup").style.display = "none";
}
</script>

</body>
</html>
