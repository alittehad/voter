<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Cards</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js"></script>
<style>
body { font-family: Arial; margin:20px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px;}
th, td { border: 1px solid #ccc; padding: 8px; text-align: left;}
th { background-color: #f4f4f4; }
.card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:8px; background:#fafafa; }
.card img { max-width:100px; display:block; margin-bottom:5px; }
button { padding:5px 10px; margin-right:5px; cursor:pointer; }
.progress-bar { width:0%; height:5px; background:green; margin-bottom:5px; transition:width 0.3s;}
</style>
</head>
<body>

<h2>Voter List</h2>
<label>Filter by AC: 
<select id="acFilter">
  <option value="all">All</option>
</select>
</select>
</label>

<table id="voterTable">
<thead>
<tr><th>Name</th><th>EPIC</th><th>AC</th><th>Part</th><th>Voting Address</th><th>Images</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>

<h2>Voter Cards</h2>
<div id="cardsContainer"></div>

<!-- Voting Address Add Form -->
<h3>Add / Edit Voting Address</h3>
<select id="voterSelect"></select>
<input type="text" id="votingAddressInput" placeholder="Enter Voting Address">
<button id="saveVotingAddress">Save</button>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// Sample JSON data
let data = {
  "Voters": {
    "BCD0598334": {"Epic":"BCD0598334","Name":"Sanjay Malakar","AcNo":131,"PartNo":92,"VotingAddress":"","Description":"","Images":[]},
    "DJM1162627": {"Epic":"DJM1162627","Name":"Jagdish Gajanan Gurav","AcNo":131,"PartNo":237,"VotingAddress":"","Description":"","Images":[]}
  },
  "Sender": { "text": "Admin message here", "img": "" },
  "Users": { "Ngogrant454_gmail_com": { "Email":"ngogrant454@gmail.com","Name":"Admin 1","Role":"Admin"} }
};

let currentAC = 'all';

// Populate AC dropdown dynamically
function populateACDropdown() {
  const acSet = new Set();
  Object.values(data.Voters).forEach(v=>acSet.add(v.AcNo));
  const acFilter = document.getElementById('acFilter');
  acSet.forEach(ac=>{
    const opt = document.createElement('option');
    opt.value = ac;
    opt.textContent = ac;
    acFilter.appendChild(opt);
  });
}

// Populate Voter select dropdown
function populateVoterSelect() {
  const sel = document.getElementById('voterSelect');
  sel.innerHTML = '';
  Object.values(data.Voters).forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.Epic;
    opt.textContent = `${v.Name} (${v.Epic})`;
    sel.appendChild(opt);
  });
}

// Render Table
function renderTable() {
  const tbody = document.getElementById('voterTable').querySelector('tbody');
  tbody.innerHTML = '';
  Object.values(data.Voters).forEach(v=>{
    if(currentAC !== 'all' && v.AcNo!=currentAC) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${v.Name}</td>
      <td>${v.Epic}</td>
      <td>${v.AcNo}</td>
      <td>${v.PartNo}</td>
      <td>${v.VotingAddress || ''}</td>
      <td>${v.Images.length>0 ? v.Images.map(i=>`<img src="${i}" width="50">`).join('') : ''}</td>
      <td>
        <input type="file" data-epic="${v.Epic}" class="imgUpload">
        <div class="progress-bar" id="progress-${v.Epic}"></div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Render Cards
function renderCards() {
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '';
  Object.values(data.Voters).forEach(v=>{
    if(currentAC !== 'all' && v.AcNo!=currentAC) return;
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <strong>${v.Name}</strong> (${v.Epic})<br>
      AC: ${v.AcNo} - Part: ${v.PartNo}<br>
      Voting Address: ${v.VotingAddress || 'N/A'}<br>
      Description: ${v.Description || ''}<br>
      <div>${v.Images.map(i=>`<img src="${i}">`).join('')}</div>
      <button onclick="printCard('${v.Epic}')">Print</button>
      <button onclick="shareCard('${v.Epic}')">WhatsApp</button>
    `;
    container.appendChild(card);
  });
}

// Print function
function printCard(epic){
  const v = data.Voters[epic];
  const win = window.open('','','width=600,height=400');
  win.document.write(`<h2>${v.Name} (${v.Epic})</h2>`);
  win.document.write(`AC:${v.AcNo} Part:${v.PartNo}<br>`);
  win.document.write(`Voting Address:${v.VotingAddress || ''}<br>`);
  win.document.write(`Description:${v.Description || ''}<br>`);
  v.Images.forEach(img=>win.document.write(`<img src="${img}" width="100"><br>`));
  win.print();
}

// WhatsApp share function
function shareCard(epic){
  const v = data.Voters[epic];
  let text = `Name:${v.Name} (${v.Epic})\nAC:${v.AcNo} Part:${v.PartNo}\nVoting:${v.VotingAddress || ''}\nDescription:${v.Description || ''}`;
  let url = encodeURIComponent(text);
  if(navigator.share){
    navigator.share({text});
  } else {
    window.open(`https://wa.me/?text=${url}`,'_blank');
  }
}

// Handle image upload
document.addEventListener('change', async (e)=>{
  if(e.target.classList.contains('imgUpload')){
    const file = e.target.files[0];
    const epic = e.target.dataset.epic;
    const progressBar = document.getElementById(`progress-${epic}`);
    if(file){
      const storageRef = storage.ref(`voterImages/${epic}/${file.name}`);
      const uploadTask = storageRef.put(file);
      uploadTask.on('state_changed', snapshot=>{
        const percent = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
        progressBar.style.width = percent+'%';
      }, error=>{ alert('Upload error'); }, ()=>{
        uploadTask.snapshot.ref.getDownloadURL().then(url=>{
          data.Voters[epic].Images.push(url);
          renderTable();
          renderCards();
        });
      });
    }
  }
});

// Save Voting Address
document.getElementById('saveVotingAddress').addEventListener('click',()=>{
  const epic = document.getElementById('voterSelect').value;
  const address = document.getElementById('votingAddressInput').value;
  data.Voters[epic].VotingAddress = address;
  renderTable();
  renderCards();
});

// AC filter change
document.getElementById('acFilter').addEventListener('change',(e)=>{
  currentAC = e.target.value;
  renderTable();
  renderCards();
});

populateACDropdown();
populateVoterSelect();
renderTable();
renderCards();
</script>
</body>
</html>
