<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Management Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#eef2ff;--card:#fff}
body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.container{max-width:1100px;margin:12px auto;padding:12px;}
.heading{font-size:clamp(1.4rem,3vw,1.8rem);font-weight:800;text-align:center;margin-bottom:12px;color:#0f172a;text-shadow:0 1px 0 rgba(255,255,255,0.5),0 6px 12px rgba(2,6,23,0.12),0 18px 36px rgba(2,6,23,0.10);}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:6px 6px 18px rgba(2,6,23,0.06);}
.img-sender-small{width:30px;height:30px;border-radius:999px;object-fit:cover;margin-right:6px;}
.img-sender{width:40px;height:40px;border-radius:999px;object-fit:cover;margin-right:8px}
.btn{cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:700;font-size:12px;transition:all 0.2s;box-shadow:3px 3px 6px rgba(0,0,0,0.2);}
.btn:hover{transform:translateY(-2px);box-shadow:4px 4px 10px rgba(0,0,0,0.25);}
.btn-blue{background:#2563eb;color:white}
.btn-green{background:#16a34a;color:white}
.btn-yellow{background:#facc15;color:#111}
.btn-red{background:#dc2626;color:white}
.btn-gray{background:#6b7280;color:white}
.btn-sm{padding:2px 6px;font-size:10px;}
.table-container{overflow:auto;width:100%}
table{width:100%;border-collapse:collapse;min-width:300px;background:white;border-radius:6px;overflow:hidden}
th,td{padding:6px;border:1px solid #e6e9ef;text-align:left;white-space:nowrap;font-size:12px}
thead tr{background:#ebf8ff;font-weight:700}
tr:hover{background:#f7f9ff}
.card-approved{background:#dcfce7} 
.card-opponent{background:#fef9c3} 
.card-anti{background:#fee2e2} 
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:700;font-size:11px}
.actions button{margin-right:4px}
.opacity-50{opacity:0.5;}
.cursor-not-allowed{cursor:not-allowed;}
.hidden{display:none;}
@media(max-width:900px){ table{min-width:100%} }
</style>
</head>
<body>
<div class="container">
<h1 class="heading">Voter Management Panel</h1>

<!-- Login -->
<div id="loginDiv" class="card text-center">
  <h2 class="text-lg font-bold text-blue-700">Login to Access Panel</h2>
  <button id="googleLoginBtn" class="btn btn-blue mt-4">Login with Google</button>
</div>

<!-- Panel -->
<div id="panelDiv" class="hidden">

  <!-- Admin Logout -->
  <div id="adminControls" class="card flex justify-end items-center hidden">
    <button id="logoutBtn" class="btn btn-red">Logout</button>
  </div>

  <!-- Top controls -->
  <div class="card flex gap-4 flex-wrap items-center">
    <div style="flex:1">
      <input id="searchVoter" placeholder="Search by Name, EPIC, Part No, Booth..." class="w-full border p-2 rounded text-sm"/>
    </div>
    <div style="flex:1">
      <textarea id="senderDesc" placeholder="Sender Description (appears above voter info)" class="w-full border p-2 rounded text-sm" rows="2"></textarea>
    </div>
    <div>
      <button id="addVoterBtn" class="btn btn-green btn-sm">Add New Voter</button>
      <button id="printBtn" class="btn btn-yellow btn-sm">Print Selected</button>
      <button id="whatsappBtn" class="btn btn-green btn-sm">WhatsApp Selected</button>
    </div>
  </div>

  <!-- Status count -->
  <div id="statusCount" class="flex gap-4 mb-2 text-sm"></div>

  <!-- Voter Detail Container -->
  <div id="voterDetailContainer"></div>

  <!-- Table -->
  <div id="voterList" class="table-container card"></div>
</div>

<!-- Edit/Add Modal -->
<div id="editModal" class="hidden fixed top-0 left-0 w-full h-full bg-black/50 flex justify-center items-center">
  <div class="bg-white p-4 rounded w-11/12 max-w-md">
    <h2 class="text-lg font-bold mb-2" id="modalTitle">Edit Voter</h2>
    <input id="editName" placeholder="Name" class="w-full border p-2 mb-2 rounded"/>
    <input id="editEPIC" placeholder="EPIC" class="w-full border p-2 mb-2 rounded"/>
    <input id="editPart" placeholder="Part No" class="w-full border p-2 mb-2 rounded"/>
    <input id="editBooth" placeholder="Booth" class="w-full border p-2 mb-2 rounded"/>
    <input id="editAddress" placeholder="Address" class="w-full border p-2 mb-2 rounded"/>
    <input id="editPhoto" type="file" class="w-full mb-2"/>
    <div class="flex justify-end gap-2">
      <button id="saveEditBtn" class="btn btn-green btn-sm">Save</button>
      <button id="cancelEditBtn" class="btn btn-red btn-sm">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref as dbRef, onValue, set, get, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase(app);
const storage = getStorage(app);

const loginDiv = document.getElementById("loginDiv");
const panelDiv = document.getElementById("panelDiv");
const loginBtn = document.getElementById("googleLoginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const voterListDiv = document.getElementById("voterList");
const searchInput = document.getElementById("searchVoter");
const senderDescEl = document.getElementById("senderDesc");
const statusCountDiv = document.getElementById("statusCount");
const voterDetailContainer = document.getElementById("voterDetailContainer");
const adminControls = document.getElementById("adminControls");
const addVoterBtn = document.getElementById("addVoterBtn");
const editModal = document.getElementById("editModal");
const modalTitle = document.getElementById("modalTitle");
const printBtn = document.getElementById("printBtn");
const whatsappBtn = document.getElementById("whatsappBtn");

let voterData = [];
let selectedVoter = null;
let selectedRows = new Set();
let isAdmin = false;
let isFullAdmin = false;

function emailToKey(email){ return email.replace(/\./g,"_dot_"); }

// Login / Logout
loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err=>alert("Login failed: "+err.message));
logoutBtn.onclick = () => signOut(auth);

// Auth State
onAuthStateChanged(auth, async user=>{
  if(user){
    const emailKey = emailToKey(user.email.toLowerCase());
    const adminSnap = await get(dbRef(db,"admins/"+emailKey));
    if(!adminSnap.exists()){ alert("Access Denied"); signOut(auth); return; }
    isAdmin = true;
    isFullAdmin = adminSnap.val().fullControl || false;

    loginDiv.classList.add("hidden");
    panelDiv.classList.remove("hidden");
    adminControls.classList.remove("hidden");

    loadVoters();
  } else {
    loginDiv.classList.remove("hidden");
    panelDiv.classList.add("hidden");
    adminControls.classList.add("hidden");
  }
});

// Load voters
function loadVoters(){
  onValue(dbRef(db,"voters"), snap => {
    voterData = [];
    snap.forEach(c => {
      const v = c.val();
      voterData.push({
        id: c.key,
        name: v.name || '',
        voterID: v.epic || '',
        epic: v.epic || '',
        partNo: v.part || '',
        booth: v.booth || '',
        address: v.address || '',
        status: v.status || 'anti',
        photoURL: v.photoURL || ''
      });
    });
    renderTable(voterData);
    renderStatusCount();
  });
}

// Status count
function renderStatusCount(){
  let approved=0, opponent=0, anti=0;
  voterData.forEach(v=>{ if(v.status==="approved") approved++; else if(v.status==="opponent") opponent++; else anti++; });
  statusCountDiv.innerHTML = `<div class="badge" style="background:#dcfce7">Approved: ${approved}</div>
  <div class="badge" style="background:#fef9c3">Opponent: ${opponent}</div>
  <div class="badge" style="background:#fee2e2">Anti: ${anti}</div>`;
}

// Render table
function renderTable(list){
  voterListDiv.innerHTML=`<table><thead><tr>
  <th>Select</th><th>Name</th><th>EPIC</th><th>Part</th><th>Booth</th><th>Address</th><th>Actions</th>
  </tr></thead><tbody></tbody></table>`;
  const tbody = voterListDiv.querySelector("tbody");
  list.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="checkbox" class="selectRow"/></td>
      <td><img src="${v.photoURL||'https://i.ibb.co/LhDpnZFn/khatik-imase.jpg'}" class="img-sender-small"/> ${v.name}</td>
      <td>${v.voterID}</td>
      <td>${v.partNo}</td>
      <td>${v.booth}</td>
      <td>${v.address}</td>
      <td>
        <button class="btn btn-sm btn-blue editBtn">Edit</button>
        ${isFullAdmin?'<button class="btn btn-sm btn-red delBtn">Delete</button>':''}
      </td>`;
    tr.className=v.status==="approved"?"card-approved":v.status==="opponent"?"card-opponent":"card-anti";
    tbody.appendChild(tr);

    tr.querySelector(".editBtn").onclick=()=>showEditModal(v);
    if(isFullAdmin){
      tr.querySelector(".delBtn").onclick=()=>{if(confirm("Delete voter?")) remove(dbRef(db,"voters/"+v.id));};
    }

    tr.querySelector(".selectRow").onchange = (e)=>{
      if(e.target.checked) selectedRows.add(v.id);
      else selectedRows.delete(v.id);
    };

    tr.onclick=(e)=>{
      if(e.target.tagName!=="INPUT" && e.target.tagName!=="BUTTON") showVoterCard(v);
    };
  });
}

// Show voter card
function showVoterCard(v){
  voterDetailContainer.innerHTML="";
  const div=document.createElement("div"); div.className="card";
  div.innerHTML=`
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="${v.photoURL||'https://i.ibb.co/LhDpnZFn/khatik-imase.jpg'}" class="img-sender"/>
      <div>
        <h3 style="margin:0;font-weight:800">${v.name||'-'}</h3>
        <div style="color:#475569;font-size:13px">${senderDescEl.value||''}</div>
      </div>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-red btn-sm">Close</button>
  </div>
  <div style="margin-top:8px;font-size:12px">
    <p><strong>EPIC:</strong> ${v.voterID||'-'}</p>
    <p><strong>Part:</strong> ${v.partNo||'-'}</p>
    <p><strong>Booth:</strong> ${v.booth||'-'}</p>
    <p><strong>Address:</strong> ${v.address||'-'}</p>
  </div>`;
  voterDetailContainer.appendChild(div);
}

// Edit Modal
function showEditModal(voter){
  selectedVoter = voter || null;
  modalTitle.innerText = voter?"Edit Voter":"Add New Voter";
  document.getElementById("editName").value = voter?.name||'';
  document.getElementById("editEPIC").value = voter?.epic||'';
  document.getElementById("editPart").value = voter?.partNo||'';
  document.getElementById("editBooth").value = voter?.booth||'';
  document.getElementById("editAddress").value = voter?.address||'';
  document.getElementById("editPhoto").value = '';
  editModal.classList.remove("hidden");
}

document.getElementById("cancelEditBtn").onclick = ()=>{editModal.classList.add("hidden");};

// Save Edit/Add
document.getElementById("saveEditBtn").onclick = async ()=>{
  const updatedData = {
    name: document.getElementById("editName").value,
    epic: document.getElementById("editEPIC").value,
    partNo: document.getElementById("editPart").value,
    booth: document.getElementById("editBooth").value,
    address: document.getElementById("editAddress").value,
    status: selectedVoter?.status || 'anti',
    photoURL: selectedVoter?.photoURL || ''
  };

  const file = document.getElementById("editPhoto").files[0];
  if(file){
    const sRef = storageRef(storage,'voter_photos/'+(selectedVoter?.id||Date.now()));
    await uploadBytes(sRef,file);
    updatedData.photoURL = await getDownloadURL(sRef);
  }

  if(selectedVoter){
    set(dbRef(db,"voters/"+selectedVoter.id), {...selectedVoter, ...updatedData});
  } else {
    const newRef = push(dbRef(db,"voters"));
    set(newRef, updatedData);
  }

  editModal.classList.add("hidden");
};

addVoterBtn.onclick=()=>showEditModal(null);

// Search filter
searchInput.addEventListener("input", e=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) renderTable(voterData);
  else renderTable(voterData.filter(v=>{
    return `${v.name} ${v.voterID} ${v.partNo} ${v.booth} ${v.address}`.toLowerCase().includes(q);
  }));
});

// Print selected
printBtn.onclick = ()=>{
  if(selectedRows.size===0){ alert("Select voters first!"); return; }
  const html = voterData.filter(v=>selectedRows.has(v.id)).map(v=>{
    return `<p>${v.name} | ${v.voterID} | ${v.partNo} | ${v.booth} | ${v.address}</p>`;
  }).join("");
  const w = window.open("","Print","width=800,height=600");
  w.document.write(html);
  w.print();
};

// WhatsApp selected
whatsappBtn.onclick = ()=>{
  if(selectedRows.size===0){ alert("Select voters first!"); return; }
  const msg = voterData.filter(v=>selectedRows.has(v.id)).map(v=>{
    return `${v.name} | ${v.voterID} | ${v.partNo} | ${v.booth} | ${v.address}`;
  }).join("\n");
  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
};
</script>
</body>
</html>
