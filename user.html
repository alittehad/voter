<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List with Image Upload & Edit</title>
<style>
body { font-family: Arial; margin:0; padding:10px; background:#f3f3f3; }
h2 { text-align:center; margin-bottom:15px; }
input, textarea { width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:2px solid #777; font-size:16px; }
.list-item { padding:14px; background:white; border:2px solid #aaa; margin-bottom:10px; border-radius:12px; cursor:pointer; transition:.3s; font-size:16px; }
.list-item:hover { transform:scale(1.03); box-shadow:0 0 10px gray; }

/* Popup */
#popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:flex-start; overflow-y:auto; padding:20px; box-sizing:border-box; }
.card { width:95%; max-width:420px; background:white; border:3px solid black; border-radius:15px; padding:20px; }
.card img { width:100%; max-height:200px; object-fit:contain; margin-bottom:10px; }

/* Buttons */
.btn { padding:12px; width:100%; margin-top:10px; background:#008cff; color:white; border:none; cursor:pointer; font-size:16px; border-radius:10px; box-shadow:0 4px 0 #003f7f; }
.btn:active { transform:translateY(4px); box-shadow:0 1px 0 #003f7f; }
.close-btn { background:red; box-shadow:0 4px 0 #7a0000; }

/* Print */
@media print {
  body * { visibility:hidden }
  #popup, #popup * { visibility:visible }
  .btn, input[type="file"], textarea, input { display:none !important; }
}
</style>
</head>
<body>

<h2>ğŸ—³ Voter List</h2>
<input id="search" placeholder="Search Name, EPIC, AC No, Part No...">

<div id="list"></div>

<!-- POPUP -->
<div id="popup">
    <div class="card" id="cardBox">
        <h3 id="pName"></h3>
        <p><b>ğŸ†” EPIC:</b> <span id="pEpic"></span></p>
        <p><b>ğŸ› AC No:</b> <span id="pAc"></span></p>
        <p><b>ğŸ“ Part No:</b> <span id="pPart"></span></p>

        <label><b>ğŸ  Address:</b></label>
        <textarea id="editAddress" placeholder="Enter Address"></textarea>

        <label><b>ğŸ—³ Booth / Voting Address:</b></label>
        <textarea id="editVoting" placeholder="Enter Booth / Voting Address"></textarea>

        <img id="voterImage" src="" alt="" style="display:none;" />

        <label><b>Upload Image:</b></label>
        <input type="file" id="imageInput" accept="image/*">

        <label><b>Sender Message:</b></label>
        <textarea id="senderNote" placeholder="Your message..." rows="3"></textarea>

        <button class="btn" onclick="saveEdits()">ğŸ’¾ Save Changes</button>
        <button class="btn" onclick="printCard()">ğŸ–¨ Print</button>
        <button class="btn" onclick="sendWA()">ğŸ“© WhatsApp Send</button>
        <button class="btn close-btn" onclick="closePopup()">âŒ Close</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);

let voters = {}, selected=null;

// Load Data
firebase.database().ref("/Voters").once("value").then(snap=>{
    voters = snap.val() || {};
    showList(voters);
});

// Show Voter List
function showList(data){
    let box = document.getElementById("list");
    box.innerHTML = "";
    Object.values(data).forEach(v=>{
        let div = document.createElement("div");
        div.className="list-item";
        div.dataset.epic = v.EPIC;
        div.innerHTML = `<b>${v.Name}</b><br>ğŸ†” ${v.EPIC} | AC:${v.AcNo} | Part:${v.PartNo}`;
        div.onclick=()=>openPopup(v);
        box.appendChild(div);
    });
}

// Open Popup
function openPopup(v){
    selected = v;

    document.getElementById("pName").innerText = v.Name;
    document.getElementById("pEpic").innerText = v.EPIC;
    document.getElementById("pAc").innerText   = v.AcNo;
    document.getElementById("pPart").innerText = v.PartNo;

    document.getElementById("editAddress").value = v.Address || "";
    document.getElementById("editVoting").value  = v.VotingAddress || "";

    document.getElementById("senderNote").value = v.SenderNote || "";

    if(v.ImageURL){
        document.getElementById("voterImage").src = v.ImageURL;
        document.getElementById("voterImage").style.display="block";
    }

    document.getElementById("popup").style.display="flex";
}

function closePopup(){
    document.getElementById("popup").style.display="none";
}

// SAVE EDITS (Address + Booth + Note)
function saveEdits(){
    if(!selected) return;

    let newAddress = document.getElementById("editAddress").value;
    let newVoting  = document.getElementById("editVoting").value;
    let note       = document.getElementById("senderNote").value;

    firebase.database().ref("Voters/" + selected.EPIC).update({
        Address: newAddress,
        VotingAddress: newVoting,
        SenderNote: note
    });

    selected.Address = newAddress;
    selected.VotingAddress = newVoting;
    selected.SenderNote = note;

    showList(voters);

    alert("âœ” Saved Successfully");
}

// PRINT
function printCard(){ window.print(); }

// WHATSAPP (NO IMAGE)
function sendWA(){
    let note = document.getElementById("senderNote").value;

    let text = 
`*Voter Details*
ğŸ‘¤ ${selected.Name}
ğŸ†” EPIC: ${selected.EPIC}
ğŸ› AC: ${selected.AcNo}
ğŸ“ Part: ${selected.PartNo}

ğŸ  Address:
${selected.Address || "NA"}

ğŸ—³ Booth:
${selected.VotingAddress || "NA"}

ğŸ“© Message:
${note}`;

    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
}

// PHOTO UPLOAD
document.getElementById("imageInput").addEventListener("change", e=>{
    let file = e.target.files[0];
    if(!file || !selected) return;

    let ref = firebase.storage().ref("voterImages/" + selected.EPIC);

    ref.put(file).then(()=>{
        ref.getDownloadURL().then(url=>{
            document.getElementById("voterImage").src=url;
            document.getElementById("voterImage").style.display="block";

            firebase.database().ref("Voters/"+selected.EPIC).update({
                ImageURL: url
            });

            selected.ImageURL = url;
            alert("âœ” Photo Uploaded");
        });
    });
});

// Search
document.getElementById("search").addEventListener("input", e=>{
    let t = e.target.value.toLowerCase();
    let f = Object.values(voters).filter(v =>
        v.Name.toLowerCase().includes(t) ||
        v.EPIC.toLowerCase().includes(t)
    );
    showList(f);
});
</script>

</body>
</html>
