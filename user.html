<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Manager</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-xl mx-auto bg-white shadow-md p-6 rounded-lg">
<h2 class="text-xl font-bold mb-4">ğŸ—³ Voter Information</h2>

<label>EPIC Number:</label>
<input id="epicSearch" class="w-full p-2 border rounded mb-2" placeholder="Enter EPIC">

<button id="loadBtn" class="bg-blue-600 text-white w-full py-2 rounded">Load Details</button>

<div id="formArea" class="hidden mt-4">

<label>Name</label>
<input id="name" class="w-full p-2 border rounded mb-2">

<label>AC No</label>
<input id="acNo" class="w-full p-2 border rounded mb-2">

<label>Part No</label>
<input id="partNo" class="w-full p-2 border rounded mb-2">

<label>Address</label>
<input id="address" class="w-full p-2 border rounded mb-2">

<label>Booth</label>
<input id="booth" class="w-full p-2 border rounded mb-2">

<label>Sender Note</label>
<textarea id="note" class="w-full p-2 border rounded mb-2"></textarea>

<!-- IMAGE -->
<label>Voter Image</label>
<input type="file" id="uploadImage" class="block mb-2">

<img id="preview" class="hidden w-32 border rounded mb-2">

<button id="deleteImg" class="hidden bg-red-500 text-white w-full py-2 rounded mb-2">ğŸ—‘ Delete Image</button>

<button id="saveBtn" class="bg-green-600 text-white w-full py-2 rounded mb-2">ğŸ’¾ Save</button>
<button id="printBtn" class="bg-gray-600 text-white w-full py-2 rounded mb-2">ğŸ–¨ Print</button>
<button id="whatsappSend" class="bg-green-500 text-white w-full py-2 rounded">ğŸ“© WhatsApp</button>
</div>
</div>


<!-- PRINT AREA -->
<div id="printArea" class="hidden p-6">
<h2 class="text-lg font-bold">Voter Details</h2>
<img id="printImg" class="w-32 my-2">
<pre id="printData" class="text-sm leading-6 whitespace-pre-wrap"></pre>
</div>


<script>
/* Firebase Setup */
const firebaseConfig = {
    apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
    authDomain: "voter-25c94.firebaseapp.com",
    databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
    projectId: "voter-25c94",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let uploadedImageURL = "";

/* Load Data */
document.getElementById("loadBtn").onclick = async () => {
    const epic = epicSearch.value.trim();
    if (!epic) return alert("Enter EPIC");

    const snap = await db.ref("Voters/" + epic).get();
    if (!snap.exists()) return alert("Not Found âŒ");

    const data = snap.val();
    formArea.classList.remove("hidden");

    name.value = data.Name || "";
    acNo.value = data.AcNo || "";
    partNo.value = data.PartNo || "";
    address.value = data.Address || "";
    booth.value = data.VotingAddress || "";
    note.value = data.Note || "";

    uploadedImageURL = data.Image || "";

    if (uploadedImageURL) {
        preview.src = uploadedImageURL;
        preview.classList.remove("hidden");
        deleteImg.classList.remove("hidden");
    }
};

/* Upload Image (imgbb) */
uploadImage.onchange = async function() {
    const file = this.files[0];
    const fd = new FormData();
    fd.append("image", file);

    let res = await fetch("https://api.imgbb.com/1/upload?key=7894e8cd9ee3a6cc520e2285d0b3f923", {
        method: "POST",
        body: fd
    });

    let json = await res.json();
    uploadedImageURL = json.data.url;

    preview.src = uploadedImageURL;
    preview.classList.remove("hidden");
    deleteImg.classList.remove("hidden");
};

/* Delete Image */
deleteImg.onclick = () => {
    uploadedImageURL = "";
    preview.classList.add("hidden");
    deleteImg.classList.add("hidden");
};

/* SAVE */
saveBtn.onclick = () => {
    const epic = epicSearch.value.trim();
    db.ref("Voters/" + epic).update({
        Name: name.value,
        AcNo: acNo.value,
        PartNo: partNo.value,
        Address: address.value,
        VotingAddress: booth.value,
        Note: note.value,
        Image: uploadedImageURL
    });

    alert("Saved Successfully âœ”");
};

/* PRINT FIX */
printBtn.onclick = () => {
    printImg.src = uploadedImageURL;
    printData.innerText = `
Name: ${name.value}
EPIC: ${epicSearch.value}
AC No: ${acNo.value}
Part No: ${partNo.value}
Address: ${address.value}
Booth: ${booth.value}

Note:
${note.value}`;

    printArea.style.display = "block";

    setTimeout(() => window.print(), 300);
};

window.onafterprint = () =>
    printArea.style.display = "none";

/* WhatsApp */
whatsappSend.onclick = () => {
    let phone = prompt("Enter WhatsApp Number:");
    if (!phone) return;

    let msg = `
ğŸ‘¤ Name: ${name.value}
ğŸ†” EPIC: ${epicSearch.value}
ğŸ› AC: ${acNo.value}
ğŸ“ Part: ${partNo.value}
ğŸ  Address: ${address.value}
ğŸ—³ Booth: ${booth.value}

ğŸ“ Note:
${note.value}

ğŸ“¸ Image:
${uploadedImageURL}
`;

    window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`);
};
</script>

</body>
</html>
