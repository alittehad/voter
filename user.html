<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Voter Management Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{--bg:#eef2ff;--card:#fff;}
  body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1100px;margin:24px auto;padding:12px;}
  .heading {font-size:clamp(1.6rem,3vw,2.2rem);font-weight:800;text-align:center;margin-bottom:18px;color:#0f172a;transform:perspective(500px) rotateX(8deg);text-shadow:0 1px 0 rgba(255,255,255,0.5),0 6px 12px rgba(2,6,23,0.12),0 18px 36px rgba(2,6,23,0.10);letter-spacing:0.6px;}
  .subhead{ text-align:center;color:#334155;margin-bottom:18px;font-weight:600;}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:6px 6px 18px rgba(2,6,23,0.06);}
  .img-sender{width:56px;height:56px;border-radius:999px;object-fit:cover;margin-right:8px;}
  .btn{cursor:pointer;padding:8px 12px;border-radius:8px;font-weight:600}
  .btn-blue{background:#2563eb;color:white}
  .btn-green{background:#16a34a;color:white}
  .btn-yellow{background:#facc15;color:#111}
  .btn-red{background:#dc2626;color:white}
  .btn-gray{background:#6b7280;color:white}
  .table-container{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;min-width:600px;}
  th,td{padding:8px;border:1px solid #e6e9ef;text-align:left;white-space:nowrap;}
  thead tr{background:#ebf8ff;font-weight:700;}
  tr:hover{background:#f7f9ff;}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-weight:700;}
  @media (max-width:768px){ table{min-width:500px} }
</style>
</head>
<body>
<div class="container">
  <h1 class="heading">Voter Management Panel</h1>
  <p class="subhead">Compact Table | Full Card View | WhatsApp Send | Print | Mobile Friendly</p>

  <!-- Login -->
  <div id="loginDiv" class="card text-center">
    <h2 class="text-xl font-bold text-blue-700">Login to Access Voter Panel</h2>
    <button id="googleLoginBtn" class="btn btn-blue mt-4">Login with Google</button>
  </div>

  <!-- Panel -->
  <div id="panelDiv" class="hidden">

    <!-- Sender Info + Search -->
    <div class="card flex flex-col md:flex-row gap-4 items-center mb-4">
      <input id="searchVoter" placeholder="Search by Name / Booth / Part / Mobile..." class="flex-1 border p-2 rounded" />
      <div class="flex items-center gap-2 mt-2 md:mt-0">
        <img id="fixedSenderImg" class="img-sender" src="https://i.ibb.co/LhDpnZFn/khatik-imase.jpg" alt="Sender">
        <textarea id="senderDesc" placeholder="Sender Description (will be sent above voter info)" class="border p-2 rounded" rows="2"></textarea>
      </div>
    </div>

    <!-- Table -->
    <div id="voterList" class="table-container card"></div>

    <!-- Add Voter -->
    <div class="card mt-4">
      <h3 class="text-lg font-bold text-blue-700 mb-2">Add Voter Manually</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input id="voterName" placeholder="Name" class="border p-2 rounded" />
        <input id="voterEPIC" placeholder="EPIC" class="border p-2 rounded" />
        <input id="voterSerial" placeholder="Serial No (optional)" class="border p-2 rounded" />
        <select id="relationType" class="border p-2 rounded">
          <option value="">Relation Type</option>
          <option value="Father">Father</option>
          <option value="Husband">Husband</option>
        </select>
        <input id="relationName" placeholder="Father/Husband Name" class="border p-2 rounded" />
        <input id="voterGender" placeholder="Gender" class="border p-2 rounded" />
        <input id="houseNo" placeholder="House No / Building" class="border p-2 rounded" />
        <input id="roomNo" placeholder="Room No (Polling Room)" class="border p-2 rounded" />
        <input id="voterAge" placeholder="Age" class="border p-2 rounded" />
        <input id="voterAddress" placeholder="Address (Street / Mohalla / Village)" class="border p-2 rounded" />
        <input id="voterPO" placeholder="Post Office" class="border p-2 rounded" />
        <input id="voterPS" placeholder="Police Station" class="border p-2 rounded" />
        <input id="voterState" placeholder="State" class="border p-2 rounded" />
        <input id="voterDistrict" placeholder="District" class="border p-2 rounded" />
        <input id="voterAC" placeholder="AC No" class="border p-2 rounded" />
        <input id="voterPart" placeholder="Part No" class="border p-2 rounded" />
        <input id="voterBooth" placeholder="Booth No / Location" class="border p-2 rounded" />
        <input id="pollingAddress" placeholder="Polling Address (Govt School...)" class="border p-2 rounded" />
        <input id="voterSection" placeholder="Section No (optional)" class="border p-2 rounded" />
        <input id="voterMobile" placeholder="Mobile" class="border p-2 rounded" />
      </div>
      <div class="mt-3">
        <button id="addVoterManual" class="btn btn-green w-full">Add Voter</button>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref as dbRef, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase(app);

const loginDiv = document.getElementById("loginDiv");
const panelDiv = document.getElementById("panelDiv");
const loginBtn = document.getElementById("googleLoginBtn");
const voterListDiv = document.getElementById("voterList");
const searchInput = document.getElementById("searchVoter");
const senderDescEl = document.getElementById("senderDesc");

const FIXED_SENDER_IMAGE = "https://i.ibb.co/LhDpnZFn/khatik-imase.jpg";

/* --- Auth --- */
loginBtn.onclick = () => {
  signInWithPopup(auth, provider)
    .then(res => console.log("Login Success"))
    .catch(err => alert("Login failed: "+err.message));
};

onAuthStateChanged(auth, user => {
  if(user){ loginDiv.classList.add("hidden"); panelDiv.classList.remove("hidden"); loadVoters(); }
  else{ loginDiv.classList.remove("hidden"); panelDiv.classList.add("hidden"); }
});

/* --- Data --- */
let voterData = [];
function loadVoters(){
  const r = dbRef(db,"voters");
  onValue(r,snap=>{voterData=[]; snap.forEach(c=>voterData.push({id:c.key,...c.val()})); renderTable(voterData);});
}

/* --- Render Table --- */
function renderTable(list){
  let html = `<table><thead><tr>
    <th>Name</th><th>Booth</th><th>Part</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody></tbody></table>`;
  voterListDiv.innerHTML = html;
  const tbody = voterListDiv.querySelector("tbody");
  list.forEach(v=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.name||''}</td>
      <td>${v.booth||''}</td>
      <td>${v.partNo||v.part||''}</td>
      <td>${v.status||''}</td>
      <td><button class="btn btn-blue viewBtn">View</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector(".viewBtn").onclick = ()=> showVoterDetail(v);
  });
}

/* --- Show Full Card --- */
function showVoterDetail(v){
  const existing = document.getElementById("voterDetailCard");
  if(existing) existing.remove();
  const div = document.createElement("div");
  div.id="voterDetailCard"; div.className="card mt-4";
  const rel = (v.fatherName)?`Father: ${v.fatherName}`:(v.husbandName)?`Husband: ${v.husbandName}`:(v.relationType&&v.relationName)?`${v.relationType}: ${v.relationName}`:'';
  div.innerHTML=`
    <div class="flex justify-between items-start mb-2">
      <div class="flex items-center gap-2"><img src="${FIXED_SENDER_IMAGE}" class="img-sender"><div><h3 class="font-bold">${v.name||''}</h3><div class="text-sm text-gray-600">${rel} â€¢ EPIC: ${v.epic||v.voterID||''}</div></div></div>
      <div class="flex gap-2"><button class="btn btn-red closeBtn">Close</button><button class="btn btn-blue sendBtn">WhatsApp</button><button class="btn btn-green printBtn">Print</button></div>
    </div>
    <div class="text-sm">
      <p><b>House:</b> ${v.houseNo||''} | <b>Room:</b> ${v.roomNo||''}</p>
      <p><b>Polling:</b> ${v.pollingAddress||''} | <b>Booth:</b> ${v.booth||''}</p>
      <p><b>Part:</b> ${v.partNo||v.part||''} | <b>AC:</b> ${v.acNo||v.ac||''}</p>
      <p><b>Age:</b> ${v.age||''} | <b>Mobile:</b> ${v.mobile||''}</p>
      <p><b>Address:</b> ${v.address||''} ${v.po? ', PO:'+v.po:''} ${v.ps?', PS:'+v.ps:''}</p>
    </div>`;
  voterListDiv.prepend(div);
  div.querySelector(".closeBtn").onclick = ()=> div.remove();
  div.querySelector(".printBtn").onclick = ()=> {
    let html=`<div style="padding:12px;font-family:Arial,Helvetica,sans-serif">`;
    html+=`<img src="${FIXED_SENDER_IMAGE}" style="width:60px;height:60px;border-radius:50%;float:right;margin-left:8px">`;
    html+=`<h2>${v.name||''}</h2><p>${rel||''}</p><p>EPIC: ${v.epic||v.voterID||''} | Serial: ${v.serial||''}</p>`;
    html+=`<p>House: ${v.houseNo||''} | Room: ${v.roomNo||''}</p>`;
    html+=`<p>Polling: ${v.pollingAddress||''} | Booth: ${v.booth||''}</p>`;
    html+=`<p>Part: ${v.partNo||v.part||''} | AC: ${v.acNo||v.ac||''}</p>`;
    html+=`<p>Age: ${v.age||''} | Mobile: ${v.mobile||''}</p>`;
    html+=`<p>Address: ${v.address||''} ${v.po? ', PO:'+v.po:''} ${v.ps?', PS:'+v.ps:''}</p></div>`;
    const w=window.open(); w.document.write(html); w.print(); w.close();
  };
  div.querySelector(".sendBtn").onclick = ()=> {
    const senderDesc = senderDescEl.value.trim();
    let msg = senderDesc?senderDesc+"\n\n":"";
    msg+=`Name: ${v.name||''}\n${rel}\nEPIC: ${v.epic||v.voterID||''}\nHouse: ${v.houseNo||''}\nAddress: ${v.address||''}\nPart: ${v.partNo||v.part||''} | Booth: ${v.booth||''}\nPolling: ${v.pollingAddress||''}\nRoom: ${v.roomNo||''}\nMobile: ${v.mobile||''}\n\nImage: ${FIXED_SENDER_IMAGE}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
  };
}

/* --- Search --- */
searchInput.addEventListener("input",(e)=>{ 
  const q = e.target.value.toLowerCase().trim();
  renderTable(q?voterData.filter(v=>{
    const combined = `${v.name||''} ${v.booth||''} ${v.partNo||v.part||''} ${v.mobile||''}`.toLowerCase();
    return combined.includes(q);
  }):voterData);
});

/* --- Add Voter --- */
document.getElementById("addVoterManual").onclick = ()=>{
  const name=document.getElementById("voterName").value.trim();
  const epic=document.getElementById("voterEPIC").value.trim();
  if(!name||!epic)return alert("Name & EPIC required!");
  const payload={
    name, voterID:epic, epic,
    serial:document.getElementById("voterSerial").value.trim(),
    relationType:document.getElementById("relationType").value,
    relationName:document.getElementById("relationName").value.trim(),
    fatherName:'', husbandName:'',
    gender:document.getElementById("voterGender").value.trim(),
    houseNo:document.getElementById("houseNo").value.trim(),
    roomNo:document.getElementById("roomNo").value.trim(),
    age:document.getElementById("voterAge").value.trim(),
    address:document.getElementById("voterAddress").value.trim(),
    po:document.getElementById("voterPO").value.trim(),
    ps:document.getElementById("voterPS").value.trim(),
    state:document.getElementById("voterState").value.trim(),
    district:document.getElementById("voterDistrict").value.trim(),
    acNo:document.getElementById("voterAC").value.trim(),
    partNo:document.getElementById("voterPart").value.trim(),
    part:document.getElementById("voterPart").value.trim(),
    booth:document.getElementById("voterBooth").value.trim(),
    pollingAddress:document.getElementById("pollingAddress").value.trim(),
    section:document.getElementById("voterSection").value.trim(),
    mobile:document.getElementById("voterMobile").value.trim(),
    status:"active",
    createdAt:Date.now()
  };
  if(payload.relationType==="Father") payload.fatherName=payload.relationName;
  else if(payload.relationType==="Husband") payload.husbandName=payload.relationName;
  else if(payload.relationName) payload.fatherName=payload.relationName;

  push(dbRef(db,"voters"),payload).then(()=>{
    alert("Voter added!");
    ["voterName","voterEPIC","voterSerial","relationType","relationName","voterGender","houseNo","roomNo","voterAge","voterAddress","voterPO","voterPS","voterState","voterDistrict","voterAC","voterPart","voterBooth","pollingAddress","voterSection","voterMobile"].forEach(id=>document.getElementById(id).value='');
  }).catch(err=>{console.error(err);alert("Error saving voter");});
};
</script>
</body>
</html>
