<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ward Status Panel - Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: #eef2ff; }
.card {
  background:white; border-radius:1rem; box-shadow: 6px 6px 12px rgba(0,0,0,0.15), -6px -6px 12px rgba(255,255,255,0.7);
  padding:16px; margin-bottom:12px; transition: all 0.2s;
}
.card:hover { transform: translateY(-3px); }
.sticky-bar {
  position: sticky; top:0; z-index:50; backdrop-filter:blur(8px);
  background: rgba(255,255,255,0.95); padding:12px; border-bottom:1px solid #ddd;
}
.btn {
  cursor:pointer; padding:0.5rem 1rem; border-radius:0.7rem;
  font-weight:bold; transition: all 0.2s; text-align:center;
  box-shadow: 4px 4px 6px #bbb, -4px -4px 6px #fff;
}
.btn:hover { box-shadow: inset 4px 4px 6px #bbb, inset -4px -4px 6px #fff; }
.btn-blue { background:#2563eb;color:white; }
.btn-green { background:#16a34a;color:white; }
.btn-yellow { background:#facc15;color:black; }
.btn-red { background:#dc2626;color:white; }
.btn-gray { background:#6b7280;color:white; }
@media(max-width:640px){
  .flex-wrap { flex-direction: column; }
  .grid-cols-3 { grid-template-columns: 1fr; }
}
</style>
</head>
<body class="p-4">

<div class="text-center mb-4">
  <h1 class="text-2xl font-bold text-blue-700">Ward Status Panel - Admin</h1>
</div>

<!-- Sticky Bar -->
<div class="sticky-bar mb-4">
  <input id="searchBox" type="text" placeholder="Search Name / EPIC / Ward / Mobileâ€¦" class="w-full p-2 rounded-xl border mb-3 outline-none focus:ring-2 focus:ring-blue-500">
  <div class="flex gap-2 mb-3 flex-wrap">
    <button class="filterBtn px-3 py-1 rounded-full bg-blue-600 text-white" data-filter="all">All</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-green-600 text-white" data-filter="approved">Approved</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-yellow-600 text-white" data-filter="opponent">Opponent</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-red-600 text-white" data-filter="anti">Anti</button>
  </div>
  <div class="grid grid-cols-3 gap-2 text-center">
    <div class="p-2 rounded-lg bg-green-100 text-green-700 font-bold">Approved: <span id="countApproved">0</span></div>
    <div class="p-2 rounded-lg bg-yellow-100 text-yellow-700 font-bold">Opponent: <span id="countOpponent">0</span></div>
    <div class="p-2 rounded-lg bg-red-100 text-red-700 font-bold">Anti: <span id="countAnti">0</span></div>
  </div>
</div>

<!-- Sender Info -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="text-xl font-bold mb-2 text-blue-700">Sender Information</h2>
  <input type="text" id="senderName" placeholder="Sender Name" class="border p-2 w-full mb-2">
  <input type="text" id="senderMessage" placeholder="Message to send" class="border p-2 w-full mb-2">
  <p class="font-semibold mb-1">Upload Sender Photo:</p>
  <input type="file" id="senderImage" class="border p-2 w-full mb-2">
  <div class="flex gap-2">
    <button id="saveSender" class="btn btn-blue flex-1">Save Sender Info</button>
    <button id="deleteSender" class="btn btn-red flex-1">Delete Sender Info</button>
  </div>
</div>

<!-- Voter List -->
<div id="list" class="mt-4"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let senderCache = {};

// ImgBB Upload
async function uploadToImgBB(file){
  const base64 = await new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => res(reader.result.split(",")[1]);
    reader.onerror = err => rej(err);
  });
  const form = new FormData();
  form.append("image", base64);
  const API_KEY = "5735107daf1af173af2008a3899a2496";
  const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, { method:"POST", body: form });
  const data = await response.json();
  if(!data.success) throw new Error("ImgBB upload failed");
  return data.data.url;
}

// Save Sender
saveSender.onclick = async ()=>{
  const name = senderName.value.trim();
  const msg  = senderMessage.value.trim();
  const file = senderImage.files[0];
  if(!name || !msg || !file) return alert("Fill all sender info!");
  try{
    const imgURL = await uploadToImgBB(file);
    await set(dbRef(db,"senderInfo"), { name, message: msg, photo: imgURL });
    senderCache = {name,message: msg,photo: imgURL};
    alert("Sender info saved!");
  }catch(err){ console.error(err); alert("Sender info save failed!") }
};

// Delete Sender
deleteSender.onclick = async ()=>{
  if(confirm("Delete sender info?")){
    remove(dbRef(db,"senderInfo")).then(()=>{
      senderCache={};
      senderName.value="";
      senderMessage.value="";
      senderImage.value="";
      alert("Sender info deleted!");
    }).catch(err=>{console.error(err); alert("Delete failed!");});
  }
};

// Load sender
onValue(dbRef(db,"senderInfo"), snap => { if(snap.exists()) senderCache = snap.val(); });

// Render voters
const listDiv = document.getElementById("list");
onValue(dbRef(db,"voters"), snap=>{
  listDiv.innerHTML="";
  snap.forEach(s=>{
    const v = s.val();
    const div=document.createElement("div");
    div.className="card item mt-3";
    div.dataset.status=v.status;
    div.dataset.name=v.name.toLowerCase();
    div.dataset.epic=v.voterID.toLowerCase();
    div.dataset.ward=v.ward.toLowerCase();
    div.dataset.mobile=v.mobile.toLowerCase();
    div.innerHTML=`<h2 class="font-bold">${v.name}</h2>
      <p class="text-sm text-gray-600">EPIC: ${v.voterID} | Ward: ${v.ward} | Status: ${v.status}</p>
      <div class="mt-2 flex gap-2 flex-wrap">
        <button class="btn btn-blue sendBtn">Send WhatsApp</button>
        <button class="btn btn-green printBtn">Print</button>
        <button class="btn btn-yellow approveBtn">Approve</button>
        <button class="btn btn-yellow opponentBtn">Opponent</button>
        <button class="btn btn-red antiBtn">Anti</button>
        <button class="btn btn-gray deleteBtn">Delete</button>
      </div>`;
    listDiv.appendChild(div);

    // Optimistic UI: update card color immediately
    const updateStatus=(newStatus)=>{
      div.dataset.status=newStatus;
      div.querySelector("p").innerText = `EPIC: ${v.voterID} | Ward: ${v.ward} | Status: ${newStatus}`;
      update(dbRef(db,"voters/"+v.voterID.replace(/\W/g,"_")), {status:newStatus});
      applyFilter();
    };

    div.querySelector(".approveBtn").onclick=()=>updateStatus("approved");
    div.querySelector(".opponentBtn").onclick=()=>updateStatus("opponent");
    div.querySelector(".antiBtn").onclick=()=>updateStatus("anti");

    div.querySelector(".sendBtn").onclick=()=>{
      const s=senderCache;
      if(!s.name) return alert("Sender info missing!");
      const msg=`ðŸ“£ *${s.name} à¤•à¤¾ à¤¸à¤‚à¤¦à¥‡à¤¶*\n${s.message}\n\nVoter: ${v.name}\nEPIC: ${v.voterID}\nWard: ${v.ward}\n${s.photo}`;
      window.open(`https://wa.me/${v.mobile}?text=${encodeURIComponent(msg)}`,"_blank");
    };
    div.querySelector(".printBtn").onclick=()=>{
      const win=window.open();
      win.document.write(`<h2>Voter Info</h2>
        <p>Name: ${v.name}</p>
        <p>EPIC: ${v.voterID}</p>
        <p>Ward: ${v.ward}</p>
        <p>Mobile: ${v.mobile}</p>
        <p>Status: ${v.status}</p>`);
      win.print();
    };

    div.querySelector(".deleteBtn").onclick=()=>{
      if(confirm(`Delete voter ${v.name}?`)){
        remove(dbRef(db,"voters/"+v.voterID.replace(/\W/g,"_")));
      }
    };
  });
  applyFilter();
});

// Filter + Search
let activeFilter="all";
document.querySelectorAll(".filterBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    activeFilter=btn.dataset.filter;
    document.querySelectorAll(".filterBtn").forEach(b=>b.classList.remove("ring-2","ring-black"));
    btn.classList.add("ring-2","ring-black");
    applyFilter();
  });
});

document.getElementById("searchBox").addEventListener("keyup", applyFilter);

function applyFilter(){
  const keyword=document.getElementById("searchBox").value.toLowerCase();
  const items=document.querySelectorAll(".item");
  let approvedTotal=0,opponentTotal=0,antiTotal=0;

  items.forEach(i=>{
    const name=i.dataset.name;
    const epic=i.dataset.epic;
    const ward=i.dataset.ward;
    const mobile=i.dataset.mobile;
    const status=i.dataset.status;

    const matchSearch = name.includes(keyword) || epic.includes(keyword) || ward.includes(keyword) || mobile.includes(keyword);
    const matchFilter = (activeFilter=="all"||activeFilter==status);

    if(matchSearch && matchFilter){ i.classList.remove("hidden"); }
    else { i.classList.add("hidden"); }

    if(status=="approved") approvedTotal++;
    else if(status=="opponent") opponentTotal++;
    else antiTotal++;
  });

  document.getElementById("countApproved").innerText=approvedTotal;
  document.getElementById("countOpponent").innerText=opponentTotal;
  document.getElementById("countAnti").innerText=antiTotal;
}
</script>
</body>
</html>
