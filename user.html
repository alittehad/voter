<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List with Image Upload & Edit</title>
<style>
body { font-family: Arial; margin:0; padding:10px; background:#f3f3f3; }
h2 { text-align:center; margin-bottom:15px; }
input, textarea { width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:2px solid #777; font-size:16px; }
.list-item { padding:14px; background:white; border:2px solid #aaa; margin-bottom:10px; border-radius:12px; cursor:pointer; transition:.3s; font-size:16px; }
.list-item:hover { transform:scale(1.03); box-shadow:0 0 10px gray; word-wrap:break-word; }

#popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:flex-start; overflow-y:auto; padding:20px; box-sizing:border-box; }
.card { width:95%; max-width:400px; background:white; border:3px solid black; border-radius:15px; padding:20px; text-align:left; box-sizing:border-box; }
.card img { width:100%; max-height:200px; object-fit:contain; margin-bottom:10px; }

.btn { padding:12px; width:100%; margin-top:10px; background:#008cff; color:white; border:none; cursor:pointer; font-size:16px; border-radius:10px; box-shadow:0 4px 0 #003f7f; }
.btn:active { transform:translateY(4px); box-shadow:0 1px 0 #003f7f; }
.close-btn { background:red; box-shadow:0 4px 0 #7a0000; }
.delete-btn { background:#ff5722; box-shadow:0 4px 0 #aa2300; }
.color-box { width:40px; height:40px; border-radius:10px; margin:6px; cursor:pointer; border:2px solid black; display:inline-block; }

@media(max-width:500px){ 
    input,textarea{font-size:14px;padding:10px} 
    .list-item{font-size:14px;padding:12px} 
    .btn{font-size:14px;padding:10px} 
    .color-box{width:35px;height:35px;margin:4px} 
    .card{padding:15px} 
    .card img{max-height:150px;} 
}
</style>
</head>
<body>

<h2>üó≥ Voter List</h2>
<input id="search" placeholder="Search Name, EPIC, AC No, Part No...">
<div id="list"></div>

<!-- POPUP -->
<div id="popup">
    <div class="card" id="cardBox">
        <p><b>üë§ Name:</b> <input id="pNameInput" type="text"></p>
        <p><b>üÜî EPIC:</b> <span id="pEpic"></span></p>
        <p><b>üèõ AC No:</b> <input id="pAc" type="number"></p>
        <p><b>üìç Part No:</b> <input id="pPart" type="number"></p>
        <p><b>üè† Address:</b> <input id="pAddress" type="text"></p>
        <p><b>üó≥ Booth:</b> <input id="pVoteAddress" type="text"></p>

        <img id="voterImage" src="" alt="" style="display:none;"/>
        <div id="loadingImg" style="display:none;">Uploading...</div>

        <label><b>Upload Image:</b></label>
        <input type="file" id="imageInput" accept="image/*">
        <button class="btn" id="uploadBtn">Upload Image</button>
        <button class="btn delete-btn" id="deleteBtn">Delete Image</button>

        <label><b>Sender Message:</b></label>
        <textarea id="senderNote" placeholder="Your note..." rows="4"></textarea>

        <div>
            <div class="color-box" onclick="setColor('#fca5a5')" style="background:#fca5a5"></div>
            <div class="color-box" onclick="setColor('#a5f7c5')" style="background:#a5f7c5"></div>
            <div class="color-box" onclick="setColor('#9fd1ff')" style="background:#9fd1ff"></div>
        </div>

        <button class="btn" onclick="saveVoter()">üíæ Save</button>
        <button class="btn" onclick="printCard()">üñ® Print</button>
        <button class="btn" onclick="sendWA()">üì© WhatsApp Send</button>
        <button class="btn close-btn" onclick="closePopup()">‚ùå Close</button>
    </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);

let voters={}, selected=null, selectedFile=null, globalSenderNote="";

// Load data
firebase.database().ref("/").once("value").then(snap=>{
    const data = snap.val();
    globalSenderNote = data.GlobalSenderNote || "";
    voters = data.Voters || {};
    showList(voters);
});

// Show list
function showList(data){
    const box = document.getElementById("list");
    box.innerHTML = "";
    Object.values(data).forEach(v=>{
        let div = document.createElement("div");
        div.className = "list-item";
        div.style.background = v.Color || "white";
        div.style.borderColor = v.Color || "#aaa";
        div.dataset.epic = v.EPIC;
        div.innerHTML = `<b>${v.Name}</b><br>üÜî ${v.EPIC} | üèõ AC:${v.AcNo} | üìç Part:${v.PartNo} | üó≥ Booth:${v.VotingAddress || "NA"}`;
        div.onclick = ()=>openPopup(v);
        box.appendChild(div);
    });
}

// Open popup
function openPopup(v){
    selected = v;
    document.getElementById("pNameInput").value = v.Name;
    document.getElementById("pEpic").innerText = v.EPIC;
    document.getElementById("pAc").value = v.AcNo;
    document.getElementById("pPart").value = v.PartNo;
    document.getElementById("pAddress").value = v.Address || "";
    document.getElementById("pVoteAddress").value = v.VotingAddress || "";
    document.getElementById("senderNote").value = v.SenderNote || globalSenderNote || "";
    document.getElementById("cardBox").style.background = v.Color || "white";

    const img = document.getElementById("voterImage");
    if(v.ImageURL){ img.src=v.ImageURL; img.style.display="block"; } 
    else { img.style.display="none"; }

    document.getElementById("popup").style.display = "flex";
}

// Close popup
function closePopup(){ document.getElementById("popup").style.display="none"; }

// File select + preview
document.getElementById("imageInput").addEventListener("change", e => {
    selectedFile = e.target.files[0];
    if(selectedFile){
        const reader = new FileReader();
        reader.onload = function(evt){
            const img = document.getElementById("voterImage");
            img.src = evt.target.result;
            img.style.display="block";
        }
        reader.readAsDataURL(selectedFile);
    }
});

// Upload image
document.getElementById("uploadBtn").addEventListener("click", () => {
    if(!selectedFile || !selected) return alert("Select a file first!");
    document.getElementById("loadingImg").style.display="block";
    const ref = firebase.storage().ref(`voterImages/${selected.EPIC.replace(/\./g,'_')}`);
    ref.put(selectedFile).then(()=> ref.getDownloadURL()).then(url=>{
        document.getElementById("voterImage").src = url;
        document.getElementById("voterImage").style.display="block";
        firebase.database().ref(`Voters/${selected.EPIC.replace(/\./g,'_')}`).update({ImageURL:url});
        selected.ImageURL = url; 
        selectedFile=null;
        document.getElementById("loadingImg").style.display="none";
        alert("Image uploaded successfully!");
    }).catch(err=>{ 
        alert("Upload failed: "+err.message); 
        document.getElementById("loadingImg").style.display="none"; 
    });
});

// Delete image
document.getElementById("deleteBtn").addEventListener("click", ()=>{
    if(!selected || (!selected.ImageURL && !selectedFile)) return alert("No image to delete!");
    const ref = firebase.storage().ref(`voterImages/${selected.EPIC.replace(/\./g,'_')}`);
    ref.delete().then(()=>{
        document.getElementById("voterImage").style.display="none";
        firebase.database().ref(`Voters/${selected.EPIC.replace(/\./g,'_')}`).update({ImageURL:""});
        selected.ImageURL = null;
        selectedFile = null;
        alert("Image deleted successfully!");
    }).catch(err=>alert("Delete failed: "+err.message));
});

// Save voter info
function saveVoter(){
    if(!selected) return;
    let updates = {
        Name: document.getElementById("pNameInput").value || selected.Name,
        AcNo: document.getElementById("pAc").value,
        PartNo: document.getElementById("pPart").value,
        Address: document.getElementById("pAddress").value,
        VotingAddress: document.getElementById("pVoteAddress").value,
        SenderNote: document.getElementById("senderNote").value
    };
    firebase.database().ref(`Voters/${selected.EPIC.replace(/\./g,'_')}`).update(updates);
    Object.assign(selected, updates);
    showList(voters);
    alert("Voter info saved!");
}

// Set color
function setColor(c){
    document.getElementById("cardBox").style.background = c;
    if(selected){
        firebase.database().ref(`Voters/${selected.EPIC.replace(/\./g,'_')}`).update({Color:c});
        selected.Color = c;
        document.querySelectorAll(".list-item").forEach(item=>{
            if(item.dataset.epic===selected.EPIC){ item.style.background=c; item.style.borderColor=c; }
        });
    }
}

// Print
function printCard(){ window.print(); }

// WhatsApp
function sendWA(){
    if(!selected) return;
    let note = document.getElementById("senderNote").value || "‚Äî";
    firebase.database().ref("GlobalSenderNote").set(note);
    firebase.database().ref(`Voters/${selected.EPIC.replace(/\./g,'_')}`).update({SenderNote:note});
    let text = `*Voter Info*%0A%0Aüë§ ${selected.Name}%0AüÜî EPIC: ${selected.EPIC}%0Aüèõ AC: ${selected.AcNo}%0Aüìç Part: ${selected.PartNo}%0Aüè† Address: ${selected.Address || "NA"}%0Aüó≥ Booth: ${selected.VotingAddress || "NA"}%0A%0Aüìù Message: ${note}`;
    window.open(`https://wa.me/?text=${text}`);
}

// Search
document.getElementById("search").addEventListener("input", e=>{
    let t = e.target.value.toLowerCase();
    let f = Object.values(voters).filter(v=>v.Name.toLowerCase().includes(t) || v.EPIC.toLowerCase().includes(t) || String(v.AcNo).includes(t) || String(v.PartNo).includes(t) || (v.Address||"").toLowerCase().includes(t) || (v.VotingAddress||"").toLowerCase().includes(t));
    showList(f);
});
</script>
</body>
</html>
