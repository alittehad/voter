<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter Management</title>

<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border: 1px solid #999; }
    tr:hover { background: #e2e8f0; cursor: pointer; }
    
    /* Popup Card */
    #card {
        display:none;
        position:fixed;
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        background:white;
        padding:20px;
        width:350px;
        border-radius:12px;
        box-shadow:0px 0px 20px rgba(0,0,0,0.25);
    }
    #closeBtn{ float:right; cursor:pointer; font-weight:bold; font-size:20px; }

    button{
        padding:8px 12px;
        margin:4px;
        border:none;
        cursor:pointer;
        border-radius:6px;
        background:#2563eb;
        color:white;
    }
    #loginBtn{ background:#16a34a; }
</style>
</head>
<body>

<h2>ðŸ—³ Election Voter Directory</h2>

<button id="loginBtn">Login with Google</button>
<p id="userStatus" style="font-weight:bold;color:green;"></p>

<input id="search" placeholder="Search Name, EPIC, Part, AC..." style="width:100%; padding:10px; margin-top:10px;">

<table>
<thead>
<tr>
    <th>EPIC</th>
    <th>Name</th>
    <th>AC No</th>
    <th>Part No</th>
    <th>Action</th>
</tr>
</thead>
<tbody id="voterList"></tbody>
</table>

<!-- Popup Card -->
<div id="card">
    <span id="closeBtn" onclick="closeCard()">âœ–</span>
    <h3 id="cName"></h3>
    <p><b>EPIC:</b> <span id="cEpic"></span></p>
    <p><b>AC No:</b> <span id="cAc"></span></p>
    <p><b>Part No:</b> <span id="cPart"></span></p>
    <p><b>Description:</b> <span id="cDesc"></span></p>

    <label><b>Change Color:</b></label><br>
    <input type="color" id="colorPicker"><br><br>

    <button onclick="printVoter()">Print</button>
    <button onclick="sendWhatsApp()">Send WhatsApp</button>
</div>


<script type="module">

// ---------- Firebase ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const firebaseConfig = {
    databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
const provider = new GoogleAuthProvider();

let VOTERS = {};
let selectedKey = null;


// ---------- LOGIN ----------
document.getElementById("loginBtn").onclick = () => signInWithPopup(auth, provider);

onAuthStateChanged(auth, user=>{
    if(user){
        document.getElementById("userStatus").innerText = "Logged in as: " + user.email;
        document.getElementById("loginBtn").style.display="none";
    }
});


// ---------- LOAD DATA ----------
onValue(ref(db,"Voters"), snap=>{
    VOTERS = snap.val();
    loadTable();
});


// ---------- TABLE RENDER ----------
function loadTable(){
    const tbody = document.getElementById("voterList");
    tbody.innerHTML = "";
    const q = document.getElementById("search").value.toLowerCase();

    Object.keys(VOTERS).forEach(key=>{
        const v = VOTERS[key];

        if(JSON.stringify(v).toLowerCase().includes(q)){

            const row = document.createElement("tr");
            row.style.background = v.Color || "";

            row.innerHTML = `
                <td>${v.Epic}</td>
                <td>${v.Name}</td>
                <td>${v.AcNo}</td>
                <td>${v.PartNo}</td>
                <td><button onclick="openCard('${key}')">View</button></td>
            `;
            tbody.appendChild(row);
        }
    });
}

document.getElementById("search").oninput = loadTable;


// ---------- OPEN CARD ----------
window.openCard = (key)=>{
    const v = VOTERS[key];
    selectedKey = key;

    document.getElementById("cName").innerText = v.Name;
    document.getElementById("cEpic").innerText = v.Epic;
    document.getElementById("cAc").innerText = v.AcNo;
    document.getElementById("cPart").innerText = v.PartNo;
    document.getElementById("cDesc").innerText = v.Description || "â€”";

    document.getElementById("colorPicker").value = v.Color || "#ffffff";
    document.getElementById("card").style.background = v.Color || "#fff";

    document.getElementById("card").style.display="block";
};


// ---------- COLOR UPDATE ----------
document.getElementById("colorPicker").onchange = e=>{
    const newColor = e.target.value;
    update(ref(db,"Voters/"+selectedKey),{Color:newColor});
    document.getElementById("card").style.background=newColor;
    loadTable();
};


// ---------- PRINT ----------
window.printVoter = ()=>{
    const html = `
        <h2>${document.getElementById("cName").innerText}</h2>
        <p><b>EPIC:</b> ${document.getElementById("cEpic").innerText}</p>
        <p><b>AC No:</b> ${document.getElementById("cAc").innerText}</p>
        <p><b>Part No:</b> ${document.getElementById("cPart").innerText}</p>
        <p><b>Description:</b> ${document.getElementById("cDesc").innerText}</p>
        <hr><p>Generated from Election Management System</p>
    `;

    const win = window.open("");
    win.document.write(html);
    win.print();
    win.close();
};


// ---------- WHATSAPP SEND ----------
window.sendWhatsApp = ()=>{
    let sender = prompt("Sender Message à¤²à¤¿à¤–à¥‡à¤‚ (optional):");
    const msg = `
${sender ? sender+"\n\n":""}
Voter Details:
Name: ${document.getElementById("cName").innerText}
EPIC: ${document.getElementById("cEpic").innerText}
AC: ${document.getElementById("cAc").innerText}
Part: ${document.getElementById("cPart").innerText}
Description: ${document.getElementById("cDesc").innerText}
    `;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
};

window.closeCard = ()=>document.getElementById("card").style.display="none";

</script>
</body>
</html>
