<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voter Management Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{--bg:#eef2ff;--card:#fff}
  body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1100px;margin:24px auto;padding:12px;}
  .heading {font-size:clamp(1.6rem,3vw,2.2rem);font-weight:800;text-align:center;margin-bottom:18px;color:#0f172a;transform: perspective(500px) rotateX(8deg);text-shadow:0 1px 0 rgba(255,255,255,0.5),0 6px 12px rgba(2,6,23,0.12),0 18px 36px rgba(2,6,23,0.10);letter-spacing:0.6px;}
  .subhead{ text-align:center;color:#334155;margin-bottom:18px;font-weight:600;}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:6px 6px 18px rgba(2,6,23,0.06);}
  .btn {cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:600;font-size:12px}
  .btn-blue{background:#2563eb;color:white}
  .btn-green{background:#16a34a;color:white}
  .btn-yellow{background:#facc15;color:#111}
  .btn-red{background:#dc2626;color:white}
  .btn-gray{background:#6b7280;color:white}
  .table-container{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:300px;background:white;border-radius:6px;overflow:hidden}
  th,td{padding:6px;border:1px solid #e6e9ef;text-align:left;white-space:nowrap;font-size:13px}
  thead tr{background:#ebf8ff;font-weight:700}
  tr:hover{background:#f7f9ff}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:700;font-size:11px}
  .status-counts{display:flex;gap:12px;margin-bottom:8px;font-size:13px;font-weight:600}
  @media (max-width:600px){ table{min-width:250px} }
</style>
</head>
<body>
  <div class="container">
    <h1 class="heading">Voter Management Panel</h1>
    <p class="subhead">Table view / Card view / WhatsApp / Print</p>

    <div id="loginDiv" class="card text-center">
      <h2 class="text-xl font-bold text-blue-700">Login to Access Voter Panel</h2>
      <button id="googleLoginBtn" class="btn btn-blue mt-4">Login with Google</button>
    </div>

    <div id="panelDiv" class="hidden">
      <div class="status-counts" id="statusCounts"></div>
      <div class="card flex gap-4 items-center mb-2">
        <input id="searchVoter" placeholder="Search by Name / EPIC..." class="w-full border p-2 rounded text-sm" />
        <textarea id="senderDesc" placeholder="Sender Description" class="border p-2 rounded text-sm" rows="2"></textarea>
      </div>
      <div id="voterList" class="table-container card"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref as dbRef, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase(app);
const loginDiv = document.getElementById("loginDiv");
const panelDiv = document.getElementById("panelDiv");
const loginBtn = document.getElementById("googleLoginBtn");
const voterListDiv = document.getElementById("voterList");
const searchInput = document.getElementById("searchVoter");
const senderDescEl = document.getElementById("senderDesc");
const statusCountsDiv = document.getElementById("statusCounts");
const FIXED_SENDER_IMAGE = "https://i.ibb.co/LhDpnZFn/khatik-imase.jpg";

let voterData = [];

loginBtn.onclick = ()=>{
  signInWithPopup(auth,provider).then(res=>{}).catch(err=>alert(err.message));
};

onAuthStateChanged(auth,user=>{
  if(user){ loginDiv.classList.add("hidden"); panelDiv.classList.remove("hidden"); loadVoters(); }
  else{ loginDiv.classList.remove("hidden"); panelDiv.classList.add("hidden"); }
});

function loadVoters(){
  onValue(dbRef(db,"voters"),snap=>{
    voterData = [];
    snap.forEach(c=>voterData.push({id:c.key,...c.val()}));
    renderTable(voterData);
    updateStatusCounts();
  });
}

function updateStatusCounts(){
  const counts = {approved:0,opponent:0,anti:0};
  voterData.forEach(v=>{ counts[v.status] = (counts[v.status]||0)+1; });
  statusCountsDiv.innerHTML = `Approved: ${counts.approved} | Opponent: ${counts.opponent} | Anti: ${counts.anti}`;
}

function renderTable(list){
  let html = `<table><thead><tr><th>Name</th><th>EPIC</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>`;
  voterListDiv.innerHTML = html;
  const tbody = voterListDiv.querySelector("tbody");
  list.forEach(v=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.name||''}</td><td>${v.voterID||v.epic||''}</td><td>${v.status||''}</td>
      <td><button class='btn btn-blue btn-sm viewBtn'>View</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector(".viewBtn").onclick = ()=>showVoterCard(v);
  });
}

function showVoterCard(v){
  const existing = document.getElementById("voterDetailCard"); if(existing) existing.remove();
  const div = document.createElement("div"); div.id="voterDetailCard"; div.className="card";
  const relLine = v.fatherName?v.fatherName:v.husbandName?v.husbandName:v.relationName||'';
  div.innerHTML = `<div style='display:flex;justify-content:space-between'><div>
<h3>${v.name||''}</h3>
<p>${relLine} â€¢ EPIC: ${v.voterID||v.epic||''}</p>
</div>
<div><button class='btn btn-red closeBtn'>Close</button></div></div>
<p>House: ${v.houseNo||''} | Room: ${v.roomNo||''}</p>
<p>Polling: ${v.pollingAddress||''} | Booth: ${v.booth||''} | Part: ${v.partNo||v.part||''} | AC: ${v.acNo||v.ac||''}</p>
<p>Age: ${v.age||''} | Mobile: ${v.mobile||''}</p>
<div style='display:flex;gap:4px;margin-top:6px'>
<button class='btn btn-yellow approveBtn'>Approve</button>
<button class='btn btn-yellow opponentBtn'>Opponent</button>
<button class='btn btn-red antiBtn'>Anti</button>
<button class='btn btn-gray deleteBtn'>Delete</button>
<button class='btn btn-blue sendBtn'>Send WhatsApp</button>
<button class='btn btn-green printBtn'>Print</button>
</div>`;
  voterListDiv.prepend(div);

  div.querySelector('.closeBtn').onclick = ()=> div.remove();
  div.querySelector('.approveBtn').onclick = ()=>updateStatus(v,'approved');
  div.querySelector('.opponentBtn').onclick = ()=>updateStatus(v,'opponent');
  div.querySelector('.antiBtn').onclick = ()=>updateStatus(v,'anti');
  div.querySelector('.deleteBtn').onclick = ()=>{if(confirm('Delete?')){remove(dbRef(db,'voters/'+v.id));div.remove();}};

  div.querySelector('.printBtn').onclick = ()=>{
    let w=window.open();
    w.document.write(`<h2>${v.name}</h2><p>${relLine}</p><p>EPIC: ${v.voterID||v.epic}</p><p>House: ${v.houseNo}</p><p>Polling: ${v.pollingAddress}</p><p>Booth: ${v.booth}</p><p>Mobile: ${v.mobile}</p><p>Image: ${FIXED_SENDER_IMAGE}</p>`);
    w.print(); w.close();
  };

  div.querySelector('.sendBtn').onclick = ()=>{
    let msg = senderDescEl.value?senderDescEl.value+'\n\n':'';
    msg += `Voter: ${v.name}\n${relLine?relLine+' | ':''}EPIC: ${v.voterID||v.epic}\nHouse: ${v.houseNo}\nAddress: ${v.address}\nPart: ${v.part||v.partNo}\nBooth: ${v.booth}\nRoom: ${v.roomNo}\nMobile: ${v.mobile}\n\nImage: ${FIXED_SENDER_IMAGE}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
  };
}

function updateStatus(v,newStatus){
  set(dbRef(db,'voters/'+v.id),{...v,status:newStatus});
}

searchInput.addEventListener('input',(e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) renderTable(voterData);
  else renderTable(voterData.filter(v=>`${v.name||''} ${v.voterID||v.epic||''}`.toLowerCase().includes(q)));
});

</script>
</body>
</html>
