<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 10px;
    background: #f3f3f3;
}

h2 { text-align: center; margin-bottom: 15px; }

input {
    width: 100%; padding: 12px; margin-bottom: 12px;
    border-radius: 10px; border: 2px solid #777;
    font-size: 16px;
}

.list-item {
    padding: 14px; background: white; border: 2px solid #aaa;
    margin-bottom: 10px; border-radius: 12px;
    cursor: pointer; transition: .3s;
    font-size: 16px;
}
.list-item:hover { transform: scale(1.03); box-shadow:0 0 10px gray; word-wrap: break-word; }

#popup {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.7);
    display:none; justify-content:center; align-items:center;
    overflow-y: auto; padding: 10px;
}

.card {
    width: 95%; max-width: 400px;
    background:white; border:3px solid black;
    border-radius:15px; padding:20px;
    text-align:left;
    box-sizing: border-box;
}

/* Buttons */
.btn {
    padding:12px; width:100%; margin-top:10px;
    background:#008cff; color:white;
    border:none; cursor:pointer; font-size:16px;
    border-radius:10px; box-shadow:0 4px 0 #003f7f;
}
.btn:active { transform:translateY(4px); box-shadow:0 1px 0 #003f7f; }

.close-btn { background:red; box-shadow:0 4px 0 #7a0000; }

/* Color selector */
.color-box {
    width:40px; height:40px; border-radius:10px;
    margin:6px; cursor:pointer; border:2px solid black;
    display:inline-block;
}

/* PRINT MODE FIX */
@media print {
    body * { visibility: hidden; }
    #popup, #popup * { visibility: visible; }
    #popup { position: absolute; top:0; left:0; width:100%; }
    .btn, .close-btn, .color-box, #themeTitle, input { display: none !important; }
}

/* Mobile tweaks */
@media(max-width: 500px){
    input { font-size: 14px; padding:10px; }
    .list-item { font-size: 14px; padding:12px; }
    .btn { font-size: 14px; padding:10px; }
    .color-box { width:35px; height:35px; margin:4px; }
    .card { padding:15px; }
}
</style>
</head>

<body>

<h2>üó≥ Voter List</h2>
<input id="search" placeholder="Search Name, EPIC, AC No, Part No...">

<div id="list"></div>

<!-- POPUP -->
<div id="popup">
    <div class="card" id="cardBox">

        <h3 id="pName"></h3>
        <p><b>üÜî EPIC:</b> <span id="pEpic"></span></p>
        <p><b>üèõ AC No:</b> <span id="pAc"></span></p>
        <p><b>üìç Part No:</b> <span id="pPart"></span></p>
        <p><b>üè† Address:</b> <span id="pAddress"></span></p>
        <p><b>üó≥ Booth:</b> <span id="pVoteAddress"></span></p>

        <label><b>Sender Message:</b></label>
        <textarea id="senderNote" placeholder="Your note..." rows="4"
        style="width:100%;border-radius:8px;"></textarea>
        <button class="btn" style="background:orange;" onclick="deleteSenderNote()">üóë Delete Message</button>

        <h3 id="themeTitle">üé® Theme Color</h3>
        <div>
            <div class="color-box" onclick="setColor('#fca5a5')" style="background:#fca5a5"></div>
            <div class="color-box" onclick="setColor('#a5f7c5')" style="background:#a5f7c5"></div>
            <div class="color-box" onclick="setColor('#9fd1ff')" style="background:#9fd1ff"></div>
        </div>

        <button class="btn" onclick="printCard()">üñ® Print</button>
        <button class="btn" onclick="sendWA()">üì© WhatsApp Send</button>
        <button class="btn close-btn" onclick="closePopup()">‚ùå Close</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>

<script>
// Firebase Setup
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

firebase.initializeApp(firebaseConfig);

let voters = {};
let selected = null;

// Load Data
firebase.database().ref("Voters").on("value", snap => {
    voters = snap.val() || {};
    showList(voters);
});

// Show list with all details
function showList(data){
    const box = document.getElementById("list");
    box.innerHTML = "";

    Object.values(data).forEach(v => {
        let div = document.createElement("div");
        div.className = "list-item";
        div.style.background = v.Color || "white";
        div.style.borderColor = v.Color || "#aaa";
        div.innerHTML = `
            <b>${v.Name}</b><br>
            üÜî ${v.Epic} | üèõ AC:${v.AcNo} | üìç Part:${v.PartNo} | üó≥ Booth:${v.VotingAddress || "NA"}
        `;
        div.onclick = () => openPopup(v);
        box.appendChild(div);
    });
}

// Open Popup
function openPopup(v){
    selected = v;
    document.getElementById("pName").innerText = v.Name;
    document.getElementById("pEpic").innerText = v.Epic;
    document.getElementById("pAc").innerText = v.AcNo;
    document.getElementById("pPart").innerText = v.PartNo;
    document.getElementById("pAddress").innerText = v.Address || "Not Available";
    document.getElementById("pVoteAddress").innerText = v.VotingAddress || "Not Available";

    document.getElementById("cardBox").style.background = v.Color || "white";

    // Load saved sender message
    firebase.database().ref("Voters/" + v.Epic + "/SenderNote").once("value").then(snap=>{
        document.getElementById("senderNote").value = snap.val() || "";
    });

    document.getElementById("popup").style.display = "flex";
}

// Close popup
function closePopup(){
    document.getElementById("popup").style.display = "none";
}

// Color change
function setColor(c){
    document.getElementById("cardBox").style.background = c;
    firebase.database().ref("Voters/" + selected.Epic).update({ Color: c });
    showList(voters);
}

// Save Sender Message on change
document.getElementById("senderNote").addEventListener("change", function(){
    if(selected){
        firebase.database().ref("Voters/" + selected.Epic).update({ SenderNote: this.value });
    }
});

// Delete Sender Message
function deleteSenderNote(){
    if(selected){
        firebase.database().ref("Voters/" + selected.Epic).update({ SenderNote: "" }).then(()=>{
            document.getElementById("senderNote").value = "";
            alert("Sender message deleted!");
        });
    }
}

// Print
function printCard(){
    firebase.database().ref("Voters/" + selected.Epic + "/SenderNote").once("value").then(snap=>{
        document.getElementById("senderNote").value = snap.val() || "";
        window.print();
    });
}

// WhatsApp
function sendWA(){
    firebase.database().ref("Voters/" + selected.Epic + "/SenderNote").once("value").then(snap=>{
        let note = snap.val() || "";
        let text = `*Voter Information*%0A%0Aüë§ *${selected.Name}*%0AüÜî EPIC: ${selected.Epic}%0Aüèõ AC No: ${selected.AcNo}%0Aüìç Part No: ${selected.PartNo}%0Aüè† Address: ${selected.Address}%0Aüó≥ Booth: ${selected.VotingAddress}%0A%0Aüìù *Message:* ${note}`;
        window.open(`https://wa.me/?text=${text}`);
    });
}

// Search
document.getElementById("search").addEventListener("input", e=>{
    let t = e.target.value.toLowerCase();
    let f = Object.values(voters).filter(v =>
        v.Name.toLowerCase().includes(t) ||
        v.Epic.toLowerCase().includes(t) ||
        String(v.AcNo).includes(t) ||
        String(v.PartNo).includes(t)
    );
    showList(f);
});
</script>
</body>
</html>
