<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter Card Panel</title>

<!-- Firebase v8 (Best for Realtime DB + Storage) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
body { font-family: Arial; padding: 20px; background: #eef2ff; }

.card {
    width: 350px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin: auto;
    box-shadow: 0 0 10px #999;
    display:none;
}

#photoPreview {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 10px;
    background:#ddd;
}

.label { font-size: 14px; color: #444; margin-top: 10px; display:block; }
input, textarea, button {
    width: 100%; padding: 8px; margin-top: 5px;
    border-radius: 6px; border:1px solid #aaa;
}
button { background:#2563eb; color:white; border:none; margin-top:10px; cursor:pointer; }

.closeBtn {
    background:red; margin-bottom:15px;
}
</style>
</head>
<body>

<h2 style="text-align:center;">Voter Card Panel</h2>

<!-- Search EPIC -->
<input id="searchEpic" placeholder="EPIC Number">
<button onclick="loadCard()">Open Card</button>

<!-- Card Box -->
<div class="card" id="cardBox">

    <button class="closeBtn" onclick="closeCard()">Close</button>

    <img id="photoPreview" src="" alt="Voter Photo">

    <label class="label">Upload Photo</label>
    <input type="file" id="photoInput">

    <label class="label">EPIC Number</label>
    <input id="epicInput" readonly>

    <label class="label">Name</label>
    <input id="nameInput">

    <label class="label">Address</label>
    <textarea id="addressInput"></textarea>

    <label class="label">Booth Number</label>
    <input id="boothInput">

    <label class="label">Voting Address</label>
    <input id="votingAddressInput">

    <button onclick="saveData()">Save</button>
    <button onclick="printCard()">Print Card</button>
    <button onclick="sendWhatsapp()">WhatsApp Share</button>
</div>

<script>
// ================= Firebase Setup =================
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let uploadedImageURL = "";

// ================= LOAD CARD =================
function loadCard() {
    let epic = document.getElementById("searchEpic").value.trim();
    if (epic === "") { alert("EPIC डालें"); return; }

    db.ref("Voters/" + epic).once("value").then(snapshot => {
        if (!snapshot.exists()) {
            alert("Voter Not Found!");
            return;
        }

        let data = snapshot.val();

        document.getElementById("cardBox").style.display = "block";

        document.getElementById("epicInput").value = data.EPIC || epic;
        document.getElementById("nameInput").value = data.Name || "";
        document.getElementById("addressInput").value = data.Address || "";
        document.getElementById("boothInput").value = data.Booth || "";
        document.getElementById("votingAddressInput").value = data.VotingAddress || "";

        uploadedImageURL = data.ImageURL || "";
        document.getElementById("photoPreview").src = uploadedImageURL || "";
    });
}

// ================= CLOSE CARD =================
function closeCard() {
    document.getElementById("cardBox").style.display = "none";
}

// ================= PHOTO UPLOAD =================
document.getElementById("photoInput").addEventListener("change", function (e) {
    let file = e.target.files[0];
    if (!file) return;

    let epic = document.getElementById("epicInput").value.trim();
    if (epic === "") {
        alert("EPIC पहले load करो!");
        return;
    }

    // Preview
    let reader = new FileReader();
    reader.onload = function (event) {
        document.getElementById("photoPreview").src = event.target.result;
    };
    reader.readAsDataURL(file);

    // Upload to Firebase Storage
    let storageRef = storage.ref("voterPhotos/" + epic + ".jpg");
    
    storageRef.put(file).then(() => {
        storageRef.getDownloadURL().then(url => {
            uploadedImageURL = url;
            db.ref("Voters/" + epic).update({ ImageURL: url });
        });
    });
});

// ================= SAVE DATA =================
function saveData() {
    let epic = document.getElementById("epicInput").value.trim();

    let data = {
        EPIC: epic,
        Name: document.getElementById("nameInput").value,
        Address: document.getElementById("addressInput").value,
        Booth: document.getElementById("boothInput").value,
        VotingAddress: document.getElementById("votingAddressInput").value,
        ImageURL: uploadedImageURL
    };

    db.ref("Voters/" + epic).update(data);
    alert("Saved Successfully!");
}

// ================= PRINT =================
function printCard() {
    let content = document.getElementById("cardBox").innerHTML;
    let win = window.open("", "", "width=400,height=600");
    win.document.write("<html><body>" + content + "</body></html>");
    win.document.close();
    win.print();
}

// ================= WHATSAPP =================
function sendWhatsapp() {
    let msg =
        "EPIC: " + document.getElementById("epicInput").value +
        "\nName: " + document.getElementById("nameInput").value +
        "\nAddress: " + document.getElementById("addressInput").value +
        "\nBooth: " + document.getElementById("boothInput").value +
        "\nVoting Address: " + document.getElementById("votingAddressInput").value;

    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
}
</script>

</body>
</html>
