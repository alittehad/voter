<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Voter Management Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- TAILWIND CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
td, th { border: 1px solid #ddd; padding: 6px; }
img.photo { width: 55px; height: 55px; object-fit: cover; border-radius: 6px; }
</style>
</head>

<body class="bg-gray-100">

<!-- LOGIN PAGE -->
<div id="loginBox" class="flex flex-col justify-center items-center h-screen">
    <h1 class="text-3xl font-bold mb-2">Voter Management Panel</h1>
    <p class="mb-4">Login to Manage Voters</p>
    <button onclick="login()" class="bg-blue-600 text-white px-5 py-2 rounded">
        Login with Google
    </button>
    <p class="mt-3 text-sm text-gray-600">Only admins listed in database can access the panel.</p>
</div>

<!-- MAIN PANEL -->
<div id="panel" class="hidden p-5">

    <div class="flex justify-between mb-3">
        <input id="searchInput" placeholder="Search" class="px-3 py-2 border rounded w-1/3">

        <div class="flex gap-2">
            <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
        </div>
    </div>

    <table class="w-full bg-white">
        <thead class="bg-blue-600 text-white">
            <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>EPIC</th>
                <th>State</th>
                <th>District</th>
                <th>AC</th>
                <th>Part</th>
                <th>Booth</th>
                <th>Address</th>
                <th>Approve</th>
                <th>Opponent</th>
                <th>Anti</th>
                <th>WhatsApp</th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="voterTable"></tbody>
    </table>
</div>


<!-- ------------ EDIT POPUP ------------ -->
<div id="editBox" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center">
    <div class="bg-white p-5 rounded w-96">
        <h2 class="text-xl font-bold mb-3">Edit Voter</h2>

        <input id="editName" placeholder="Name" class="w-full border p-2 mb-2">
        <input id="editEpic" placeholder="EPIC" class="w-full border p-2 mb-2">
        <input id="editPart" placeholder="Part No" class="w-full border p-2 mb-2">
        <input id="editBooth" placeholder="Booth" class="w-full border p-2 mb-2">
        <input id="editAddress" placeholder="Address" class="w-full border p-2 mb-2">

        <label>Photo Upload:</label>
        <input type="file" id="editPhoto" class="mb-3">

        <div class="flex justify-between">
            <button onclick="saveEdit()" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
            <button onclick="closeEdit()" class="bg-gray-400 px-4 py-2 rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- --------- FIREBASE ---------- -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, update, set, onValue }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


// ⭐⭐ CHANGE THIS ⭐⭐
const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    databaseURL: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
};


// INIT
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

let voterData = [];
let editKey = "";


// -------- LOGIN ----------
window.login = async () => {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    const adminSnap = await get(ref(db, "admins/" + user.uid));
    if (!adminSnap.exists()) {
        alert("Not an admin");
        await signOut(auth);
        return;
    }
    loadPanel();
};


// -------- LOGOUT ----------
window.logout = async () => {
    await signOut(auth);
    location.reload();
};


// -------- LOAD PANEL ----------
async function loadPanel() {
    loginBox.classList.add("hidden");
    panel.classList.remove("hidden");

    onValue(ref(db, "voters"), snap => {
        if (snap.exists()) {
            const obj = snap.val();
            voterData = Object.keys(obj).map(k => ({ _key: k, ...obj[k] }));
            renderTable(voterData);
        }
    });
}


// -------- TABLE RENDER ----------
function renderTable(list) {
    voterTable.innerHTML = "";
    list.forEach(v => {
        voterTable.innerHTML += `
        <tr>
            <td><img class="photo" src="${v.photoURL || ''}"></td>
            <td>${v.name || ''}</td>
            <td>${v.epic || ''}</td>
            <td>${v.state || ''}</td>
            <td>${v.district || ''}</td>
            <td>${v.acNo || ''}</td>
            <td>${v.partNo || ''}</td>
            <td>${v.booth || ''}</td>
            <td>${v.address || ''}</td>

            <td><button onclick="mark('${v._key}','approved')" class="px-2 bg-green-600 text-white">+</button></td>
            <td><button onclick="mark('${v._key}','opponent')" class="px-2 bg-yellow-600 text-white">O</button></td>
            <td><button onclick="mark('${v._key}','anti')" class="px-2 bg-red-600 text-white">X</button></td>

            <td><button onclick="sendWhatsApp('${v._key}')" class="px-3 bg-blue-600 text-white">WA</button></td>

            <td><button onclick="openEdit('${v._key}')" class="px-3 bg-black text-white">Edit</button></td>
        </tr>`;
    });
}


// -------- MARK STATUS ----------
window.mark = (key, field) => {
    update(ref(db, "voters/" + key), { [field]: Date.now() });
};


// -------- WHATSAPP SHARE ----------
window.sendWhatsApp = (key) => {
    const v = voterData.find(x => x._key === key);
    if (!v) return;

    const text = `Name: ${v.name}
EPIC: ${v.epic}
Part: ${v.partNo}
Booth: ${v.booth}
Address: ${v.address}`;

    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
};


// -------- EDIT FORM ----------
window.openEdit = (key) => {
    editKey = key;
    const v = voterData.find(x => x._key === key);
    editName.value = v.name;
    editEpic.value = v.epic;
    editPart.value = v.partNo;
    editBooth.value = v.booth;
    editAddress.value = v.address;
    editBox.classList.remove("hidden");
};

window.closeEdit = () => editBox.classList.add("hidden");


// -------- SAVE EDIT ----------
window.saveEdit = async () => {
    const data = {
        name: editName.value,
        epic: editEpic.value,
        partNo: editPart.value,
        booth: editBooth.value,
        address: editAddress.value
    };

    const file = editPhoto.files[0];
    if (file) {
        const storageRef = sRef(storage, "voter_photos/" + editKey + ".jpg");
        await uploadBytes(storageRef, file);
        data.photoURL = await getDownloadURL(storageRef);
    }

    await update(ref(db, "voters/" + editKey), data);
    closeEdit();
};


// -------- SEARCH ----------
searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const res = voterData.filter(v =>
        (v.name + v.epic + v.address + v.state + v.district).toLowerCase().includes(q)
    );
    renderTable(res);
});

</script>

</body>
</html>
