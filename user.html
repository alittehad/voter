<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voter System — Full</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background:#f0f2f5; font-family: system-ui, sans-serif; }
  .button-3d {
    background: linear-gradient(145deg,#4f46e5,#3b36c4);
    color: #fff; font-weight:700; padding:0.35rem 0.6rem; border-radius:8px;
    box-shadow: 3px 3px 6px rgba(0,0,0,0.4), -3px -3px 6px rgba(255,255,255,0.03);
    transition: transform .14s, box-shadow .14s; font-size:0.9rem;
  }
  .button-3d:active { transform: translateY(1px); }
  .small-3d {
    padding:0.25rem .45rem; font-size:0.82rem; border-radius:6px;
    box-shadow: 2px 2px 4px rgba(0,0,0,0.35), -2px -2px 4px rgba(255,255,255,0.02);
  }
  .color-btn { width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid rgba(0,0,0,0.12) }
  .modal-bg { position:fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .modal { width:95%; max-width:520px; background:#fff; border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
  .close-x { position:absolute; right:12px; top:8px; cursor:pointer; font-weight:700; font-size:18px; }
  table td, table th { padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align:middle; }
  img.thumb { max-height:110px; border-radius:8px; display:block; margin-top:8px; }
  .hidden { display:none !important; }
</style>
</head>
<body class="p-4">

<!-- LOGIN -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center">
  <div class="text-center">
    <h1 class="text-2xl font-bold mb-4">Voter Management</h1>
    <button id="loginBtn" class="button-3d px-6 py-3 text-lg">Login with Google</button>
    <p class="text-sm text-gray-600 mt-3">Admin can add/edit; others can view & send.</p>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <!-- Sender panel -->
  <div class="bg-white p-3 rounded shadow mb-4">
    <div class="flex items-start gap-4">
      <div class="flex-1">
        <label class="block font-medium">Sender message (will be sent with voter info)</label>
        <textarea id="senderText" class="border p-2 w-full mt-1 rounded" rows="2" placeholder="Sender ka description ya message yahan likho..."></textarea>
      </div>
      <div class="w-48">
        <label class="block font-medium">Sender poster</label>
        <input id="senderFile" type="file" accept="image/*" class="mt-1" />
        <div id="senderPreviewWrap" class="mt-2 hidden">
          <img id="senderPreview" class="thumb" src="" alt="sender poster" />
        </div>
        <div class="flex gap-2 mt-2">
          <button class="button-3d small-3d" onclick="saveSender()">Save</button>
          <button class="button-3d small-3d bg-red-600" onclick="deleteSenderPoster()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex gap-3 mb-3 items-center">
    <div class="flex-1">
      <input id="searchInput" class="border p-2 w-full rounded" placeholder="Search by name or EPIC..." />
    </div>
    <div>
      <button id="addDemo" class="button-3d small-3d">Add demo voter</button>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white rounded shadow overflow-auto">
    <table id="voterTable" class="w-full">
      <thead class="bg-gray-100">
        <tr>
          <th style="width:45%">Name</th>
          <th style="width:20%">EPIC</th>
          <th style="width:15%">Part</th>
          <th style="width:20%">Action</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-bg hidden">
  <div class="modal relative">
    <div class="close-x" onclick="closeModal()">✖</div>
    <div id="modalContent"></div>
  </div>
</div>

<script type="module">
/* ===== Firebase imports ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, onValue, get, update, set, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

/* ====== Your Firebase config (kept as you provided, storageBucket corrected) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);
const auth = getAuth();

/* ===== Admin list ===== */
const ADMIN_EMAILS = ["ngogrant454@gmail.com","zarafix3@gmail.com"];

/* ===== UI elements ===== */
const loginScreen = document.getElementById('loginScreen');
const loginBtn = document.getElementById('loginBtn');
const appDiv = document.getElementById('app');
const tableBody = document.getElementById('tableBody');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const searchInput = document.getElementById('searchInput');

const senderText = document.getElementById('senderText');
const senderFile = document.getElementById('senderFile');
const senderPreview = document.getElementById('senderPreview');
const senderPreviewWrap = document.getElementById('senderPreviewWrap');

let currentUser = null;
let isAdmin = false;
let voters = {};
let sender = { text: "", img: "" };

/* ===== Login ===== */
loginBtn.onclick = async () => {
  try {
    const result = await signInWithPopup(auth, new GoogleAuthProvider());
    currentUser = result.user;
    isAdmin = ADMIN_EMAILS.includes(currentUser.email);
    loginScreen.classList.add('hidden');
    appDiv.classList.remove('hidden');
    init();
  } catch (e) {
    alert("Login failed: "+e.message);
    console.error(e);
  }
};

/* ===== Init listeners ===== */
function init(){
  // load sender info
  onValue(ref(db, 'Sender'), snap => {
    sender = snap.val() || { text: "", img: "" };
    senderText.value = sender.text || "";
    if (sender.img) { senderPreview.src = sender.img; senderPreviewWrap.classList.remove('hidden'); } else { senderPreviewWrap.classList.add('hidden'); }
  });

  // load voters
  onValue(ref(db, 'Voters'), snap => {
    voters = snap.val() || {};
    renderTable();
  });

  // search
  searchInput.oninput = renderTable;

  // sender file change preview (local)
  senderFile.onchange = () => {
    const f = senderFile.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    senderPreview.src = url;
    senderPreviewWrap.classList.remove('hidden');
  };

  // demo add (quick)
  document.getElementById('addDemo').onclick = async () => {
    if (!isAdmin) return alert("Only admin can add demo");
    const id = 'DEMO' + Date.now();
    await set(ref(db, 'Voters/' + id), {
      Epic: id,
      Name: "Demo Voter " + id.slice(-4),
      PartNo: Math.floor(Math.random()*500),
      AcNo: 131,
      Description: "",
      Address: "",
      Booth: "",
      RelationType: "Father",
      Relation: "",
      Color: "#ffffff",
      Image: ""
    });
  };
}

/* ===== Render table ===== */
function renderTable(){
  tableBody.innerHTML = '';
  const q = (searchInput.value||'').toLowerCase();
  Object.keys(voters).sort().forEach(key => {
    const v = voters[key];
    if (!v) return;
    const text = (v.Name || '') + ' ' + (v.Epic || '') + ' ' + (v.PartNo||'');
    if (q && text.toLowerCase().indexOf(q) === -1) return;
    const tr = document.createElement('tr');
    tr.style.background = v.Color || '#fff';
    tr.innerHTML = `
      <td>${escapeHtml(v.Name||'')}</td>
      <td>${escapeHtml(v.Epic||key)}</td>
      <td>${escapeHtml(v.PartNo||'')}</td>
      <td>
        <div style="display:flex;gap:8px">
          <button class="button-3d small-3d" onclick="openCard('${key}')">View</button>
          ${isAdmin ? `<button class="button-3d small-3d bg-red-600" style="padding:.25rem .5rem" onclick="deleteVoter('${key}')">Del</button>` : ''}
        </div>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

/* ===== Modal open / close ===== */
window.openCard = async function(key){
  const v = voters[key];
  if (!v) return alert("Voter data missing");
  // build modal content
  modalContent.innerHTML = '';

  const html = document.createElement('div');
  html.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:18px">${escapeHtml(v.Name)}</div>
          <div style="color:#555">EPIC: ${escapeHtml(v.Epic)}</div>
        </div>
        <div style="text-align:right">
          <div style="color:#444">AC: ${escapeHtml(v.AcNo||'')}</div>
          <div style="color:#444">Part: ${escapeHtml(v.PartNo||'')}</div>
        </div>
      </div>

      <div>
        <label class="font-medium">Voter image (admin only)</label>
        <input type="file" id="voterFile" accept="image/*" style="margin-top:6px"/>
        ${v.Image ? `<img src="${v.Image}" class="thumb" />` : ''}
      </div>

      <div>
        <label class="font-medium">Description / Notes</label>
        <textarea id="fieldDesc" rows="2" class="border w-full p-2 rounded mt-1">${escapeHtml(v.Description||'')}</textarea>
      </div>

      <div>
        <label class="font-medium">Address</label>
        <textarea id="fieldAddress" rows="2" class="border w-full p-2 rounded mt-1">${escapeHtml(v.Address||'')}</textarea>
      </div>

      <div>
        <label class="font-medium">Voting Booth Address</label>
        <textarea id="fieldBooth" rows="2" class="border w-full p-2 rounded mt-1">${escapeHtml(v.Booth||'')}</textarea>
      </div>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label class="font-medium">Relation type</label>
          <select id="fieldRelType" class="border w-full p-1 rounded mt-1">
            <option ${v.RelationType==='Father'?'selected':''}>Father</option>
            <option ${v.RelationType==='Husband'?'selected':''}>Husband</option>
          </select>
        </div>
        <div style="flex:1">
          <label class="font-medium">Relation name</label>
          <input id="fieldRel" class="border w-full p-2 rounded mt-1" value="${escapeHtml(v.Relation||'')}"/>
        </div>
      </div>

      <div style="display:flex;gap:8px; margin-top:6px">
        <button class="button-3d small-3d" id="saveBtn">Save</button>
        <button class="button-3d small-3d" id="printBtn">Print</button>
        <button class="button-3d small-3d" id="whatsappBtn">Send (WhatsApp)</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <div style="font-weight:600">Card color:</div>
        <div class="color-btn" style="background:#fde68a" onclick="changeColor('${key}','#fde68a')"></div>
        <div class="color-btn" style="background:#a5f3fc" onclick="changeColor('${key}','#a5f3fc')"></div>
        <div class="color-btn" style="background:#fca5a5" onclick="changeColor('${key}','#fca5a5')"></div>
      </div>

    </div>
  `;
  modalContent.appendChild(html);
  // attach actions
  document.getElementById('saveBtn').onclick = async () => {
    if (!isAdmin) return alert("Only admin can save");
    const f = document.getElementById('voterFile').files[0];
    const updates = {};
    if (f) {
      const storageRef = sRef(storage, `Voters/${key}.jpg`);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);
      updates.Image = url;
    }
    updates.Description = document.getElementById('fieldDesc').value;
    updates.Address = document.getElementById('fieldAddress').value;
    updates.Booth = document.getElementById('fieldBooth').value;
    updates.RelationType = document.getElementById('fieldRelType').value;
    updates.Relation = document.getElementById('fieldRel').value;
    await update(ref(db, 'Voters/' + key), updates);
    alert('Saved and updated for all users');
  };

  document.getElementById('printBtn').onclick = () => {
    // print text-only (no images)
    const name = v.Name||'';
    const epic = v.Epic||'';
    const desc = document.getElementById('fieldDesc').value;
    const address = document.getElementById('fieldAddress').value;
    const booth = document.getElementById('fieldBooth').value;
    const relType = document.getElementById('fieldRelType').value;
    const rel = document.getElementById('fieldRel').value;
    const win = window.open('','printwin','width=700,height=700');
    win.document.write(`<h2>${escapeHtml(name)}</h2><p><b>EPIC:</b> ${escapeHtml(epic)}</p>
      <p><b>Description:</b> ${escapeHtml(desc)}</p>
      <p><b>Address:</b> ${escapeHtml(address)}</p>
      <p><b>Voting Booth:</b> ${escapeHtml(booth)}</p>
      <p><b>${escapeHtml(relType)}:</b> ${escapeHtml(rel)}</p>
      <hr><p>Sender message: ${escapeHtml(sender.text||'')}</p>`);
    win.document.close(); win.print();
  };

  document.getElementById('whatsappBtn').onclick = async () => {
    // prepare message: include sender text + voter info + image URLs (sender image + voter image)
    const name = v.Name||'';
    const epic = v.Epic||'';
    const desc = document.getElementById('fieldDesc').value;
    // ensure latest sender loaded
    let senderSnap = (await get(ref(db,'Sender'))).val() || {};
    let msg = `${encodeURIComponent(senderSnap.text || '')}%0A%0AVoter Details:%0AName: ${encodeURIComponent(name)}%0AEPIC: ${encodeURIComponent(epic)}%0ADescription: ${encodeURIComponent(desc)}`;
    if (v.Image) msg += `%0AImage: ${encodeURIComponent(v.Image)}`;
    if (senderSnap.img) msg += `%0ASenderPoster: ${encodeURIComponent(senderSnap.img)}`;
    window.open(`https://wa.me/?text=${msg}`, '_blank');
  };

  modal.classList.remove('hidden');
};

/* ===== Utilities: color change, delete, save sender ===== */
window.changeColor = async function(key, color){
  await update(ref(db, 'Voters/' + key), { Color: color });
};

window.deleteVoter = async function(key){
  if (!isAdmin) return alert("Only admin can delete");
  if (!confirm("Delete this voter?")) return;
  // delete image in storage if exists
  try {
    await deleteObject(sRef(storage, `Voters/${key}.jpg`)).catch(()=>{});
  } catch(e){}
  await remove(ref(db, 'Voters/' + key));
  modal.classList.add('hidden');
};

async function saveSender(){
  if (!currentUser) return alert("Login first");
  // if file present upload to storage
  const file = senderFile.files[0];
  let updates = {};
  if (file) {
    const p = sRef(storage, 'Sender/poster.jpg');
    await uploadBytes(p, file);
    updates.img = await getDownloadURL(p);
  }
  updates.text = senderText.value;
  await set(ref(db, 'Sender'), updates);
  alert("Sender saved");
}

async function deleteSenderPoster(){
  if (!isAdmin) return alert("Only admin can delete sender poster");
  try {
    await deleteObject(sRef(storage, 'Sender/poster.jpg'));
  } catch(e){}
  await update(ref(db, 'Sender'), { img: "" });
  senderPreview.src = '';
  senderPreviewWrap.classList.add('hidden');
}

/* ===== Close modal when clicking outside ===== */
document.getElementById('modal').addEventListener('click', (e)=>{
  if (e.target.id === 'modal') modal.classList.add('hidden');
});
function closeModal(){ modal.classList.add('hidden'); }

/* ===== Escape HTML (simple) ===== */
function escapeHtml(s = ''){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ===== Expose some functions for buttons in table using global scope ===== */
window.saveSender = saveSender;
window.deleteSenderPoster = deleteSenderPoster;

/* ===== End module ===== */
</script>
</body>
</html>
