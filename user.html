<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter System</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: #f0f2f5; }
.button-3d {
  background: linear-gradient(145deg, #4f46e5, #3b36c4);
  color: white; font-weight: bold; padding: 0.3rem 0.6rem; border-radius: 0.5rem;
  box-shadow: 3px 3px 5px #333, -3px -3px 5px #666; transition: 0.2s;
  display: inline-block; text-align: center; font-size: 0.9rem;
}
.button-3d:hover { transform: translateY(-2px); box-shadow: 5px 5px 7px #333, -5px -5px 7px #666; }
.card { background: linear-gradient(135deg, #fef9c3, #fde68a); border-radius: 12px; padding: 1rem; }
img { max-width: 100%; border-radius: 8px; }
.modal-bg {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;
}
.modal { background:white; padding:1rem; border-radius:10px; max-width:420px; width:92%; position:relative; }
.closeBtn { position:absolute; top:5px; right:5px; cursor:pointer; font-weight:bold; font-size:18px; }
.color-btn { width:24px; height:24px; border-radius:50%; cursor:pointer; }
</style>
</head>
<body class="p-4">

<!-- Login Section -->
<div id="loginSection" class="flex justify-center items-center h-screen">
  <button id="loginBtn" class="button-3d text-xl px-6 py-3">Login with Google</button>
</div>

<!-- Main Section -->
<div id="mainSection" class="hidden">
  <h1 class="text-3xl font-bold mb-4 text-center">Voter List</h1>

  <div class="overflow-x-auto bg-white p-2 rounded shadow">
    <table class="min-w-full table-auto border border-gray-300" id="voterTable">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-4 py-2 border cursor-pointer" onclick="sortTable(0)">Name</th>
          <th class="px-4 py-2 border cursor-pointer" onclick="sortTable(1)">EPIC</th>
          <th class="px-4 py-2 border cursor-pointer" onclick="sortTable(2)">Part No</th>
          <th class="px-4 py-2 border">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-bg hidden">
  <div class="modal">
    <span class="closeBtn" id="closeModal">âœ–</span>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
const ADMIN_EMAILS = ["ngogrant454@gmail.com","zarafix3@gmail.com"];
let currentUser=null,isAdmin=false;

const loginBtn=document.getElementById("loginBtn");
const loginSection=document.getElementById("loginSection");
const mainSection=document.getElementById("mainSection");
const modal=document.getElementById("modal");
const modalBody=document.getElementById("modalBody");
const closeModal=document.getElementById("closeModal");
const voterTableBody=document.querySelector("#voterTable tbody");

loginBtn.onclick=async()=>{
  const result=await signInWithPopup(auth,new GoogleAuthProvider());
  currentUser=result.user;
  isAdmin=ADMIN_EMAILS.includes(currentUser.email);
  loginSection.style.display="none";
  mainSection.style.display="block";
  loadVoters();
};

function loadVoters(){
  onValue(ref(db,"Voters"),snapshot=>{
    voterTableBody.innerHTML="";
    const data=snapshot.val(); if(!data) return;

    for(let epic in data){
      let v=data[epic];
      let row=document.createElement("tr");
      row.style.background=v.Color||"#ffffff";  
      row.innerHTML=`
        <td class="border px-2">${v.Name}</td>
        <td class="border px-2">${v.Epic}</td>
        <td class="border px-2">${v.PartNo||'-'}</td>
        <td class="border px-2"><button class="button-3d w-full" onclick="openCard('${epic}')">View</button></td>
      `;
      voterTableBody.append(row);
    }
  });
}

window.openCard=async(epic)=>{
  const snap=await get(ref(db,"Voters/"+epic));
  const v=snap.val();

  modalBody.innerHTML=`
  <div class="card" style="background:${v.Color}">

    <h2 class="font-bold text-xl mb-1">${v.Name}</h2>
    <p><strong>EPIC:</strong> ${v.Epic}</p>
    <p><strong>AC:</strong> ${v.AcNo||'-'}</p>
    <p><strong>Part:</strong> ${v.PartNo||'-'}</p>

    <textarea id="desc" class="w-full border p-2 mt-2" rows="2">${v.Description||""}</textarea>

    <textarea id="address" class="w-full border p-2 mt-2" placeholder="Address" rows="2">${v.Address||""}</textarea>

    <textarea id="booth" class="w-full border p-2 mt-2" placeholder="Voting Booth Address" rows="2">${v.Booth||""}</textarea>

    <select id="relationType" class="border p-1 w-full mt-2">
      <option ${v.RelationType==="Father"?"selected":""}>Father</option>
      <option ${v.RelationType==="Husband"?"selected":""}>Husband</option>
    </select>

    <input id="relation" class="border p-2 w-full mt-2" placeholder="Name" value="${v.Relation||""}"/>

    <div class="flex gap-2 mt-2">
      <button class="button-3d flex-1" onclick="saveFields('${epic}')">Save</button>
      <button class="button-3d flex-1" onclick="printCard()">Print</button>
    </div>

    <div class="flex gap-2 mt-2">
      <button class="button-3d flex-1" onclick="sendWhatsApp('${v.Name}','${v.Epic}')">WhatsApp</button>
      <button class="button-3d flex-1 bg-red-600" onclick="deleteVoter('${epic}')">Delete</button>
    </div>

    <div class="flex gap-2 mt-3">
      <div class="color-btn" style="background:#fde68a" onclick="changeColor('${epic}','#fde68a')"></div>
      <div class="color-btn" style="background:#a5f3fc" onclick="changeColor('${epic}','#a5f3fc')"></div>
      <div class="color-btn" style="background:#fca5a5" onclick="changeColor('${epic}','#fca5a5')"></div>
    </div>
  </div>`;
  modal.classList.remove("hidden");
};

window.saveFields=async(epic)=>{
  await update(ref(db,"Voters/"+epic),{
    Description:desc.value,
    Address:address.value,
    Booth:booth.value,
    RelationType:relationType.value,
    Relation:relation.value
  });
  alert("Saved & Live Updated!");
};

window.printCard=()=>{ window.print(); };

window.sendWhatsApp=(name,epic)=>{
  let msg=`Voter Details:%0AName: ${name}%0AEPIC: ${epic}`;
  window.open(`https://wa.me/?text=${msg}`,"_blank");
};

window.deleteVoter=async(epic)=>{
  if(confirm("Delete voter?")){
    await remove(ref(db,"Voters/"+epic));
    modal.classList.add("hidden");
  }
};

window.changeColor=async(epic,color)=>{
  await update(ref(db,"Voters/"+epic),{Color:color});
  openCard(epic);
};

closeModal.onclick=()=>modal.classList.add("hidden");
</script>
</body>
</html>
