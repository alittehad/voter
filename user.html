<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voter List ‚Äî Full Working</title>
<style>
  body{font-family:Arial; background:#f3f3f3; margin:0; padding:12px;}
  h2{text-align:center;margin-bottom:12px;}
  input,textarea{width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:2px solid #777;font-size:15px;box-sizing:border-box;}
  .list-item{padding:12px;background:#fff;border:2px solid #ccc;border-radius:10px;margin-bottom:8px;cursor:pointer;}
  .list-item:hover{box-shadow:0 6px 18px rgba(0,0,0,0.08);transform:translateY(-2px);}

  #popup{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:flex-start;padding:20px;overflow:auto;z-index:999;}
  .card{background:#fff;width:100%;max-width:480px;border-radius:12px;padding:18px;border:3px solid #111;box-sizing:border-box;}
  .card img{width:140px;height:170px;object-fit:cover;border-radius:6px;display:block;margin:8px auto;border:2px solid #ddd;}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px}
  .btn{display:inline-block;padding:10px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer;font-weight:600;margin-top:8px;width:100%}
  .btn.small{padding:8px;font-size:14px;width:auto}
  .danger{background:#d32f2f}
  .success{background:#388e3c}
  .muted{color:#666;font-size:13px}
  @media(max-width:520px){ .card img{width:120px;height:150px} }
</style>
</head>
<body>

<h2>üó≥ Voter List ‚Äî Complete (Photo Upload, Edit, Save ‚Üí Firebase)</h2>

<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
  <input id="search" placeholder="Search Name / EPIC / AC / Part ..." style="flex:1;min-width:200px">
  <button id="refreshBtn" class="btn small">Refresh</button>
</div>

<div id="list"></div>

<!-- Popup Card -->
<div id="popup">
  <div class="card" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="cName" style="margin:0"></h3>
      <button onclick="closePopup()" class="btn small danger">Close</button>
    </div>

    <p class="muted"><b>EPIC:</b> <span id="cEpic"></span> &nbsp;&nbsp; <b>AC:</b> <span id="cAc"></span> &nbsp;&nbsp; <b>Part:</b> <span id="cPart"></span></p>

    <div style="text-align:center;margin-bottom:8px">
      <img id="cPhoto" src="https://via.placeholder.com/140x170?text=No+Photo" alt="photo" />
      <div class="muted small">Photo shows after upload</div>
    </div>

    <label class="small"><b>Upload Photo (will save to Storage & DB)</b></label>
    <input type="file" id="imageInput" accept="image/*">
    <div style="display:flex;gap:8px">
      <button class="btn small" onclick="uploadVoterImage()">Upload Photo</button>
      <button class="btn small danger" onclick="deleteVoterImage()" title="Delete photo from Storage & DB">Delete Photo</button>
    </div>

    <hr style="margin:12px 0">

    <label><b>üè† Address</b></label>
    <textarea id="editAddress" rows="2" placeholder="Enter address..."></textarea>

    <label><b>üó≥ Booth</b></label>
    <input id="editBooth" placeholder="Enter Booth number or text">

    <label><b>üìç Voting Address</b></label>
    <textarea id="editVoting" rows="2" placeholder="Enter Voting Address..."></textarea>

    <label><b>üìù Sender Message (saved globally + per voter)</b></label>
    <textarea id="senderNote" rows="2" placeholder="Enter message..."></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn success" onclick="saveEdits()">Save Changes</button>
      <button class="btn" onclick="printCard()">Print</button>
    </div>

    <button class="btn" style="background:#25D366;margin-top:8px" onclick="shareWhatsApp()">Share (WhatsApp Text Only)</button>

    <div id="status" class="muted small" style="margin-top:8px"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
  // ========== CONFIG ==========
  const firebaseConfig = {
    apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
    authDomain: "voter-25c94.firebaseapp.com",
    databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
    projectId: "voter-25c94",
    storageBucket: "voter-25c94.appspot.com",
    messagingSenderId: "297773534400",
    appId: "1:297773534400:web:3722c487b8c83e9b787125"
  };
  firebase.initializeApp(firebaseConfig);
  const rdb = firebase.database();
  const storage = firebase.storage();

  // ========== STATE ==========
  let voters = {};      // object keyed by EPIC (as in your RTDB)
  let listOrder = [];   // EPICs in insertion order for display
  let selectedEpic = null;

  // ========== UTIL ==========
  function sanitizeKey(k){ return (k||'').toString().replace(/[.#$\[\]/]/g,'_'); }
  function $(id){ return document.getElementById(id); }
  function setStatus(s){ $('status').innerText = s || ''; }

  // ========== LOAD from RTDB (Voters node) ==========
  function loadVoters(){
    setStatus('Loading voters from Firebase...');
    rdb.ref('Voters').once('value').then(snap=>{
      const obj = snap.val() || {};
      voters = obj;
      listOrder = Object.keys(obj);
      renderList();
      setStatus('Loaded ' + listOrder.length + ' voters.');
    }).catch(err=>{
      console.error(err);
      setStatus('Error loading voters: ' + err.message);
    });
  }

  // initial load
  loadVoters();

  // manual refresh button
  $('refreshBtn').addEventListener('click', ()=> loadVoters());

  // ========== RENDER LIST ==========
  function renderList(filterText=''){
    const box = $('list');
    box.innerHTML = '';
    filterText = (filterText||'').toLowerCase();

    listOrder.forEach(epic=>{
      const v = voters[epic];
      if(!v) return;
      const name = v.Name || '';
      const ac   = v.AcNo || '';
      const part = v.PartNo || '';
      const booth= v.VotingAddress || v.Booth || 'NA';

      // simple filter
      const hay = (name + ' ' + epic + ' ' + ac + ' ' + part + ' ' + (v.Address||'') + ' ' + (booth||'')).toLowerCase();
      if(filterText && hay.indexOf(filterText) === -1) return;

      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<b>${name}</b><br><span class="muted">EPIC: ${epic} | AC:${ac} | Part:${part} | Booth:${booth}</span>`;
      div.onclick = ()=> openPopupFor(epic);
      box.appendChild(div);
    });
  }

  // search handler
  $('search').addEventListener('input', (e)=> renderList(e.target.value));

  // ========== OPEN POPUP ==========
  function openPopupFor(epic){
    const key = epic;
    const v = voters[key];
    if(!v) { alert('Voter not found'); return; }
    selectedEpic = key;

    $('cName').innerText = v.Name || '';
    $('cEpic').innerText = v.EPIC || key;
    $('cAc').innerText   = v.AcNo || '';
    $('cPart').innerText = v.PartNo || '';

    $('editAddress').value = v.Address || '';
    $('editBooth').value   = v.Booth || (v.BoothNo || '') || '';
    $('editVoting').value  = v.VotingAddress || '';
    $('senderNote').value  = v.SenderNote || '';

    // photo
    const imgEl = $('cPhoto');
    if(v.ImageURL){
      imgEl.src = v.ImageURL;
    } else {
      imgEl.src = 'https://via.placeholder.com/140x170?text=No+Photo';
    }

    setStatus('');
    $('popup').style.display = 'flex';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function closePopup(){
    selectedEpic = null;
    $('popup').style.display = 'none';
  }

  // ========== Save edits to RTDB ==========
  function saveEdits(){
    if(!selectedEpic) return alert('No voter selected');
    setStatus('Saving details...');
    const addr = $('editAddress').value || '';
    const booth= $('editBooth').value || '';
    const voting = $('editVoting').value || '';
    const note = $('senderNote').value || '';

    const updates = {
      Address: addr,
      Booth: booth,
      VotingAddress: voting,
      SenderNote: note
    };

    rdb.ref('Voters/' + sanitizeKey(selectedEpic)).update(updates)
      .then(()=>{
        // update local state
        if(!voters[selectedEpic]) voters[selectedEpic] = {};
        Object.assign(voters[selectedEpic], updates);
        renderList($('search').value);
        setStatus('Saved successfully.');
        alert('Saved successfully');
      })
      .catch(err=>{
        console.error(err);
        setStatus('Save error: ' + err.message);
        alert('Save failed: ' + err.message);
      });
  }

  // ========== Upload Photo ==========
  function uploadVoterImage(){
    if(!selectedEpic) return alert('Select a voter first');
    const file = $('imageInput').files[0];
    if(!file) return alert('Choose an image file first');

    setStatus('Uploading image...');
    // make filename unique
    const key = sanitizeKey(selectedEpic);
    const filename = key + '_' + Date.now() + '_' + file.name.replace(/\s+/g,'_');
    const ref = storage.ref('voterImages/' + filename);

    const task = ref.put(file);

    task.on('state_changed',
      snap => {
        const pct = ((snap.bytesTransferred / snap.totalBytes) * 100).toFixed(0);
        setStatus('Upload: ' + pct + '%');
      },
      err => {
        console.error(err);
        setStatus('Upload error: ' + err.message);
        alert('Upload failed: ' + err.message);
      },
      () => {
        task.snapshot.ref.getDownloadURL().then(url=>{
          // save URL to RTDB under sanitized key
          rdb.ref('Voters/' + key).update({ ImageURL: url })
            .then(()=>{
              // update local
              if(!voters[selectedEpic]) voters[selectedEpic] = {};
              voters[selectedEpic].ImageURL = url;
              $('cPhoto').src = url;
              renderList($('search').value);
              setStatus('Image uploaded and saved.');
              alert('Image uploaded & saved.');
            })
            .catch(e=>{
              console.error(e);
              setStatus('DB save error: ' + e.message);
              alert('Image uploaded but DB update failed: ' + e.message);
            });
        });
      }
    );
  }

  // ========== Delete Photo (Storage + DB) ==========
  function deleteVoterImage(){
    if(!selectedEpic) return alert('Select a voter first');
    const key = sanitizeKey(selectedEpic);
    // confirm
    if(!confirm('Delete photo for ' + selectedEpic + ' ?')) return;

    // if no URL stored, just remove local
    const url = (voters[selectedEpic] && voters[selectedEpic].ImageURL) || null;
    if(!url){
      // just clear DB key (if any)
      rdb.ref('Voters/' + key).update({ ImageURL: null }).then(()=>{
        if(voters[selectedEpic]) delete voters[selectedEpic].ImageURL;
        $('cPhoto').src = 'https://via.placeholder.com/140x170?text=No+Photo';
        renderList($('search').value);
        alert('Image removed.');
      }).catch(e=> alert('Error: '+e.message));
      return;
    }

    // delete by creating a ref from URL
    const storageRef = storage.refFromURL(url);
    storageRef.delete().then(()=>{
      rdb.ref('Voters/' + key).update({ ImageURL: null }).then(()=>{
        if(voters[selectedEpic]) delete voters[selectedEpic].ImageURL;
        $('cPhoto').src = 'https://via.placeholder.com/140x170?text=No+Photo';
        renderList($('search').value);
        alert('Image deleted from storage & DB.');
      }).catch(e=>{
        alert('Deleted from storage but DB update failed: ' + e.message);
      });
    }).catch(e=>{
      alert('Error deleting storage file: ' + e.message + '\nAttempting to clear DB record...');
      // try clearing DB anyway
      rdb.ref('Voters/' + key).update({ ImageURL: null }).then(()=>{
        if(voters[selectedEpic]) delete voters[selectedEpic].ImageURL;
        $('cPhoto').src = 'https://via.placeholder.com/140x170?text=No+Photo';
        renderList($('search').value);
        alert('DB updated (storage delete may have failed).');
      }).catch(err=> alert('Failed to clear DB: ' + err.message));
    });
  }

  // ========== Print Card ==========
  function printCard(){
    if(!selectedEpic) return alert('Select a voter first');
    const v = voters[selectedEpic] || {};
    const html = `
      <html><head><title>Print Voter Card</title>
      <style>body{font-family:Arial;padding:20px} .card{width:320px;border:1px solid #333;padding:12px;border-radius:8px} img{display:block;margin:10px auto; width:140px;height:170px;object-fit:cover}</style>
      </head><body>
        <div class="card">
          <img src="${v.ImageURL || 'https://via.placeholder.com/140x170?text=No+Photo'}" alt="photo"/>
          <h3 style="text-align:center">${v.Name || ''}</h3>
          <p><b>EPIC:</b> ${v.EPIC || ''}</p>
          <p><b>AC:</b> ${v.AcNo || ''} <b>Part:</b> ${v.PartNo || ''}</p>
          <p><b>Address:</b><br/>${(v.Address||'')}</p>
          <p><b>Voting Address / Booth:</b><br/>${(v.VotingAddress||v.Booth||'')}</p>
        </div>
      </body></html>
    `;
    const w = window.open('', '_blank', 'width=700,height=800');
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  }

  // ========== WhatsApp Share (TEXT ONLY) ==========
  function shareWhatsApp(){
    if(!selectedEpic) return alert('Select a voter first');
    const v = voters[selectedEpic] || {};
    const text = `VOTER DETAILS
Name: ${v.Name || ''}
EPIC: ${v.EPIC || ''}
AC: ${v.AcNo || ''}  Part: ${v.PartNo || ''}
Address: ${v.Address || 'NA'}
Voting Address / Booth: ${v.VotingAddress || v.Booth || 'NA'}`;

    const url = 'https://wa.me/?text=' + encodeURIComponent(text);
    window.open(url, '_blank');
  }

  // ========== Helpers: reflect updates coming from outside (if RTDB changes) ==========
  // Listen for any RTDB changes under Voters and update local & UI
  rdb.ref('Voters').on('child_changed', snap=>{
    const key = snap.key;
    const data = snap.val();
    // update local by EPIC mapping: key may be sanitized EPIC; find matching entry in voters
    // We try to match by EPIC field if present, else by sanitized key
    // First try to find by exact key
    if(voters[key]) {
      voters[key] = Object.assign({}, voters[key], data);
    } else {
      // fallback: iterate to match EPIC field
      for(const k of Object.keys(voters)){
        if((voters[k].EPIC || '').toString().toLowerCase() === (data.EPIC || key || '').toString().toLowerCase()){
          voters[k] = Object.assign({}, voters[k], data);
        }
      }
    }
    renderList($('search').value);
    if(selectedEpic){
      // refresh popup fields if currently selected matches
      if(selectedEpic === (data.EPIC || key) || selectedEpic === key){
        openPopupFor(selectedEpic);
      }
    }
  });

  // helper: openPopup reuse when RTDB changes
  function openPopupFor(epic){
    // epic may be sanitized key; try direct, else search by EPIC field
    let foundEpic = null;
    if(voters[epic]) foundEpic = epic;
    else {
      for(const k of Object.keys(voters)){
        if((voters[k].EPIC || '').toString().toLowerCase() === epic.toString().toLowerCase()){
          foundEpic = k; break;
        }
      }
    }
    if(!foundEpic) {
      alert('Voter not found: ' + epic);
      return;
    }
    openPopupFound(foundEpic);
  }

  function openPopupFound(key){
    const v = voters[key];
    selectedEpic = key;
    $('cName').innerText = v.Name || '';
    $('cEpic').innerText = v.EPIC || key;
    $('cAc').innerText = v.AcNo || '';
    $('cPart').innerText = v.PartNo || '';
    $('editAddress').value = v.Address || '';
    $('editBooth').value = v.Booth || '';
    $('editVoting').value = v.VotingAddress || '';
    $('senderNote').value = v.SenderNote || '';
    $('cPhoto').src = v.ImageURL || 'https://via.placeholder.com/140x170?text=No+Photo';
    setStatus('');
    $('popup').style.display = 'flex';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // alias for openPopupFound to keep earlier function name
  function openPopupFor(epicKey){ openPopupFound(epicKey); }

  // also expose openPopupFor for list click closure (we used earlier)
  // but our renderList used openPopupFor already.

</script>
</body>
</html>
