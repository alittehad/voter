<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ward Status Panel - Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { background: #eef2ff; }
.card { background:white; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:16px; }
.sticky-bar { position: sticky; top:0; z-index:50; backdrop-filter:blur(8px); background: rgba(255,255,255,0.9); padding:12px; border-bottom:1px solid #ddd; }
.btn { cursor:pointer; padding:0.5rem 1rem; border-radius:0.5rem; font-weight:bold; transition:0.2s; }
.btn-blue { background:#2563eb;color:white; }
.btn-green { background:#16a34a;color:white; }
.btn-yellow { background:#facc15;color:black; }
.btn-red { background:#dc2626;color:white; }
.btn:hover { opacity:0.8; }
</style>
</head>
<body class="p-4">

<div class="text-center mb-4">
  <h1 class="text-2xl font-bold text-blue-700">Ward Status Panel - Admin</h1>
</div>

<!-- Sticky Bar -->
<div class="sticky-bar mb-4">
  <input id="searchBox" type="text" placeholder="à¤¨à¤¾à¤® à¤¸à¥‡ à¤–à¥‹à¤œà¥‡à¤‚â€¦" class="w-full p-2 rounded-xl border mb-3 outline-none focus:ring-2 focus:ring-blue-500">
  <div class="flex gap-2 mb-3">
    <button class="filterBtn px-3 py-1 rounded-full bg-blue-600 text-white" data-filter="all">All</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-green-600 text-white" data-filter="approved">Approved</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-yellow-600 text-white" data-filter="opponent">Opponent</button>
    <button class="filterBtn px-3 py-1 rounded-full bg-red-600 text-white" data-filter="anti">Anti</button>
  </div>
  <div class="grid grid-cols-3 gap-2 text-center">
    <div class="p-2 rounded-lg bg-green-100 text-green-700 font-bold">Approved: <span id="countApproved">0</span></div>
    <div class="p-2 rounded-lg bg-yellow-100 text-yellow-700 font-bold">Opponent: <span id="countOpponent">0</span></div>
    <div class="p-2 rounded-lg bg-red-100 text-red-700 font-bold">Anti: <span id="countAnti">0</span></div>
  </div>
</div>

<!-- Sender Info -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="text-xl font-bold mb-2 text-blue-700">Sender Information</h2>
  <input type="text" id="senderName" placeholder="Sender Name" class="border p-2 w-full mb-2">
  <input type="text" id="senderMessage" placeholder="Message to send" class="border p-2 w-full mb-2">
  <p class="font-semibold mb-1">Upload Sender Photo:</p>
  <input type="file" id="senderImage" class="border p-2 w-full mb-2">
  <button id="saveSender" class="bg-blue-600 text-white px-4 py-2 rounded font-bold w-full">Save Sender Info</button>
</div>

<!-- Voter List -->
<div id="list" class="mt-4"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let senderCache = {};

// ImgBB Upload
async function uploadToImgBB(file){
  const base64 = await new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => res(reader.result.split(",")[1]);
    reader.onerror = err => rej(err);
  });
  const form = new FormData();
  form.append("image", base64);
  const API_KEY = "5735107daf1af173af2008a3899a2496";
  const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, { method:"POST", body: form });
  const data = await response.json();
  if(!data.success) throw new Error("ImgBB upload failed");
  return data.data.url;
}

// Save Sender
saveSender.onclick = async ()=>{
  const name = senderName.value.trim();
  const msg  = senderMessage.value.trim();
  const file = senderImage.files[0];
  if(!name || !msg || !file) return alert("Fill all sender info!");
  try{
    const imgURL = await uploadToImgBB(file);
    await set(dbRef(db,"senderInfo"), { name, message: msg, photo: imgURL });
    senderCache = {name,message: msg,photo: imgURL};
    alert("Sender info saved!");
  }catch(err){ console.error(err); alert("Sender info save failed!") }
};

// Load sender
onValue(dbRef(db,"senderInfo"), snap => { if(snap.exists()) senderCache = snap.val(); });

// Render voters
const listDiv = document.getElementById("list");
onValue(dbRef(db,"voters"), snap=>{
  listDiv.innerHTML="";
  snap.forEach(s=>{
    const v = s.val();
    const div=document.createElement("div");
    div.className="card item mt-3";
    div.dataset.status=v.status; div.dataset.name=v.name.toLowerCase();
    div.innerHTML=`<h2 class="font-bold">${v.name}</h2>
      <p class="text-sm text-gray-600">EPIC: ${v.voterID} | Ward: ${v.ward} | Status: ${v.status}</p>
      <div class="mt-2 flex gap-2 flex-wrap">
        <button class="btn btn-blue sendBtn">Send WhatsApp</button>
        <button class="btn btn-green printBtn">Print</button>
        <button class="btn btn-yellow approveBtn">Approve</button>
        <button class="btn btn-yellow opponentBtn">Opponent</button>
        <button class="btn btn-red antiBtn">Anti</button>
      </div>`;
    listDiv.appendChild(div);

    div.querySelector(".sendBtn").onclick=()=>{
      const s=senderCache;
      if(!s.name) return alert("Sender info missing!");
      const msg=`ðŸ“£ *${s.name} à¤•à¤¾ à¤¸à¤‚à¤¦à¥‡à¤¶*\n${s.message}\n\nVoter: ${v.name}\nEPIC: ${v.voterID}\nWard: ${v.ward}\n${s.photo}`;
      window.open(`https://wa.me/${v.mobile}?text=${encodeURIComponent(msg)}`,"_blank");
    };
    div.querySelector(".printBtn").onclick=()=>{
      const win=window.open();
      win.document.write(`<h2>Voter Info</h2><p>Name: ${v.name}</p><p>EPIC: ${v.voterID}</p><p>Ward: ${v.ward}</p><p>Mobile: ${v.mobile}</p><p>Status: ${v.status}</p>`);
      win.print();
    };
    div.querySelector(".approveBtn").onclick=()=>update(dbRef(db,"voters/"+v.voterID.replace(/\W/g,"_")),{status:"approved"});
    div.querySelector(".opponentBtn").onclick=()=>update(dbRef(db,"voters/"+v.voterID.replace(/\W/g,"_")),{status:"opponent"});
    div.querySelector(".antiBtn").onclick=()=>update(dbRef(db,"voters/"+v.voterID.replace(/\W/g,"_")),{status:"anti"});
  });
  applyFilter();
});

// Filter + Search
let activeFilter="all";
document.querySelectorAll(".filterBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    activeFilter=btn.dataset.filter;
    document.querySelectorAll(".filterBtn").forEach(b=>b.classList.remove("ring-2","ring-black"));
    btn.classList.add("ring-2","ring-black");
    applyFilter();
  });
});
document.getElementById("searchBox").addEventListener("keyup", applyFilter);

function applyFilter(){
  const keyword=document.getElementById("searchBox").value.toLowerCase();
  const items=document.querySelectorAll(".item");
  let approved=0,opponent=0,anti=0;
  items.forEach(i=>{
    const name=i.dataset.name,status=i.dataset.status;
    const matchSearch=name.includes(keyword);
    const matchFilter=(activeFilter=="all"||activeFilter==status);
    if(matchSearch&&matchFilter){ i.classList.remove("hidden"); if(status=="approved") approved++; else if(status=="opponent") opponent++; else anti++; }
    else i.classList.add("hidden");
  });
  document.getElementById("countApproved").innerText=approved;
  document.getElementById("countOpponent").innerText=opponent;
  document.getElementById("countAnti").innerText=anti;
}
</script>
</body>
</html>
