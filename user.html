<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Voter System</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }

    input { padding: 8px; width: 300px; margin-bottom: 10px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }

    th, td { border: 1px solid #ccc; padding: 8px; }

    tr:hover { background: #f0f0f0; cursor: pointer; }

    .card {
        width: 350px;
        padding: 15px;
        background: #ffe6e6;
        border-radius: 10px;
        display: none;
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    .btn { padding: 8px 12px; cursor: pointer; margin: 5px; }

    #printArea { display: none; }

</style>
</head>
<body>

<h2>üó≥Ô∏è Voter Management System</h2>

<button id="loginBtn" class="btn">üîê Login With Google</button>
<p id="userDisplay"></p>

<input type="text" id="search" placeholder="Search: Name, EPIC, Part No, Address...">

<table>
    <thead>
        <tr>
            <th>EPIC</th><th>Name</th><th>Part No</th><th>Action</th>
        </tr>
    </thead>
    <tbody id="voterList"></tbody>
</table>

<!-- Card Popup -->
<div class="card" id="card">
    <h3 id="cName"></h3>
    <p><b>EPIC:</b> <span id="cEpic"></span></p>
    <p><b>AC No:</b> <span id="cAc"></span></p>
    <p><b>Part No:</b> <span id="cPart"></span></p>
    <p><b>Address:</b> <span id="cAddress"></span></p>
    <p><b>Description:</b> <span id="cDesc"></span></p>

    <label>üé® Change Card Color:</label>
    <input type="color" id="colorPicker">

    <br><br>
    <button class="btn" onclick="printVoter()">üñ® Print</button>
    <button class="btn" onclick="sendWhatsApp()">üì© Send</button>
    <button class="btn" onclick="closeCard()">‚ùå Close</button>
</div>

<!-- Hidden Print Area -->
<div id="printArea"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

// ---- Firebase Config ----
const firebaseConfig = {
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
const provider = new GoogleAuthProvider();

let VOTERS = {};

// Login
document.getElementById("loginBtn").onclick = () => {
    signInWithPopup(auth, provider).then(result => {
        document.getElementById("userDisplay").innerHTML = "üëã Welcome, " + result.user.email;
    });
};

// Read Voters
onValue(ref(db, "Voters"), snapshot => {
    VOTERS = snapshot.val() || {};
    loadTable();
});

// Load Table
function loadTable() {
    const tbody = document.getElementById("voterList");
    tbody.innerHTML = "";

    const query = document.getElementById("search").value.toLowerCase();

    Object.values(VOTERS).forEach(v => {
        if(JSON.stringify(v).toLowerCase().includes(query)){
            const row = document.createElement("tr");
            row.style.background = v.Color || "";
            row.innerHTML = `
                <td>${v.Epic}</td>
                <td>${v.Name}</td>
                <td>${v.PartNo}</td>
                <td><button onclick='openCard("${v.Epic}")'>View</button></td>
            `;
            tbody.appendChild(row);
        }
    });
}

document.getElementById("search").oninput = loadTable;

// Open Card
let currentEpic = null;

window.openCard = (epic) => {
    currentEpic = epic;
    const v = VOTERS[ Object.keys(VOTERS).find(k => VOTERS[k].Epic === epic) ];

    document.getElementById("cName").innerText = v.Name;
    document.getElementById("cEpic").innerText = v.Epic;
    document.getElementById("cAc").innerText = v.AcNo;
    document.getElementById("cPart").innerText = v.PartNo;
    document.getElementById("cAddress").innerText = v.Address || "N/A";
    document.getElementById("cDesc").innerText = v.Description || "";

    document.getElementById("colorPicker").value = v.Color || "#ffffff";
    document.getElementById("card").style.background = v.Color || "#fff";
    document.getElementById("card").style.display = "block";
};

// Color Change
document.getElementById("colorPicker").onchange = (e) => {
    const color = e.target.value;
    document.getElementById("card").style.background = color;

    update(ref(db, "Voters/" + currentEpic.toLowerCase()), { Color: color });
    loadTable();
};

// Close Card
window.closeCard = () => {
    document.getElementById("card").style.display = "none";
};

// Print
window.printVoter = () => {
    const printContent = document.getElementById("card").innerHTML;
    const win = window.open("");
    win.document.write(printContent);
    win.print();
    win.close();
};

// WhatsApp Send
window.sendWhatsApp = () => {
    const msg = prompt("Message before sending:");
    const text = `
${msg ? msg + "\n\n" : ""}
VOTER DETAILS:
Name: ${document.getElementById("cName").innerText}
EPIC: ${document.getElementById("cEpic").innerText}
Part No: ${document.getElementById("cPart").innerText}
Address: ${document.getElementById("cAddress").innerText}
Description: ${document.getElementById("cDesc").innerText}
    `;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
}

</script>

</body>
</html>
