<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WARD-20 Election System</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.card-bg{
  background: var(--theme, #cbe7ff);
}
</style>
</head>

<body class="bg-gray-100">
<div id="app" class="p-4"></div>

<script type="module">

// ---------------- Firebase Setup ------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "5735107daf1af173af2008a3899a2496",
  appId: "1:5735107daf1af173af2008a3899a2496:web:example"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();

const appDiv = document.getElementById("app");

// ---------------- Google Login ------------------
async function login(){
  const provider = new GoogleAuthProvider();
  const result = await signInWithPopup(auth, provider);
  
  const user = result.user;
  renderApp(user);
}

// ---------------- Load Sender Details ------------------
async function loadSender(){
  const snap = await getDoc(doc(db, "settings", "sender"));
  return snap.exists() ? snap.data() : { name:"", mobile:"", desc:"", photo:"" };
}

// ---------------- Save Sender (ADMIN) ------------------
async function saveSender(){
  const name = document.getElementById("senderName").value;
  const mobile = document.getElementById("senderMobile").value;
  const desc = document.getElementById("senderDesc").value;
  const photoFile = document.getElementById("senderPhoto").files[0];

  let photoURL = "";

  if(photoFile){
    const senderRef = ref(storage, "sender/photo.jpg");
    await uploadBytes(senderRef, photoFile);
    photoURL = await getDownloadURL(senderRef);
  }

  await setDoc(doc(db, "settings", "sender"), {
    name, mobile, desc, photo: photoURL
  });

  alert("Sender Saved!");
}

// ---------------- Load Voters ------------------
async function loadVoters(){
  const q = await getDocs(collection(db, "voters"));
  let arr = [];
  q.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
  return arr;
}

// ---------------- Upload Voter Image ------------------
async function uploadImage(voterId){
  const input = document.getElementById("img-"+voterId).files[0];
  if(!input) return alert("Select file");

  const storageRef = ref(storage, "voters/"+voterId+".jpg");
  await uploadBytes(storageRef, input);
  const url = await getDownloadURL(storageRef);

  await updateDoc(doc(db, "voters", voterId), { photo:url });
  alert("Uploaded!");
  renderApp(auth.currentUser);
}

// ---------------- Delete Voter Image ------------------
async function deleteImage(voterId, url){
  if(!confirm("Remove Photo?")) return;

  await deleteObject(ref(storage, url));
  await updateDoc(doc(db, "voters", voterId), { photo:"" });

  renderApp(auth.currentUser);
}

// ---------------- Share Voter Card ------------------
async function share(v){
  const sender = await loadSender();

  const msg = 
`ğŸ—³ VOTER CARD  

ğŸ‘¤ Name: ${v.name}
ğŸ“ Voting Address: ${v.voting}
ğŸ“„ EPIC: ${v.epic}

--------------------------------
ğŸ“¢ Sender Info

ğŸ‘¤ ${sender.name}
ğŸ“ ${sender.mobile}
ğŸ“ ${sender.desc}
`;

  const encoded = encodeURIComponent(msg);
  window.open(`https://wa.me/?text=${encoded}`, "_blank");
}

// ---------------- UI Render ------------------
async function renderApp(user){
  const sender = await loadSender();
  const voters = await loadVoters();

  appDiv.innerHTML = `
  <h1 class="text-xl font-bold mb-4">Welcome: ${user.email}</h1>

  <!-- Sender Form (ADMIN ONLY = YOU) -->
  ${user.email.includes("admin") ? `
  <div class="bg-white p-4 shadow rounded mb-4">
    <h2 class="font-bold">Sender Setup</h2>
    <input id="senderName" placeholder="Sender Name" class="border p-2 w-full mb-2" value="${sender.name}">
    <input id="senderMobile" placeholder="Mobile" class="border p-2 w-full mb-2" value="${sender.mobile}">
    <textarea id="senderDesc" placeholder="Description" class="border p-2 w-full mb-2">${sender.desc}</textarea>
    <input type="file" id="senderPhoto" class="mb-2">
    <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="saveSender()">SAVE</button>
  </div>` : ""}


  <!-- Voter List -->
  <div>
  ${voters.map(v => `
    <div class="card-bg p-4 rounded mb-4 shadow">
      <h3 class="font-bold">${v.name}</h3>
      <p>ğŸ“„ EPIC: ${v.epic}</p>
      <p>ğŸ  Address: ${v.address}</p>
      <p>ğŸ—³ Voting: ${v.voting}</p>

      ${v.photo ? `<img src="${v.photo}" class="w-24 h-24 rounded my-2" />` : ""}
      <input type="file" id="img-${v.id}" class="my-1">
      <button onclick="uploadImage('${v.id}')" class="bg-green-600 text-white px-3 py-1">Upload</button>

      ${v.photo ? `<button onclick="deleteImage('${v.id}', '${v.photo}')" class="bg-red-600 text-white px-3 py-1 ml-2">Remove Photo</button>` : ""}

      <button onclick='share(${JSON.stringify(v)})' class="bg-black text-white px-4 py-2 mt-2 block">ğŸ“© Share</button>
    </div>
  `).join("")}
  </div>
  `;
}

login();

</script>
</body>
</html>
