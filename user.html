<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voter List Search</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 10px;
    margin: 0;
    background: #f3f3f3;
}
h2 {
    text-align: center;
    margin-bottom: 15px;
}
input {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 8px;
    border: 2px solid #aaa;
}
.list-item {
    padding: 12px;
    background: white;
    border: 2px solid #ccc;
    margin-bottom: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}
.list-item:hover {
    transform: scale(1.03);
    box-shadow: 0 0 10px #aaa;
}

/* Popup */
#popup {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
}
.card {
    width: 90%;
    max-width: 400px;
    background: white;
    padding: 20px;
    border-radius: 15px;
    border: 3px solid black;
    text-align: left;
    transition: 0.4s;
    max-height: 90vh;
    overflow-y: auto;
}
.btn {
    padding: 10px;
    border: none;
    background: #008cff;
    color: white;
    width: 100%;
    margin-top: 10px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 5px 0 #005bb5;
}
.btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #004;
}
.color-box {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    cursor: pointer;
    margin: 6px;
    border: 2px solid black;
    display: inline-block;
}
.close-btn {
    background: red;
    color: white;
    margin-top: 10px;
}

/* PRINT MODE FIXED */
@media print {
    .close-btn, .btn, #themeLabel, img, textarea, .color-box, input {
        display: none !important;
    }
    #popup {
        display: block !important;
        background: white !important;
        position: static;
    }
    .card {
        width: 100% !important;
        border: 2px solid black;
        color: black !important;
    }
}
</style>
</head>
<body>

<h2>üó≥ Voter List</h2>
<input id="search" placeholder="Search by Name, EPIC, AC No, Part No...">
<div id="list"></div>

<!-- POPUP -->
<div id="popup">
    <div class="card" id="cardBox">
        <h3 id="pName"></h3>
        <p><b>üÜî EPIC:</b> <span id="pEpic"></span></p>
        <p><b>üèõ AC No:</b> <span id="pAc"></span></p>
        <p><b>üìç Part No:</b> <span id="pPart"></span></p>
        <p><b>üè† Address:</b> <span id="pAddress"></span></p>
        <p><b>üó≥ Booth:</b> <span id="pVoteAddress"></span></p>

        <label><b>Sender Note:</b></label>
        <textarea id="senderNote" placeholder="Write your message..." style="width:100%;height:80px;border-radius:10px;"></textarea>

        <div>
            <div class="color-box" onclick="changeColor('#fca5a5')" style="background:#fca5a5;"></div>
            <div class="color-box" onclick="changeColor('#a5f7c5')" style="background:#a5f7c5;"></div>
            <div class="color-box" onclick="changeColor('#9fd1ff')" style="background:#9fd1ff;"></div>
        </div>

        <button class="btn" onclick="printCard()">üñ® Print</button>
        <button class="btn" onclick="sendWhatsApp()">üì© Send WhatsApp</button>
        <button class="btn close-btn" onclick="closePopup()">‚ùå Close</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

firebase.initializeApp(firebaseConfig);

let voters = {};
let selected = null;
let globalSenderNote = "";

// Fetch data from Firebase
firebase.database().ref("/").on("value", snap => {
    const data = snap.val() || {};
    voters = data.Voters || {};
    globalSenderNote = data.GlobalSenderNote || "";
    displayList(voters);
});

function displayList(data){
    const listDiv = document.getElementById("list");
    listDiv.innerHTML = "";
    Object.values(data).forEach(voter => {
        let div = document.createElement("div");
        div.className = "list-item";
        div.style.borderColor = voter.Color || "#ccc";
        div.style.background = voter.Color || "white";
        div.innerHTML = `
            <b>${voter.Name}</b> - ${voter.EPIC} | AC: ${voter.AcNo} | Part: ${voter.PartNo}
        `;
        div.onclick = () => openPopup(voter);
        listDiv.appendChild(div);
    });
}

function openPopup(voter){
    selected = voter;
    document.getElementById("pName").innerText = voter.Name;
    document.getElementById("pEpic").innerText = voter.EPIC;
    document.getElementById("pAc").innerText = voter.AcNo;
    document.getElementById("pPart").innerText = voter.PartNo;
    document.getElementById("pAddress").innerText = voter.Address || "Not Available";
    document.getElementById("pVoteAddress").innerText = voter.VotingAddress || "Not Available";

    document.getElementById("senderNote").value = globalSenderNote;

    document.getElementById("popup").style.display = "flex";
}

function closePopup(){
    document.getElementById("popup").style.display = "none";
}

function changeColor(color){
    document.getElementById("cardBox").style.background = color;
    let items = document.querySelectorAll(".list-item");
    items.forEach(i => {
        if(i.innerText.includes(selected.EPIC)) {
            i.style.background = color;
        }
    });
}

function printCard(){
    // Update global sender note before printing
    globalSenderNote = document.getElementById("senderNote").value;
    window.print();
}

function sendWhatsApp(){
    // Update global sender note
    globalSenderNote = document.getElementById("senderNote").value;
    const msg = `
üìå Voter Details:
üë§ Name: ${selected.Name}
üÜî EPIC: ${selected.EPIC}
üèõ AC No: ${selected.AcNo}
üìç Part No: ${selected.PartNo}
üè† Address: ${selected.Address || "Not Available"}
üó≥ Booth: ${selected.VotingAddress || "Not Available"}

üìù Sender Note:
${globalSenderNote}
    `;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
}

// Search
document.getElementById("search").addEventListener("input", function(){
    let text = this.value.toLowerCase();
    let filtered = Object.values(voters).filter(v =>
        v.Name.toLowerCase().includes(text) ||
        v.EPIC.toLowerCase().includes(text) ||
        String(v.AcNo).includes(text) ||
        String(v.PartNo).includes(text)
    );
    displayList(filtered);
});
</script>

</body>
</html>
