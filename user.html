<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Voter App â€” WhatsApp + Print</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase();

// -------- Login --------
document.getElementById("loginBtn").onclick = ()=>{
  signInWithPopup(auth, provider).catch(e=> alert(e.message));
};

document.getElementById("logoutBtn").onclick = ()=> signOut(auth);

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    document.getElementById("main").classList.add("hidden");
    return;
  }

  const email = user.email.replace(/\./g, "_");
  const snapAdmin = await get(child(ref(db), `admins/${email}`));
  const snapUser = await get(child(ref(db), `users/${email}`));

  if(!snapAdmin.exists() && !snapUser.exists()){
    alert("Access denied!");
    return;
  }

  document.getElementById("main").classList.remove("hidden");
  loadVoters();
});

// -------- Load Voters --------
async function loadVoters(){
  const snap = await get(child(ref(db), "voters"));
  const senderSnap = await get(child(ref(db), "sender"));
  const sender = senderSnap.val();
  const data = snap.val();

  const box = document.getElementById("voterBox");
  box.innerHTML = "";

  Object.values(data).forEach(v=>{
    const card = document.createElement("div");
    card.className = "p-4 rounded-xl shadow bg-white mb-3 border";

    card.innerHTML = `
      <p><b>Name:</b> ${v.name}</p>
      <p><b>EPIC:</b> ${v.voterID}</p>
      <p><b>Ward:</b> ${v.ward || "NA"}</p>
      <p><b>Address:</b> ${v.address || "NA"}</p>
      <p><b>Age:</b> ${v.age || "NA"}</p>
      <p><b>Booth:</b> ${v.booth || "NA"}</p>
      <p><b>Status:</b> ${v.status}</p>
      <button class="whatsappBtn mt-3 bg-green-600 text-white px-3 py-2 rounded">Send WhatsApp</button>
      <button class="printBtn mt-3 bg-blue-600 text-white px-3 py-2 rounded ml-2">Print</button>
    `;

    // WhatsApp
    card.querySelector(".whatsappBtn").onclick = ()=>{
      const msg = `Name: ${v.name}\nEPIC: ${v.voterID}\nWard: ${v.ward}\nAddress: ${v.address}\nAge: ${v.age}\nBooth: ${v.booth}\nSender: ${sender.name} - ${sender.mobile}`;
      window.open(`https://wa.me/${v.mobile}?text=${encodeURIComponent(msg)}`);
    };

    // Print
    card.querySelector(".printBtn").onclick = ()=>{
      const printWin = window.open("", "PRINT", "height=600,width=800");
      printWin.document.write(`<pre>${card.innerText}</pre>`);
      printWin.document.close();
      printWin.focus();
      printWin.print();
    };

    box.appendChild(card);
  });
}

</script>
</head>

<body class="bg-gray-100 p-5">
<button id="loginBtn" class="bg-black text-white px-5 py-2 rounded">Login with Google</button>
<button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded ml-2">Logout</button>

<div id="main" class="hidden mt-5">
  <h2 class="text-xl font-bold mb-3">Voter List</h2>
  <div id="voterBox"></div>
</div>

</body>
</html>
