<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ward 20 – Voter Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-200">

<!-- LOGIN SECTION -->
<div id="loginDiv" class="flex items-center justify-center h-screen">
  <button id="googleLoginBtn"
    class="px-6 py-3 bg-blue-600 text-white rounded-lg text-xl shadow">
    Google Login
  </button>
</div>

<!-- PANEL SECTION -->
<div id="panelDiv" class="hidden p-5">

  <h1 class="text-2xl font-bold mb-4">Ward 20 – Voter Management</h1>

  <!-- Sender Section -->
  <div class="p-4 bg-white rounded shadow mb-5">
    <h2 class="font-bold mb-2 text-lg">Sender Info</h2>

    <label>Description:</label>
    <textarea id="senderDesc" class="w-full p-2 border rounded"></textarea>

    <button id="saveSenderBtn"
      class="mt-2 px-4 py-2 bg-green-600 text-white rounded">
      Save Sender
    </button>
  </div>

  <!-- Manual Add Form -->
  <div class="p-4 bg-white rounded shadow mb-5">
    <h2 class="font-bold text-lg mb-3">Add Voter Manually</h2>

    <input id="name" placeholder="Name" class="w-full p-2 border mb-2 rounded">
    <input id="epic" placeholder="EPIC Number" class="w-full p-2 border mb-2 rounded">
    <input id="state" placeholder="State" class="w-full p-2 border mb-2 rounded">
    <input id="district" placeholder="District" class="w-full p-2 border mb-2 rounded">
    <input id="acno" placeholder="AC No" class="w-full p-2 border mb-2 rounded">
    <input id="partno" placeholder="Part No" class="w-full p-2 border mb-2 rounded">
    <input id="booth" placeholder="Booth" class="w-full p-2 border mb-2 rounded">
    <input id="mobile" placeholder="Mobile" class="w-full p-2 border mb-2 rounded">
    <input id="age" placeholder="Age" class="w-full p-2 border mb-2 rounded">

    <button id="addVoterBtn"
      class="px-4 py-2 bg-blue-600 text-white rounded">
      Add Voter
    </button>
  </div>

  <!-- Search -->
  <input id="searchBox" placeholder="Search by Name, EPIC, Mobile"
    class="w-full p-2 border rounded mb-3">

  <!-- Voter List -->
  <div id="voterList" class="space-y-2"></div>

</div>


<script type="module">
/* ------------------ Firebase ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, child, update }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

/* ------------ Email Lists (SAFE JSON KEYS) ----------- */
const ADMINS = ["ngogrant454@gmail_com"];
const USERS = ["zarafix3@gmail_com"];

/* ---------------- Google Login ---------------- */
document.getElementById("googleLoginBtn").addEventListener("click", () => {
  signInWithPopup(auth, provider).catch(err => alert(err.message));
});

/* ----------- Auth State – FIXED LOGIN BUG ------------ */
onAuthStateChanged(auth, user => {
  if (user) {
    const key = user.email.replace(/\./g, "_");

    if (ADMINS.includes(key) || USERS.includes(key)) {
      loginDiv.classList.add("hidden");
      panelDiv.classList.remove("hidden");
      loadSender();
      loadVoters();
    } else {
      signOut(auth);
      alert("Access Denied!");
    }
  } else {
    loginDiv.classList.remove("hidden");
    panelDiv.classList.add("hidden");
  }
});

/* ---------------- Save Sender ---------------- */
document.getElementById("saveSenderBtn").onclick = () => {
  const desc = senderDesc.value.trim();
  update(ref(db, "sender"), { description: desc });
  alert("Saved!");
};

/* ---------------- Load Sender ---------------- */
function loadSender() {
  get(child(ref(db), "sender")).then(s => {
    if (s.exists()) senderDesc.value = s.val().description ?? "";
  });
}

/* ---------------- Add Voter ---------------- */
addVoterBtn.onclick = () => {
  const epic = epic.value.trim().replace(/\W/g, "");
  if (epic === "") return alert("EPIC required!");

  const data = {
    name: name.value.trim(),
    voterID: epic,
    state: state.value.trim(),
    district: district.value.trim(),
    acNo: acno.value.trim(),
    partNo: partno.value.trim(),
    booth: booth.value.trim(),
    mobile: mobile.value.trim(),
    age: age.value.trim(),
    status: "pending"
  };

  set(ref(db, "voters/" + epic), data);
  alert("Voter Added!");
  loadVoters();
};

/* ---------------- Load Voters ---------------- */
function loadVoters() {
  get(child(ref(db), "voters")).then(s => {
    const box = voterList;
    box.innerHTML = "";

    if (!s.exists()) return;

    const obj = s.val();
    for (const k in obj) card(obj[k]);
  });
}

/* ---------------- Voter UI Card ---------------- */
function card(v) {
  const box = document.createElement("div");
  box.className = "p-3 bg-white rounded shadow";

  box.innerHTML = `
    <div><b>${v.name}</b> (${v.voterID})</div>
    <div>Mobile: ${v.mobile}</div>
    <div>Booth: ${v.booth}</div>
    <div>Status: ${v.status}</div>
  `;

  voterList.appendChild(box);
}

/* ---------------- Search ---------------- */
searchBox.oninput = () => {
  const term = searchBox.value.toLowerCase();

  get(child(ref(db), "voters")).then(s => {
    voterList.innerHTML = "";
    if (!s.exists()) return;

    const obj = s.val();

    for (const k in obj) {
      const v = obj[k];
      const match =
        v.name.toLowerCase().includes(term) ||
        v.voterID.toLowerCase().includes(term) ||
        v.mobile.includes(term);

      if (match) card(v);
    }
  });
};
</script>

</body>
</html>
