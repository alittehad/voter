<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Search & Editor</title>
<style>
body { font-family: Arial; padding:10px; background:#f7f7f7; }
h2 { text-align:center; margin-bottom:15px; }

#searchBox { width:100%; padding:10px; font-size:16px; border-radius:6px; border:1px solid #999; margin-bottom:15px; }

.result-item {
  padding:8px; background:white; border-radius:6px; margin-bottom:5px; cursor:pointer;
  border-left:5px solid #007bff;
}

#popup {
  position:fixed; top:0; left:0; width:100%; height:100%; display:none;
  background:rgba(0,0,0,0.7); justify-content:center; align-items:flex-start;
  padding:20px; overflow-y:auto;
}

.card {
  width:95%; max-width:450px; background:white; padding:15px; border-radius:10px;
}

.color-btn { width:30px; height:30px; border:none; margin-right:6px; border-radius:6px; cursor:pointer; }

textarea { width:100%; height:80px; border-radius:6px; padding:6px; border:1px solid #aaa; }

.btn { padding:8px 12px; margin-top:8px; border:none; border-radius:6px; cursor:pointer; color:white; }
.btn-save { background:#28a745; }
.btn-del { background:#dc3545; }
.btn-print { background:#007bff; }
.btn-whatsapp { background:#25d366; }
.close-btn { background:red; }

.voter-color-tag { width:20px; height:20px; display:inline-block; border-radius:4px; }
</style>
</head>
<body>

<h2>ðŸ—³ Voter Search</h2>
<input type="text" id="searchBox" placeholder="Type 1 letter to search...">
<div id="results"></div>

<div id="popup">
  <div class="card">
    <h3 id="vName"></h3>
    <p><b>EPIC:</b> <span id="vEpic"></span></p>
    <p><b>Sl No in Part:</b> <span id="vSlNo"></span></p>
    <p><b>Relation:</b> <span id="vRelation"></span></p>
    <p><b>House Number:</b> <span id="vHouse"></span></p>
    <p><b>Age/Gender:</b> <span id="vAge"></span> / <span id="vGender"></span></p>
    <p><b>Saved Color:</b> <span class="voter-color-tag" id="vColorTag"></span></p>

    <hr>
    <p><b>Change Color:</b></p>
    <button class="color-btn" style="background:#ff4444" onclick="saveColor('#ff4444')"></button>
    <button class="color-btn" style="background:#44cc44" onclick="saveColor('#44cc44')"></button>
    <button class="color-btn" style="background:#4477ff" onclick="saveColor('#4477ff')"></button>

    <hr>
    <p><b>Sender Message:</b></p>
    <textarea id="vMsg"></textarea><br>
    <button class="btn btn-save" onclick="saveMessage()">Save</button>
    <button class="btn btn-del" onclick="deleteMessage()">Delete</button>
    <hr>
    <button class="btn btn-print" onclick="printCard()">Print</button>
    <button class="btn btn-whatsapp" onclick="sendWhatsApp()">Send</button>
    <button class="btn close-btn" onclick="closePopup()">Close</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let voters = [];
let activeVoter = null;

// Load voters
db.ref("voters").once("value").then(snap=>{
    let data = snap.val() || {};
    voters = Object.values(data);
});

// Search
document.getElementById("searchBox").addEventListener("input", e=>{
    let q = e.target.value.toLowerCase();
    let html = "";
    if(q.length>=1){
        voters.forEach(v=>{
            if(v.voter_full_name.toLowerCase().includes(q) || v.epic_no.toLowerCase().includes(q)){
                html += `<div class="result-item" onclick="openCard('${v.epic_no}')">
                            <b>${v.voter_full_name}</b> (${v.epic_no})
                         </div>`;
            }
        });
    }
    document.getElementById("results").innerHTML = html;
});

// Open card
function openCard(epic){
    let v = voters.find(x=>x.epic_no===epic);
    if(!v) return;

    activeVoter = v;

    document.getElementById("vName").innerText = v.voter_full_name;
    document.getElementById("vEpic").innerText = v.epic_no;
    document.getElementById("vSlNo").innerText = v.sl_no_in_part;
    document.getElementById("vRelation").innerText = `${v.relation_name} (${v.relation_type})`;
    document.getElementById("vHouse").innerText = v.house_number;
    document.getElementById("vAge").innerText = v.age;
    document.getElementById("vGender").innerText = v.gender;

    // Load color
    db.ref("voters/"+v.epic_no+"/color").once("value").then(snap=>{
        document.getElementById("vColorTag").style.background = snap.val() || "#ffffff";
    });

    // Load message
    db.ref("voters/"+v.epic_no+"/message").once("value").then(snap=>{
        document.getElementById("vMsg").value = snap.val() || "";
    });

    document.getElementById("popup").style.display="flex";
}

// Close card
function closePopup(){ document.getElementById("popup").style.display="none"; }

// Save color
function saveColor(color){
    if(!activeVoter) return;
    db.ref("voters/"+activeVoter.epic_no+"/color").set(color);
    document.getElementById("vColorTag").style.background = color;
}

// Save message
function saveMessage(){
    if(!activeVoter) return;
    let msg = document.getElementById("vMsg").value;
    db.ref("voters/"+activeVoter.epic_no+"/message").set(msg);
    alert("Message Saved!");
}

// Delete message
function deleteMessage(){
    if(!activeVoter) return;
    db.ref("voters/"+activeVoter.epic_no+"/message").remove();
    document.getElementById("vMsg").value="";
}

// Print
function printCard(){
    if(!activeVoter) return;
    let text = `
Name: ${activeVoter.voter_full_name}
EPIC: ${activeVoter.epic_no}
Sl No: ${activeVoter.sl_no_in_part}
Relation: ${activeVoter.relation_name} (${activeVoter.relation_type})
House Number: ${activeVoter.house_number}
Age/Gender: ${activeVoter.age} / ${activeVoter.gender}

Message:
${document.getElementById("vMsg").value}
`;
    let w = window.open("","", "width=400,height=600");
    w.document.write("<pre>"+text+"</pre>");
    w.print();
}

// WhatsApp
function sendWhatsApp(){
    if(!activeVoter) return;
    let text = `*Voter Details*\nName: ${activeVoter.voter_full_name}\nEPIC: ${activeVoter.epic_no}\nSl No: ${activeVoter.sl_no_in_part}\nRelation: ${activeVoter.relation_name} (${activeVoter.relation_type})\nHouse Number: ${activeVoter.house_number}\nAge/Gender: ${activeVoter.age}/${activeVoter.gender}\n\n*Message:*\n${document.getElementById("vMsg").value}`;
    window.open("https://wa.me/?text="+encodeURIComponent(text), "_blank");
}
</script>

</body>
</html>
