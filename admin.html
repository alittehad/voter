<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Voter Management</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .card-Available{background:#34d399;}
  .card-Active{background:#facc15;}
  .card-Verified{background:#f87171;}
  .small-btn{padding:0.25rem 0.5rem; font-size:0.75rem;}
</style>
</head>
<body class="bg-gray-100 p-4">
<h1 class="text-2xl font-bold text-center mb-4">Voter Management Panel</h1>

<!-- Sender description -->
<div class="mb-4 flex gap-2 items-center">
  <input id="senderDesc" placeholder="Sender Description" class="border p-2 rounded w-full"/>
</div>

<!-- Admin Emails -->
<div class="mb-4 p-4 bg-white rounded shadow">
  <h2 class="font-bold mb-2">Admin Emails</h2>
  <input id="newAdminEmail" placeholder="Add admin email" class="border p-2 rounded w-1/2"/>
  <button id="addAdminBtn" class="bg-blue-600 text-white small-btn rounded">Add</button>
  <ul id="adminList" class="mt-2"></ul>
</div>

<!-- Add Voter -->
<div class="mb-4 p-4 bg-white rounded shadow">
  <h2 class="font-bold mb-2">Add Voter</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
    <input id="voterName" placeholder="Name" class="border p-2 rounded"/>
    <input id="voterEPIC" placeholder="EPIC" class="border p-2 rounded"/>
    <select id="relationType" class="border p-2 rounded">
      <option value="">Relation Type</option>
      <option value="Father">Father</option>
      <option value="Husband">Husband</option>
    </select>
    <input id="relationName" placeholder="Father/Husband Name" class="border p-2 rounded"/>
    <input id="voterAddress" placeholder="Address" class="border p-2 rounded md:col-span-4"/>
    <!-- Add other election voter list fields here -->
  </div>
  <button id="addVoterManual" class="bg-green-600 text-white small-btn mt-2 rounded">Add Voter</button>
</div>

<!-- Status Counts -->
<div class="mb-2 flex gap-4">
  <span id="countAvailable">Available: 0</span>
  <span id="countActive">Active: 0</span>
  <span id="countVerified">Verified: 0</span>
</div>

<!-- Voter Table -->
<div id="voterList" class="bg-white rounded shadow overflow-auto max-h-[400px]"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let voterData = [];
const statusCounts = {Available:0, Active:0, Verified:0};

// Add voter
document.getElementById("addVoterManual").onclick = () => {
  const name = document.getElementById("voterName").value.trim();
  const epic = document.getElementById("voterEPIC").value.trim();
  const relationType = document.getElementById("relationType").value;
  const relationName = document.getElementById("relationName").value.trim();
  const address = document.getElementById("voterAddress").value.trim();
  if(!name || !epic) return alert("Name & EPIC required!");

  const payload = {
    name, epic, relationType, relationName, address,
    status: "Available"
  };
  push(ref(db,"voters"), payload);
  document.getElementById("voterName").value='';
  document.getElementById("voterEPIC").value='';
  document.getElementById("relationType").value='';
  document.getElementById("relationName").value='';
  document.getElementById("voterAddress").value='';
};

// Load voters
function loadVoters(){
  onValue(ref(db,"voters"), snapshot=>{
    voterData = [];
    snapshot.forEach(child => voterData.push({id:child.key, ...child.val()}));
    renderTable();
    updateCounts();
  });
}

function updateCounts(){
  statusCounts.Available=0; statusCounts.Active=0; statusCounts.Verified=0;
  voterData.forEach(v=> statusCounts[v.status] = (statusCounts[v.status]||0)+1);
  document.getElementById("countAvailable").textContent = "Available: "+statusCounts.Available;
  document.getElementById("countActive").textContent = "Active: "+statusCounts.Active;
  document.getElementById("countVerified").textContent = "Verified: "+statusCounts.Verified;
}

function renderTable(){
  const container = document.getElementById("voterList");
  container.innerHTML = "";
  voterData.forEach(v=>{
    const div = document.createElement("div");
    div.className = `p-2 mb-1 rounded ${v.status==='Available'?'bg-green-300':v.status==='Active'?'bg-yellow-300':'bg-red-300'}`;
    div.innerHTML = `<div class="flex justify-between">
      <span>${v.name} | ${v.epic} | ${v.status}</span>
      <button class="bg-gray-600 text-white small-btn rounded" onclick="showCard('${v.id}')">View</button>
    </div>`;
    container.appendChild(div);
  });
}

window.showCard = (id)=>{
  const v = voterData.find(x=>x.id===id);
  if(!v) return;
  const card = document.createElement("div");
  card.className = `fixed top-10 left-1/2 -translate-x-1/2 p-4 rounded shadow max-w-md z-50 card-${v.status}`;
  card.innerHTML = `
    <h2 class="font-bold text-lg mb-1">${v.name}</h2>
    <p>EPIC: ${v.epic}</p>
    <p>${v.relationType}: ${v.relationName}</p>
    <p>Address: ${v.address}</p>
    <p>Status: ${v.status}</p>
    <div class="flex gap-1 mt-2 flex-wrap">
      <button onclick="updateStatus('${v.id}','Available')" class="bg-green-600 text-white small-btn rounded">Available</button>
      <button onclick="updateStatus('${v.id}','Active')" class="bg-yellow-500 text-white small-btn rounded">Active</button>
      <button onclick="updateStatus('${v.id}','Verified')" class="bg-red-600 text-white small-btn rounded">Verified</button>
      <button onclick="this.parentElement.parentElement.remove()" class="bg-gray-600 text-white small-btn rounded">Close</button>
      <button onclick="sendWhatsApp('${v.id}')" class="bg-blue-600 text-white small-btn rounded">Send</button>
      <button onclick="printVoter('${v.id}')" class="bg-green-600 text-white small-btn rounded">Print</button>
    </div>
  `;
  document.body.appendChild(card);
};

window.updateStatus = (id,status)=>{
  const v = voterData.find(x=>x.id===id);
  set(ref(db,"voters/"+id), {...v,status});
};

window.sendWhatsApp = (id)=>{
  const v = voterData.find(x=>x.id===id);
  const desc = document.getElementById("senderDesc").value.trim();
  let msg = desc?desc+"\n\n":"";
  msg+=`Name: ${v.name}\n${v.relationType}: ${v.relationName}\nEPIC: ${v.epic}\nAddress: ${v.address}\nStatus: ${v.status}`;
  const hiddenImage = "https://i.ibb.co/LhDpnZFn/khatik-imase.jpg";
  msg+=`\nImage: ${hiddenImage}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
};

window.printVoter = (id)=>{
  const v = voterData.find(x=>x.id===id);
  let html = `<h2>${v.name}</h2><p>EPIC: ${v.epic}</p><p>${v.relationType}: ${v.relationName}</p><p>Address: ${v.address}</p><p>Status: ${v.status}</p>`;
  const w = window.open();
  w.document.write(html);
  w.print();
  w.close();
};

loadVoters();
</script>
</body>
</html>
