<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voter Management Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#eef2ff;--card:#fff}
body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.container{max-width:1100px;margin:12px auto;padding:12px;}
.heading {font-size:clamp(1.4rem,3vw,1.8rem);font-weight:800;text-align:center;margin-bottom:12px;color:#0f172a;transform: perspective(500px) rotateX(8deg);text-shadow:0 1px 0 rgba(255,255,255,0.5),0 6px 12px rgba(2,6,23,0.12),0 18px 36px rgba(2,6,23,0.10);letter-spacing:0.6px;}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:6px 6px 18px rgba(2,6,23,0.06);}
.img-sender{width:40px;height:40px;border-radius:999px;object-fit:cover;margin-right:8px}
.btn{cursor:pointer;padding:6px 12px;border-radius:8px;font-weight:700;font-size:12px;transition: all 0.2s; box-shadow:3px 3px 6px rgba(0,0,0,0.2);}
.btn:hover{transform: translateY(-2px); box-shadow:4px 4px 10px rgba(0,0,0,0.25);}
.btn-blue{background:#2563eb;color:white}
.btn-green{background:#16a34a;color:white}
.btn-yellow{background:#facc15;color:#111}
.btn-red{background:#dc2626;color:white}
.btn-gray{background:#6b7280;color:white}
.btn-sm{padding:2px 6px;font-size:10px;}
.table-container{overflow:auto;width:100%}
table{width:100%;border-collapse:collapse;min-width:300px;background:white;border-radius:6px;overflow:hidden}
th,td{padding:6px;border:1px solid #e6e9ef;text-align:left;white-space:nowrap;font-size:12px}
thead tr{background:#ebf8ff;font-weight:700}
tr:hover{background:#f7f9ff}
.card-approved{background:#dcfce7} 
.card-opponent{background:#fef9c3} 
.card-anti{background:#fee2e2} 
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:700;font-size:11px}
.actions button{margin-right:4px}
.opacity-50{opacity:0.5;}
.cursor-not-allowed{cursor:not-allowed;}
@media (max-width:900px){ table{min-width:100%} }
</style>
</head>
<body>
<div class="container">
<h1 class="heading">Voter Management Panel</h1>

<!-- Login -->
<div id="loginDiv" class="card text-center">
  <h2 class="text-lg font-bold text-blue-700">Login to Access Panel</h2>
  <button id="googleLoginBtn" class="btn btn-blue mt-4">Login with Google</button>
</div>

<!-- Panel -->
<div id="panelDiv" class="hidden">

  <!-- Admin add users + logout -->
  <div id="adminControls" class="card flex justify-between items-center hidden">
    <div>
      <h3 class="font-bold text-blue-700 mb-2 text-sm">Admin: Add User</h3>
      <div class="flex gap-2">
        <input id="newUserEmail" placeholder="Enter user email" class="border p-2 rounded flex-1 text-sm"/>
        <button id="addUserBtn" class="btn btn-green">Add User</button>
      </div>
    </div>
    <button id="logoutBtn" class="btn btn-red">Logout</button>
  </div>

  <!-- User List -->
  <div id="userListDiv" class="card mt-2 hidden">
    <h3 class="font-bold text-blue-700 mb-2 text-sm">Existing Users</h3>
    <div id="userList" class="flex flex-wrap gap-2 text-sm"></div>
  </div>

  <!-- Top controls -->
  <div class="card flex gap-4 flex-wrap items-center">
    <div style="flex:1">
      <input id="searchVoter" placeholder="Search by Name, EPIC, Part No, House No..." class="w-full border p-2 rounded text-sm"/>
    </div>
    <div style="flex:1">
      <textarea id="senderDesc" placeholder="Sender Description (appears above voter info)" class="w-full border p-2 rounded text-sm" rows="2"></textarea>
    </div>
  </div>

  <!-- Status count -->
  <div id="statusCount" class="flex gap-4 mb-2 text-sm"></div>

  <!-- Table -->
  <div id="voterList" class="table-container card"></div>

  <!-- Add Voter (admin only) -->
  <div id="addVoterDiv" class="card mt-4 hidden">
    <h3 class="text-sm font-bold text-blue-700 mb-2">Add Voter Manually</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
      <input id="voterName" placeholder="Name" class="border p-2 rounded"/>
      <input id="voterEPIC" placeholder="EPIC" class="border p-2 rounded"/>
      <select id="relationType" class="border p-2 rounded">
        <option value="">Relation Type</option><option value="Father">Father</option><option value="Husband">Husband</option>
      </select>
      <input id="relationName" placeholder="Father/Husband Name" class="border p-2 rounded"/>
      <input id="houseNo" placeholder="House No / Building" class="border p-2 rounded"/>
      <input id="roomNo" placeholder="Room No" class="border p-2 rounded"/>
      <input id="voterAddress" placeholder="Address" class="border p-2 rounded"/>
      <input id="voterPart" placeholder="Part No" class="border p-2 rounded"/>
      <input id="voterBooth" placeholder="Booth No / Location" class="border p-2 rounded"/>
    </div>
    <div class="mt-3">
      <button id="addVoterManual" class="btn btn-green w-full">Add Voter</button>
    </div>
  </div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref as dbRef, onValue, set, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.firebasestorage.app",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase(app);

const loginDiv = document.getElementById("loginDiv");
const panelDiv = document.getElementById("panelDiv");
const loginBtn = document.getElementById("googleLoginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const voterListDiv = document.getElementById("voterList");
const searchInput = document.getElementById("searchVoter");
const senderDescEl = document.getElementById("senderDesc");
const statusCountDiv = document.getElementById("statusCount");

const adminControls = document.getElementById("adminControls");
const userListDivContainer = document.getElementById("userListDiv");
const addVoterDiv = document.getElementById("addVoterDiv");

let voterData = [];
let isAdmin = false;

function emailToKey(email){ return email.replace(/\./g,"_dot_"); }

// Login / Logout
loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err=>alert("Login failed: "+err.message));
logoutBtn.onclick = () => signOut(auth);

// On auth state change
onAuthStateChanged(auth, async user=>{
  if(user){
    const emailKey = emailToKey(user.email.toLowerCase());
    const adminSnap = await get(dbRef(db,"admins/"+emailKey));
    const userSnap = await get(dbRef(db,"users/"+emailKey));

    if(!adminSnap.exists() && !userSnap.exists()){
      alert("Access Denied"); signOut(auth); return;
    }

    isAdmin = adminSnap.exists();

    loginDiv.classList.add("hidden");
    panelDiv.classList.remove("hidden");

    if(isAdmin){
      adminControls.classList.remove("hidden");
      userListDivContainer.classList.remove("hidden");
      addVoterDiv.classList.remove("hidden");
    } else {
      adminControls.classList.add("hidden");
      userListDivContainer.classList.add("hidden");
      addVoterDiv.classList.add("hidden");
    }

    loadVoters();
    if(isAdmin) renderUsers();
  } else {
    loginDiv.classList.remove("hidden");
    panelDiv.classList.add("hidden");
  }
});

// Load voters
function loadVoters(){
  onValue(dbRef(db,"voters"),snap=>{
    voterData = [];
    snap.forEach(c=>voterData.push({id:c.key,...c.val()}));
    renderTable(voterData);
    renderStatusCount();
  });
}

function renderStatusCount(){
  let approved=0, opponent=0, anti=0;
  voterData.forEach(v=>{ if(v.status==="approved") approved++; else if(v.status==="opponent") opponent++; else anti++; });
  statusCountDiv.innerHTML = `<div class="badge" style="background:#dcfce7">Approved: ${approved}</div>
  <div class="badge" style="background:#fef9c3">Opponent: ${opponent}</div>
  <div class="badge" style="background:#fee2e2">Anti: ${anti}</div>`;
}

function renderTable(list){
  voterListDiv.innerHTML=`<table><thead><tr><th>Name</th><th>EPIC</th><th>Status</th></tr></thead><tbody></tbody></table>`;
  const tbody = voterListDiv.querySelector("tbody");
  list.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${v.name||''}</td><td>${v.voterID||v.epic||''}</td><td>${v.status||''}</td>`;
    tr.className=v.status==="approved"?"card-approved":v.status==="opponent"?"card-opponent":"card-anti";
    tbody.appendChild(tr);
    tr.onclick=()=>showVoterCard(v);
  });
}

// ====== UPDATED showVoterCard FUNCTION ======
function showVoterCard(v){
  let existing = document.getElementById("voterDetailCard");
  if(existing) existing.remove();

  const div = document.createElement("div");
  div.id = "voterDetailCard";
  div.className = "card";

  const relLine = v.fatherName || v.husbandName || v.relationName || 'N/A';

  div.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="https://i.ibb.co/LhDpnZFn/khatik-imase.jpg" class="img-sender"/>
      <div>
        <h3 style="margin:0;font-weight:800">${v.name||'-'}</h3>
        <div style="color:#475569;font-size:13px">${senderDescEl.value||''}</div>
      </div>
    </div>
    <button id="closeDetailBtn" class="btn btn-red">Close</button>
  </div>
  <div style="margin-top:8px;font-size:12px">
    <p><strong>Relation:</strong> ${relLine} | EPIC: ${v.voterID||'-'}</p>
    <p><strong>House:</strong> ${v.houseNo||'-'}${v.roomNo? ' | Room: '+v.roomNo:''}</p>
    <p><strong>Booth:</strong> ${v.booth||'-'}</p>
    <p><strong>Part:</strong> ${v.partNo||'-'}</p>
    <p><strong>Address:</strong> ${v.address||'-'}</p>
  </div>
  <div style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap">
    <button class="btn btn-yellow approveBtn">Approve</button>
    <button class="btn btn-yellow opponentBtn">Opponent</button>
    <button class="btn btn-red antiBtn">Anti</button>
    <button class="btn btn-blue sendBtn">Send WhatsApp</button>
    <button class="btn btn-green printBtn">Print</button>
  </div>
  `;

  voterListDiv.prepend(div);

  // Close button
  div.querySelector("#closeDetailBtn").onclick = () => div.remove();

  // Status buttons - ALL users can now update
  function updateStatus(newStatus){ 
    set(dbRef(db,"voters/"+v.id),{...v,status:newStatus}); 
  }
  div.querySelector(".approveBtn").onclick = () => updateStatus("approved");
  div.querySelector(".opponentBtn").onclick = () => updateStatus("opponent");
  div.querySelector(".antiBtn").onclick = () => updateStatus("anti");

  // WhatsApp button
  div.querySelector(".sendBtn").onclick = () => {
    const msg = `${senderDescEl.value?senderDescEl.value+"\n\n":""}Name: ${v.name||'-'}\nRelation: ${relLine}\nEPIC: ${v.voterID||'-'}\nHouse: ${v.houseNo||'-'}${v.roomNo? ' | Room: '+v.roomNo:''}\nAddress: ${v.address||'-'}\nPart: ${v.partNo||'-'}\nBooth: ${v.booth||'-'}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
  };

  // Print button
  div.querySelector(".printBtn").onclick = () => {
    const info = `Name: ${v.name||'-'}\nRelation: ${relLine}\nEPIC: ${v.voterID||'-'}\nHouse: ${v.houseNo||'-'}${v.roomNo? ' | Room: '+v.roomNo:''}\nAddress: ${v.address||'-'}\nPart: ${v.partNo||'-'}\nBooth: ${v.booth||'-'}`;
    const w = window.open(); 
    w.document.write(`<pre style="font-family:Arial">${info}</pre>`); 
    w.print(); 
    w.close();
  };
}

// Search
searchInput.addEventListener("input",e=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) renderTable(voterData);
  else renderTable(voterData.filter(v=>{
    return `${v.name||''} ${v.voterID||v.epic||''} ${v.partNo||v.part||''} ${v.houseNo||''}`.toLowerCase().includes(q);
  }));
});

// Admin: Add Voter
document.getElementById("addVoterManual").onclick=async ()=>{
  if(!isAdmin) return alert("Access Denied");
  const name=document.getElementById("voterName").value.trim();
  const epic=document.getElementById("voterEPIC").value.trim();
  if(!name||!epic) return alert("Name & EPIC required!");
  const snap = await get(dbRef(db,"voters"));
  let exists = false; snap.forEach(c=>{ if(c.val().voterID===epic) exists=true; });
  if(exists) return alert("Voter with this EPIC already exists!");
  const payload={
    name, voterID:epic, epic,
    relationType:document.getElementById("relationType").value,
    relationName:document.getElementById("relationName").value.trim(),
    fatherName:'', husbandName:'',
    houseNo:document.getElementById("houseNo").value.trim(),
    roomNo:document.getElementById("roomNo").value.trim(),
    address:document.getElementById("voterAddress").value.trim(),
    partNo:document.getElementById("voterPart").value.trim(),
    booth:document.getElementById("voterBooth").value.trim(),
    status:"anti", createdAt:Date.now()
  };
  if(payload.relationType==="Father") payload.fatherName=payload.relationName;
  else if(payload.relationType==="Husband") payload.husbandName=payload.relationName;
  else if(payload.relationName) payload.relationName=payload.relationName;
  push(dbRef(db,"voters"),payload);
  alert("Voter added!");
  document.getElementById("voterName").value='';
  document.getElementById("voterEPIC").value='';
};

// Admin: Add Users
document.getElementById("addUserBtn").onclick=async ()=>{
  if(!isAdmin) return;
  const email = document.getElementById("newUserEmail").value.trim().toLowerCase();
  if(!email) return alert("Enter email");
  await set(dbRef(db,"users/"+emailToKey(email)),{email});
  alert("User added!");
  document.getElementById("newUserEmail").value='';
  renderUsers();
}

async function renderUsers(){
  const snap = await get(dbRef(db,"users"));
  const listDiv = document.getElementById("userList");
  listDiv.innerHTML='';
  snap.forEach(c=>{
    const u=c.val();
    const d=document.createElement("div");
    d.className="badge bg-gray-200";
    d.textContent=u.email;
    listDiv.appendChild(d);
  });
}
</script>
</body>
</html>
